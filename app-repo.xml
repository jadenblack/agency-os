This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
components.json
eslint.config.mjs
next.config.ts
package.json
postcss.config.mjs
public/file.svg
public/globe.svg
public/next.svg
public/vercel.svg
public/window.svg
README.md
scripts/generate-directus-types.js
src/app/(auth)/layout.tsx
src/app/(auth)/login/page.tsx
src/app/(client-portal)/layout.tsx
src/app/(client-portal)/portal/page.tsx
src/app/(dashboard)/dashboard/crm/accounts/[id]/edit/page.tsx
src/app/(dashboard)/dashboard/crm/accounts/[id]/page.tsx
src/app/(dashboard)/dashboard/crm/accounts/new/page.tsx
src/app/(dashboard)/dashboard/crm/accounts/page.tsx
src/app/(dashboard)/dashboard/crm/activities/[id]/edit/page.tsx
src/app/(dashboard)/dashboard/crm/activities/new/page.tsx
src/app/(dashboard)/dashboard/crm/activities/page.tsx
src/app/(dashboard)/dashboard/crm/contacts/[id]/edit/page.tsx
src/app/(dashboard)/dashboard/crm/contacts/[id]/page.tsx
src/app/(dashboard)/dashboard/crm/contacts/new/page.tsx
src/app/(dashboard)/dashboard/crm/contacts/page.tsx
src/app/(dashboard)/dashboard/crm/deals/[id]/edit/page.tsx
src/app/(dashboard)/dashboard/crm/deals/[id]/page.tsx
src/app/(dashboard)/dashboard/crm/deals/new/page.tsx
src/app/(dashboard)/dashboard/crm/deals/page.tsx
src/app/(dashboard)/dashboard/crm/deals/pipeline/page.tsx
src/app/(dashboard)/dashboard/crm/page.tsx
src/app/(dashboard)/dashboard/page.tsx
src/app/(dashboard)/layout.tsx
src/app/api/auth/[...nextauth]/route.ts
src/app/api/auth/route.ts
src/app/api/crm/account-members/[id]/route.ts
src/app/api/crm/account-members/route.ts
src/app/api/crm/accounts/[id]/route.ts
src/app/api/crm/accounts/route.ts
src/app/api/crm/activities/[id]/complete/route.ts
src/app/api/crm/activities/[id]/route.ts
src/app/api/crm/activities/route.ts
src/app/api/crm/contacts/[id]/route.ts
src/app/api/crm/contacts/route.ts
src/app/api/crm/deal-items/[id]/route.ts
src/app/api/crm/deal-items/route.ts
src/app/api/crm/deals/[id]/route.ts
src/app/api/crm/deals/[id]/stage/route.ts
src/app/api/crm/deals/route.ts
src/app/api/test-directus/route.ts
src/app/favicon.ico
src/app/globals.css
src/app/layout.tsx
src/app/page.tsx
src/components/crm/account-form.tsx
src/components/crm/account-header.tsx
src/components/crm/account-members.tsx
src/components/crm/account-tabs.tsx
src/components/crm/accounts-table.tsx
src/components/crm/activities-list-client.tsx
src/components/crm/activities-table.tsx
src/components/crm/activity-edit-form.tsx
src/components/crm/activity-form.tsx
src/components/crm/add-activity-dialog.tsx
src/components/crm/add-deal-item-dialog.tsx
src/components/crm/add-external-member-dialog.tsx
src/components/crm/add-internal-member-dialog.tsx
src/components/crm/contact-form.tsx
src/components/crm/contacts-list-client.tsx
src/components/crm/contacts-table.tsx
src/components/crm/deal-activities-manager.tsx
src/components/crm/deal-card.tsx
src/components/crm/deal-form.tsx
src/components/crm/deal-header.tsx
src/components/crm/deal-items-manager.tsx
src/components/crm/deal-tabs.tsx
src/components/crm/deals-cards.tsx
src/components/crm/deals-list-client.tsx
src/components/crm/deals-pipeline.tsx
src/components/crm/deals-table.tsx
src/components/crm/droppable-column.tsx
src/components/dashboard/dashboard-header.tsx
src/components/dashboard/dashboard-nav.tsx
src/components/providers/session-provider.tsx
src/components/ui/alert-dialog.tsx
src/components/ui/avatar.tsx
src/components/ui/badge.tsx
src/components/ui/button.tsx
src/components/ui/card.tsx
src/components/ui/checkbox.tsx
src/components/ui/dialog.tsx
src/components/ui/dropdown-menu.tsx
src/components/ui/form.tsx
src/components/ui/input.tsx
src/components/ui/label.tsx
src/components/ui/select.tsx
src/components/ui/sonner.tsx
src/components/ui/table.tsx
src/components/ui/tabs.tsx
src/components/ui/textarea.tsx
src/lib/auth.ts
src/lib/directus.ts
src/lib/utils.ts
src/lib/validations/account.ts
src/lib/validations/activity.ts
src/lib/validations/contact.ts
src/lib/validations/deal.ts
src/types/crm.ts
src/types/directus.ts
src/types/next-auth.d.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="scripts/generate-directus-types.js">
// scripts/generate-directus-types.js
require('dotenv').config({ path: '.env.local' });

const https = require('https');
const fs = require('fs');
const path = require('path');

const DIRECTUS_URL = process.env.NEXT_PUBLIC_DIRECTUS_URL;
const DIRECTUS_TOKEN = process.env.DIRECTUS_ADMIN_TOKEN;

if (!DIRECTUS_TOKEN) {
  console.error('Error: Debes configurar DIRECTUS_ADMIN_TOKEN en tu .env.local');
  process.exit(1);
}

console.log('Generando tipos de Directus desde:', DIRECTUS_URL);

const url = `${DIRECTUS_URL}/schema/snapshot?access_token=${DIRECTUS_TOKEN}`;

https.get(url, (res) => {
  let data = '';

  res.on('data', (chunk) => {
    data += chunk;
  });

  res.on('end', () => {
    try {
      const response = JSON.parse(data);
      const schema = response.data || response;
      
      if (!schema.collections) {
        console.error('Error: No se encontraron colecciones en el schema');
        process.exit(1);
      }

      // Mapear relaciones
      const relations = {};
      if (schema.relations) {
        schema.relations.forEach(rel => {
          if (!relations[rel.collection]) {
            relations[rel.collection] = {};
          }
          relations[rel.collection][rel.field] = {
            relatedCollection: rel.related_collection,
            meta: rel.meta
          };
        });
      }
      
      // Generar tipos TypeScript
      let types = `// Auto-generated Directus Schema Types
// Generated on: ${new Date().toISOString()}

export interface DirectusSchema {
`;

      // Generar referencias a colecciones
      schema.collections.forEach((collection) => {
        const collectionName = collection.collection;
        types += `  ${collectionName}: ${collectionName}Item[];\n`;
      });

      types += `}\n\n`;

      // Generar interfaces individuales
      schema.collections.forEach((collection) => {
        const collectionName = collection.collection;
        
        types += `export interface ${collectionName}Item {\n`;
        
        const fields = schema.fields.filter(f => f.collection === collectionName);
        
        fields.forEach((field) => {
          const fieldName = field.field;
          let fieldType = 'any';
          
          // Verificar si es una relaci√≥n
          const relation = relations[collectionName]?.[fieldName];
          
          if (relation && relation.relatedCollection) {
            // Es una relaci√≥n - usar el tipo de la colecci√≥n relacionada
            const relatedType = `${relation.relatedCollection}Item`;
            
            // Determinar si es un array o un objeto √∫nico
            if (field.type === 'alias' || field.meta?.special?.includes('m2m') || field.meta?.special?.includes('o2m')) {
              fieldType = `${relatedType}[] | string[]`;
            } else {
              fieldType = `${relatedType} | string`;
            }
          } else {
            // Campo normal - mapear tipo
            switch (field.type) {
              case 'string':
              case 'text':
                fieldType = 'string';
                break;
              case 'integer':
              case 'bigInteger':
              case 'float':
              case 'decimal':
                fieldType = 'number';
                break;
              case 'boolean':
                fieldType = 'boolean';
                break;
              case 'timestamp':
              case 'datetime':
              case 'date':
              case 'time':
                fieldType = 'string';
                break;
              case 'uuid':
                fieldType = 'string';
                break;
              case 'json':
                fieldType = 'any';
                break;
              default:
                fieldType = 'any';
            }
          }
          
          const nullable = field.schema?.is_nullable ? ' | null' : '';
          types += `  ${fieldName}${field.schema?.is_nullable ? '?' : ''}: ${fieldType}${nullable};\n`;
        });
        
        types += `}\n\n`;
      });

      // Agregar tipos de Directus system
      types += `// Directus System Types
export interface directus_usersItem {
  id: string;
  first_name?: string | null;
  last_name?: string | null;
  email?: string | null;
  password?: string | null;
  location?: string | null;
  title?: string | null;
  description?: string | null;
  tags?: any | null;
  avatar?: string | null;
  language?: string | null;
  theme?: string | null;
  tfa_secret?: string | null;
  status?: string | null;
  role?: string | null;
  token?: string | null;
  last_access?: string | null;
  last_page?: string | null;
}

export interface directus_filesItem {
  id: string;
  storage: string;
  filename_disk?: string | null;
  filename_download: string;
  title?: string | null;
  type?: string | null;
  folder?: string | null;
  uploaded_by?: string | null;
  uploaded_on: string;
  modified_by?: string | null;
  modified_on: string;
  charset?: string | null;
  filesize?: number | null;
  width?: number | null;
  height?: number | null;
  duration?: number | null;
  embed?: string | null;
  description?: string | null;
  location?: string | null;
  tags?: any | null;
  metadata?: any | null;
}
`;

      const typesDir = path.join(process.cwd(), 'src', 'types');
      if (!fs.existsSync(typesDir)) {
        fs.mkdirSync(typesDir, { recursive: true });
      }

      fs.writeFileSync(path.join(typesDir, 'directus.ts'), types);
      
      console.log('‚úÖ Tipos generados correctamente en src/types/directus.ts');
      console.log(`   ${schema.collections.length} colecciones procesadas`);
      console.log(`   ${Object.keys(relations).length} relaciones detectadas`);
      
    } catch (error) {
      console.error('Error al procesar el schema:', error);
      console.error(error.stack);
      process.exit(1);
    }
  });

}).on('error', (error) => {
  console.error('Error al conectar con Directus:', error.message);
  process.exit(1);
});
</file>

<file path="src/app/(dashboard)/dashboard/crm/activities/[id]/edit/page.tsx">
// src/app/(dashboard)/dashboard/crm/activities/[id]/edit/page.tsx
import { directusServer } from '@/lib/directus';
import { readItem, readItems, readUsers } from '@directus/sdk';
import { auth } from '@/lib/auth';
import { notFound, redirect } from 'next/navigation';
import ActivityEditForm from '@/components/crm/activity-edit-form';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

interface EditActivityPageProps {
  params: Promise<{
    id: string;
  }>;
}

export default async function EditActivityPage({ params }: EditActivityPageProps) {
  const { id } = await params;
  const session = await auth();

  if (!session?.user?.id) {
    redirect('/login');
  }

  try {
    // Obtener la actividad
    const activity = await directusServer.request(
      readItem('activities', id, {
        fields: ['*'],
      })
    );

    // Obtener usuarios activos
    const users = await directusServer.request(
      readUsers({
        fields: ['id', 'first_name', 'last_name'],
        filter: {
          status: {
            _eq: 'active',
          },
        },
        sort: ['first_name', 'last_name'],
      })
    );

    // Obtener deals
    const deals = await directusServer.request(
      readItems('deals', {
        fields: ['id', 'title'],
        sort: ['title'],
        limit: -1,
      })
    );

    // Obtener contactos
    const contacts = await directusServer.request(
      readItems('contacts', {
        fields: ['id', 'first_name', 'last_name'],
        sort: ['first_name', 'last_name'],
        limit: -1,
      })
    );

    return (
      <div className="space-y-6">
        <Button variant="ghost" size="sm" asChild>
          <Link href="/dashboard/crm/activities">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a Actividades
          </Link>
        </Button>

        <ActivityEditForm
          activity={activity as any}
          users={users as any}
          deals={deals as any}
          contacts={contacts as any}
        />
      </div>
    );
  } catch (error) {
    console.error('Error loading activity:', error);
    notFound();
  }
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/activities/new/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItems, readUsers } from '@directus/sdk';
import { auth } from '@/lib/auth';
import { notFound, redirect } from 'next/navigation';
import ActivityForm from '@/components/crm/activity-form';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

export const metadata = {
  title: 'Nueva Actividad - CRM',
};

export default async function NewActivityPage() {
  const session = await auth();

  if (!session?.user?.id) {
    redirect('/login');
  }

  try {
    // Obtener usuarios activos
    const users = await directusServer.request(
      readUsers({
        fields: ['id', 'first_name', 'last_name'],
        filter: {
          status: {
            _eq: 'active',
          },
        },
        sort: ['first_name', 'last_name'],
      })
    );

    // Obtener deals
    const deals = await directusServer.request(
      readItems('deals', {
        fields: ['id', 'title'],
        sort: ['title'],
        limit: -1,
      })
    );

    // Obtener contactos
    const contacts = await directusServer.request(
      readItems('contacts', {
        fields: ['id', 'first_name', 'last_name'],
        sort: ['first_name', 'last_name'],
        limit: -1,
      })
    );

    return (
      <div className="space-y-6">
        <Button variant="ghost" size="sm" asChild>
          <Link href="/dashboard/crm/activities">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a Actividades
          </Link>
        </Button>

        <ActivityForm
          users={users as any}
          deals={deals as any}
          contacts={contacts as any}
          currentUserId={session.user.id}
        />
      </div>
    );
  } catch (error) {
    console.error('Error loading form data:', error);
    notFound();
  }
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItems } from '@directus/sdk';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Users, Briefcase, CheckCircle2, Calendar, TrendingUp, Target } from 'lucide-react';
import Link from 'next/link';
import { Badge } from '@/components/ui/badge';

export const metadata = {
  title: 'Dashboard CRM',
};

export default async function CRMDashboardPage() {
  try {
    // Obtener todas las cuentas
    const accounts = await directusServer.request(
      readItems('accounts', {
        fields: ['id'],
        limit: -1,
      })
    );

    // Obtener todos los deals
    const allDeals = await directusServer.request(
  readItems('deals', {
    fields: [
      'id', 
      'title', 
      'value_eur', 
      'date_updated',
      { 
        stage: ['key', 'label'] 
      },
      {
        account: ['name']
      }
    ],
    limit: -1,
  })
);

    // Obtener deals recientes (√∫ltimos 5)
    const recentDeals = await directusServer.request(
  readItems('deals', {
    fields: [
      'id',
      'title', 
      'value_eur',
      'date_updated',
      { stage: ['label'] },
      { account: ['name'] }
    ],
    sort: ['-date_updated'],
    limit: 5,
  })
);

    // Obtener actividades pendientes
    const pendingActivities = await directusServer.request(
  readItems('activities', {
    filter: {
      completed_at: { _null: true },
    },
    fields: [
      'id',
      'subject',
      'type',
      'scheduled_at',
      { deal: ['title'] },
      { owner: ['first_name', 'last_name'] }
    ],
    sort: ['scheduled_at'],
    limit: 5,
  })
);

    // Calcular m√©tricas
    const totalDeals = allDeals.length;
    const totalPipelineValue = allDeals.reduce((sum: number, deal: any) => sum + (deal.value_eur || 0), 0);
    
    const wonDeals = allDeals.filter((deal: any) => deal.stage?.key === 'won');
    const lostDeals = allDeals.filter((deal: any) => deal.stage?.key === 'lost');
    const activeDeals = totalDeals - wonDeals.length - lostDeals.length;
    
    const winRate = totalDeals > 0 ? Math.round((wonDeals.length / totalDeals) * 100) : 0;

    // Agrupar deals por stage
    const dealsByStage = allDeals.reduce((acc: any, deal: any) => {
      const stageLabel = deal.stage?.label || 'Sin stage';
      if (!acc[stageLabel]) {
        acc[stageLabel] = 0;
      }
      acc[stageLabel]++;
      return acc;
    }, {});

    const stats = [
      {
        name: 'Cuentas Activas',
        value: accounts.length.toString(),
        icon: Users,
        description: 'Total de cuentas',
        href: '/dashboard/crm/accounts',
      },
      {
        name: 'Deals Activos',
        value: activeDeals.toString(),
        icon: Briefcase,
        description: `‚Ç¨${totalPipelineValue.toLocaleString('es-ES')} en pipeline`,
        href: '/dashboard/crm/deals',
      },
      {
        name: 'Tasa de Conversi√≥n',
        value: `${winRate}%`,
        icon: Target,
        description: `${wonDeals.length} ganados / ${totalDeals} totales`,
        href: '/dashboard/crm/deals',
      },
      {
        name: 'Actividades Pendientes',
        value: pendingActivities.length.toString(),
        icon: Calendar,
        description: 'Sin completar',
        href: '/dashboard/crm/activities',
      },
    ];

    const getActivityIcon = (type: string | null) => {
      const icons: Record<string, string> = {
        call: 'üìû',
        meeting: 'üë•',
        email: 'üìß',
        follow_up: '‚Ü™Ô∏è',
        note: 'üìù',
      };
      return type ? icons[type] || 'üìã' : 'üìã';
    };

    return (
      <div className="space-y-6">
        <div>
          <h2 className="text-3xl font-bold tracking-tight">Dashboard CRM</h2>
          <p className="text-muted-foreground">
            M√©tricas detalladas de ventas y relaciones con clientes
          </p>
        </div>

        {/* Stats Grid */}
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
          {stats.map((stat) => (
            <Link key={stat.name} href={stat.href}>
              <Card className="cursor-pointer transition-all hover:shadow-md">
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">
                    {stat.name}
                  </CardTitle>
                  <stat.icon className="h-4 w-4 text-muted-foreground" />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{stat.value}</div>
                  <p className="text-xs text-muted-foreground">{stat.description}</p>
                </CardContent>
              </Card>
            </Link>
          ))}
        </div>

        {/* Pipeline Distribution */}
        <Card>
          <CardHeader>
            <CardTitle>Distribuci√≥n del Pipeline</CardTitle>
            <CardDescription>
              Deals por etapa
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {Object.entries(dealsByStage).map(([stage, count]) => (
                <div key={stage} className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <div className="h-2 w-2 rounded-full bg-primary" />
                    <span className="text-sm font-medium">{stage}</span>
                  </div>
                  <Badge variant="secondary">{count as number}</Badge>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>

        {/* Recent Activity & Pending Tasks */}
        <div className="grid gap-4 md:grid-cols-2">
          {/* Recent Deals */}
          <Card>
            <CardHeader>
              <CardTitle>Deals Recientes</CardTitle>
              <CardDescription>
                √öltimas actualizaciones
              </CardDescription>
            </CardHeader>
            <CardContent>
              {recentDeals.length > 0 ? (
                <div className="space-y-4">
                  {recentDeals.map((deal: any) => (
                    <Link
                      key={deal.id}
                      href={`/dashboard/crm/deals/${deal.id}`}
                      className="flex items-center justify-between p-3 rounded-lg hover:bg-muted/50 transition-colors"
                    >
                      <div className="space-y-1">
                        <p className="text-sm font-medium leading-none">{deal.title}</p>
                        <p className="text-xs text-muted-foreground">
                          {deal.account?.name || 'Sin cuenta'}
                        </p>
                      </div>
                      <div className="text-right space-y-1">
                        <Badge variant="outline" className="text-xs">
                          {deal.stage?.label || 'Sin stage'}
                        </Badge>
                        {deal.value_eur && (
                          <p className="text-xs font-medium">
                            ‚Ç¨{deal.value_eur.toLocaleString('es-ES')}
                          </p>
                        )}
                      </div>
                    </Link>
                  ))}
                </div>
              ) : (
                <p className="text-sm text-muted-foreground">
                  No hay deals recientes
                </p>
              )}
            </CardContent>
          </Card>

          {/* Pending Activities */}
          <Card>
            <CardHeader>
              <CardTitle>Pr√≥ximas Actividades</CardTitle>
              <CardDescription>
                Tareas pendientes
              </CardDescription>
            </CardHeader>
            <CardContent>
              {pendingActivities.length > 0 ? (
                <div className="space-y-4">
                  {pendingActivities.map((activity: any) => (
                    <div
                      key={activity.id}
                      className="flex items-start gap-3 p-3 rounded-lg hover:bg-muted/50 transition-colors"
                    >
                      <span className="text-lg">{getActivityIcon(activity.type)}</span>
                      <div className="flex-1 space-y-1">
                        <p className="text-sm font-medium leading-none">{activity.subject}</p>
                        {activity.deal && (
                          <p className="text-xs text-muted-foreground">
                            {activity.deal.title}
                          </p>
                        )}
                        {activity.scheduled_at && (
                          <p className="text-xs text-muted-foreground">
                            {new Date(activity.scheduled_at).toLocaleDateString('es-ES', {
                              day: 'numeric',
                              month: 'short',
                              hour: '2-digit',
                              minute: '2-digit',
                            })}
                          </p>
                        )}
                      </div>
                      {activity.owner && (
                        <Badge variant="secondary" className="text-xs">
                          {activity.owner.first_name}
                        </Badge>
                      )}
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-sm text-muted-foreground">
                  No hay actividades pendientes
                </p>
              )}
            </CardContent>
          </Card>
        </div>
      </div>
    );
  } catch (error) {
    console.error('Error loading CRM dashboard:', error);
    return (
      <div className="space-y-6">
        <div>
          <h2 className="text-3xl font-bold tracking-tight">Dashboard CRM</h2>
          <p className="text-muted-foreground">
            Error al cargar las m√©tricas
          </p>
        </div>
      </div>
    );
  }
}
</file>

<file path="src/components/crm/activity-edit-form.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { activitySchema, type ActivityFormValues } from '@/lib/validations/activity';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Checkbox } from '@/components/ui/checkbox';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
  FormDescription,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

interface User {
  id: string;
  first_name: string;
  last_name: string;
}

interface Deal {
  id: string;
  title: string;
}

interface Contact {
  id: string;
  first_name: string;
  last_name: string;
}

interface Activity {
  id: string;
  subject: string;
  type?: string | null;
  description?: string | null;
  scheduled_at?: string | null;
  completed_at?: string | null;
  deal?: string | null;
  contact?: string | null;
  owner: string;
}

interface Props {
  activity: Activity;
  users: User[];
  deals: Deal[];
  contacts: Contact[];
}

const activityTypes = [
  { value: 'call', label: 'Llamada' },
  { value: 'meeting', label: 'Reuni√≥n' },
  { value: 'email', label: 'Email' },
  { value: 'follow_up', label: 'Seguimiento' },
  { value: 'note', label: 'Nota' },
];

export default function ActivityEditForm({ activity, users, deals, contacts }: Props) {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);

  // Convertir scheduled_at a formato datetime-local si existe
  const formatDateTimeLocal = (dateString: string | null | undefined) => {
    if (!dateString) return '';
    const date = new Date(dateString);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  };

  const form = useForm<ActivityFormValues>({
    resolver: zodResolver(activitySchema),
    defaultValues: {
      subject: activity.subject,
      type: activity.type as any,
      description: activity.description || '',
      owner: activity.owner,
      scheduled_at: formatDateTimeLocal(activity.scheduled_at),
      deal: activity.deal || '',
      contact: activity.contact || '',
      is_completed: !!activity.completed_at,
    },
  });

  const onSubmit = async (data: ActivityFormValues) => {
    setIsLoading(true);

    try {
      const response = await fetch(`/api/crm/activities/${activity.id}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Error al actualizar la actividad');
      }

      toast.success('Actividad actualizada correctamente');
      router.push('/dashboard/crm/activities');
      router.refresh();
    } catch (error) {
      toast.error('Error al actualizar la actividad');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Editar Actividad</CardTitle>
      </CardHeader>
      <CardContent>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            {/* Asunto */}
            <FormField
              control={form.control}
              name="subject"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Asunto *</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="Ej: Llamada de seguimiento" />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Tipo y Responsable */}
            <div className="grid gap-6 md:grid-cols-2">
              <FormField
                control={form.control}
                name="type"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Tipo</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value || undefined}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona un tipo" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {activityTypes.map((type) => (
                          <SelectItem key={type.value} value={type.value}>
                            {type.label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="owner"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Responsable *</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona responsable" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {users.map((user) => (
                          <SelectItem key={user.id} value={user.id}>
                            {user.first_name} {user.last_name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            {/* Deal y Contacto */}
            <div className="grid gap-6 md:grid-cols-2">
              <FormField
                control={form.control}
                name="deal"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Deal</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value || undefined}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona un deal (opcional)" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {deals.map((deal) => (
                          <SelectItem key={deal.id} value={deal.id}>
                            {deal.title}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormDescription>
                      El account se establecer√° autom√°ticamente desde el deal
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="contact"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Contacto</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value || undefined}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona un contacto (opcional)" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {contacts.map((contact) => (
                          <SelectItem key={contact.id} value={contact.id}>
                            {contact.first_name} {contact.last_name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            {/* Fecha programada */}
            <FormField
              control={form.control}
              name="scheduled_at"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Fecha programada</FormLabel>
                  <FormControl>
                    <Input {...field} type="datetime-local" />
                  </FormControl>
                  <FormDescription>
                    Opcional. Deja vac√≠o si es una actividad pasada o sin fecha espec√≠fica
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Descripci√≥n */}
            <FormField
              control={form.control}
              name="description"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Descripci√≥n</FormLabel>
                  <FormControl>
                    <Textarea {...field} rows={4} placeholder="Detalles adicionales..." />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Marcar como completada */}
            <FormField
              control={form.control}
              name="is_completed"
              render={({ field }) => (
                <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4">
                  <FormControl>
                    <Checkbox
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                  <div className="space-y-1 leading-none">
                    <FormLabel>Marcar como completada</FormLabel>
                    <FormDescription>
                      Se establecer√° la fecha de finalizaci√≥n al momento actual
                    </FormDescription>
                  </div>
                </FormItem>
              )}
            />

            {/* Botones */}
            <div className="flex justify-end gap-3">
              <Button
                type="button"
                variant="outline"
                onClick={() => router.back()}
                disabled={isLoading}
              >
                Cancelar
              </Button>
              <Button type="submit" disabled={isLoading}>
                {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Guardar cambios
              </Button>
            </div>
          </form>
        </Form>
      </CardContent>
    </Card>
  );
}
</file>

<file path="src/components/crm/activity-form.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { activitySchema, type ActivityFormValues } from '@/lib/validations/activity';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Checkbox } from '@/components/ui/checkbox';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
  FormDescription,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

interface User {
  id: string;
  first_name: string;
  last_name: string;
}

interface Deal {
  id: string;
  title: string;
}

interface Contact {
  id: string;
  first_name: string;
  last_name: string;
}

interface Props {
  users: User[];
  deals: Deal[];
  contacts: Contact[];
  currentUserId: string;
}

const activityTypes = [
  { value: 'call', label: 'Llamada' },
  { value: 'meeting', label: 'Reuni√≥n' },
  { value: 'email', label: 'Email' },
  { value: 'follow_up', label: 'Seguimiento' },
  { value: 'note', label: 'Nota' },
];

export default function ActivityForm({ users, deals, contacts, currentUserId }: Props) {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<ActivityFormValues>({
    resolver: zodResolver(activitySchema),
    defaultValues: {
      subject: '',
      type: undefined,
      description: '',
      owner: currentUserId,
      scheduled_at: '',
      deal: '',
      contact: '',
      is_completed: false,
    },
  });

  const onSubmit = async (data: ActivityFormValues) => {
    setIsLoading(true);

    try {
      const response = await fetch('/api/crm/activities', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Error al crear la actividad');
      }

      toast.success('Actividad creada correctamente');
      router.push('/dashboard/crm/activities');
      router.refresh();
    } catch (error) {
      toast.error('Error al crear la actividad');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Nueva Actividad</CardTitle>
      </CardHeader>
      <CardContent>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
            {/* Asunto */}
            <FormField
              control={form.control}
              name="subject"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Asunto *</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="Ej: Llamada de seguimiento" />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Tipo y Responsable */}
            <div className="grid gap-6 md:grid-cols-2">
              <FormField
                control={form.control}
                name="type"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Tipo</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona un tipo" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {activityTypes.map((type) => (
                          <SelectItem key={type.value} value={type.value}>
                            {type.label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="owner"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Responsable *</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona responsable" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {users.map((user) => (
                          <SelectItem key={user.id} value={user.id}>
                            {user.first_name} {user.last_name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            {/* Deal y Contacto */}
            <div className="grid gap-6 md:grid-cols-2">
              <FormField
                control={form.control}
                name="deal"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Deal</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona un deal (opcional)" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {deals.map((deal) => (
                          <SelectItem key={deal.id} value={deal.id}>
                            {deal.title}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormDescription>
                      El account se establecer√° autom√°ticamente desde el deal
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="contact"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Contacto</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona un contacto (opcional)" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {contacts.map((contact) => (
                          <SelectItem key={contact.id} value={contact.id}>
                            {contact.first_name} {contact.last_name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            {/* Fecha programada */}
            <FormField
              control={form.control}
              name="scheduled_at"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Fecha programada</FormLabel>
                  <FormControl>
                    <Input {...field} type="datetime-local" />
                  </FormControl>
                  <FormDescription>
                    Opcional. Deja vac√≠o si es una actividad pasada o sin fecha espec√≠fica
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Descripci√≥n */}
            <FormField
              control={form.control}
              name="description"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Descripci√≥n</FormLabel>
                  <FormControl>
                    <Textarea {...field} rows={4} placeholder="Detalles adicionales..." />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            {/* Marcar como completada */}
            <FormField
              control={form.control}
              name="is_completed"
              render={({ field }) => (
                <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4">
                  <FormControl>
                    <Checkbox
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                  <div className="space-y-1 leading-none">
                    <FormLabel>Marcar como completada</FormLabel>
                    <FormDescription>
                      Se establecer√° la fecha de finalizaci√≥n al momento actual
                    </FormDescription>
                  </div>
                </FormItem>
              )}
            />

            {/* Botones */}
            <div className="flex justify-end gap-3">
              <Button
                type="button"
                variant="outline"
                onClick={() => router.back()}
                disabled={isLoading}
              >
                Cancelar
              </Button>
              <Button type="submit" disabled={isLoading}>
                {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear actividad
              </Button>
            </div>
          </form>
        </Form>
      </CardContent>
    </Card>
  );
}
</file>

<file path=".gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "src/app/globals.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}
</file>

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
  reactCompiler: true,
};

export default nextConfig;
</file>

<file path="package.json">
{
  "name": "agency-os",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "generate-types": "node scripts/generate-directus-types.js"
  },
  "dependencies": {
    "@directus/sdk": "^20.3.0",
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "@hookform/resolvers": "^5.2.2",
    "@radix-ui/react-alert-dialog": "^1.1.15",
    "@radix-ui/react-avatar": "^1.1.11",
    "@radix-ui/react-checkbox": "^1.3.3",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-tabs": "^1.1.13",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "date-fns": "^4.1.0",
    "lucide-react": "^0.562.0",
    "next": "16.1.0",
    "next-auth": "^5.0.0-beta.30",
    "next-themes": "^0.4.6",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "react-hook-form": "^7.69.0",
    "sonner": "^2.0.7",
    "tailwind-merge": "^3.4.0",
    "zod": "^4.2.1"
  },
  "devDependencies": {
    "@directus/extensions-sdk": "^17.0.4",
    "@tailwindcss/postcss": "^4",
    "@types/archiver": "^7.0.0",
    "@types/body-parser": "^1.19.6",
    "@types/connect": "^3.4.38",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "babel-plugin-react-compiler": "1.0.0",
    "dotenv": "^17.2.3",
    "eslint": "^9",
    "eslint-config-next": "16.1.0",
    "tailwindcss": "^4",
    "tw-animate-css": "^1.4.0",
    "typescript": "^5"
  }
}
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="public/file.svg">
<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>
</file>

<file path="public/globe.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>
</file>

<file path="public/next.svg">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>
</file>

<file path="public/vercel.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>
</file>

<file path="public/window.svg">
<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>
</file>

<file path="README.md">
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
</file>

<file path="src/app/(auth)/layout.tsx">
export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return <>{children}</>;
}
</file>

<file path="src/app/(auth)/login/page.tsx">
'use client';

import { useState } from 'react';
import { signIn } from 'next-auth/react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';

export default function LoginPage() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      const result = await signIn('credentials', {
        email,
        password,
        redirect: false,
      });

      if (result?.error) {
        setError('Credenciales incorrectas');
        setLoading(false);
        return;
      }

      // Redireccionar seg√∫n el rol (implementaremos esto despu√©s)
      router.push('/dashboard');
      router.refresh();
    } catch (err) {
      setError('Error al iniciar sesi√≥n');
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
      <Card className="w-full max-w-md">
        <CardHeader className="space-y-1">
          <CardTitle className="text-2xl font-bold text-center">
            Agency OS
          </CardTitle>
          <CardDescription className="text-center">
            Introduce tus credenciales para acceder
          </CardDescription>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input
                id="email"
                type="email"
                placeholder="tu@email.com"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                required
                disabled={loading}
              />
            </div>
            <div className="space-y-2">
              <Label htmlFor="password">Contrase√±a</Label>
              <Input
                id="password"
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                required
                disabled={loading}
              />
            </div>
            {error && (
              <div className="text-sm text-red-600 bg-red-50 p-3 rounded-md">
                {error}
              </div>
            )}
            <Button type="submit" className="w-full" disabled={loading}>
              {loading ? 'Iniciando sesi√≥n...' : 'Iniciar sesi√≥n'}
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="src/app/(client-portal)/layout.tsx">

</file>

<file path="src/app/(client-portal)/portal/page.tsx">

</file>

<file path="src/app/(dashboard)/dashboard/crm/accounts/[id]/edit/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItem, readUsers, readItems } from '@directus/sdk';
import { notFound } from 'next/navigation';
import AccountForm from '@/components/crm/account-form';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

interface EditAccountPageProps {
  params: Promise<{
    id: string;
  }>;
}

export default async function EditAccountPage({ params }: EditAccountPageProps) {
  const { id } = await params;

  try {
    const account = await directusServer.request(
      readItem('accounts', id, {
        fields: [
          '*',
          'account_owner.id',
          'country.id',
        ],
      })
    );

    const users = await directusServer.request(
      readUsers({
        fields: ['id', 'first_name', 'last_name'],
        filter: {
          status: {
            _eq: 'active',
          },
        },
      })
    );

    const countries = await directusServer.request(
      readItems('countries', {
        fields: ['id', 'name'],
        sort: ['name'],
      })
    );

    return (
      <div className="space-y-6">
        <Button variant="ghost" size="sm" asChild>
          <Link href={`/dashboard/crm/accounts/${id}`}>
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a la cuenta
          </Link>
        </Button>

        <div>
          <h1 className="text-3xl font-bold">Editar Cuenta</h1>
          <p className="text-muted-foreground">
            Actualiza la informacion de la cuenta
          </p>
        </div>

        <AccountForm
          account={account}
          users={users as any}
          countries={countries as any}
        />
      </div>
    );
  } catch (error) {
    notFound();
  }
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/accounts/[id]/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItem, readItems, readUsers } from '@directus/sdk';
import { notFound } from 'next/navigation';
import AccountHeader from '@/components/crm/account-header';
import AccountTabs from '@/components/crm/account-tabs';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

interface AccountDetailPageProps {
  params: Promise<{
    id: string;
  }>;
}

export default async function AccountDetailPage({ params }: AccountDetailPageProps) {
  const { id } = await params;
  
  try {
    // Obtener datos de la cuenta
    const account = await directusServer.request(
      readItem('accounts', id, {
        fields: [
          '*',
          'account_owner.id',
          'account_owner.first_name',
          'account_owner.last_name',
          'account_owner.email',
          'country.name',
        ],
      })
    );

    // Obtener deals relacionados
    const deals = await directusServer.request(
      readItems('deals', {
        filter: {
          account: {
            _eq: id,
          },
        },
        fields: [
          'id',
          'title',
          'value_eur',
          'stage.label',
        ],
        sort: ['-date_created'],
      })
    );

    // Obtener members (equipo y contactos)
    const members = await directusServer.request(
      readItems('account_members', {
        filter: {
          account: {
            _eq: id,
          },
        },
        fields: [
          'id',
          'job_title',
          'is_primary',
          'user.id',
          'user.first_name',
          'user.last_name',
          'user.email',
          'contact.id',
          'contact.first_name',
          'contact.last_name',
          'contact.email',
        ],
        sort: ['-is_primary'],
      })
    );

    // Obtener proyectos
    const projects = await directusServer.request(
      readItems('projects', {
        filter: {
          account: {
            _eq: id,
          },
        },
        fields: ['*', 'status.label', 'owner.first_name', 'owner.last_name'],
      })
    );

    // Obtener tickets
    const tickets = await directusServer.request(
      readItems('tickets', {
        filter: {
          account: {
            _eq: id,
          },
        },
        fields: ['*', 'status.label', 'priority.label', 'assigned_to.first_name', 'assigned_to.last_name'],
      })
    );

    // ... despu√©s de obtener tickets, antes del return

// Obtener usuarios para a√±adir al equipo
const users = await directusServer.request(
  readUsers({
    fields: ['id', 'first_name', 'last_name'],
    filter: {
      status: {
        _eq: 'active',
      },
    },
  })
);

// Obtener contactos disponibles
const contacts = await directusServer.request(
  readItems('contacts', {
    fields: ['id', 'first_name', 'last_name', 'email'],
    sort: ['first_name'],
  })
);

return (
  <div className="space-y-6">
    <Button variant="ghost" size="sm" asChild>
      <Link href="/dashboard/crm/accounts">
        <ArrowLeft className="mr-2 h-4 w-4" />
        Volver a Cuentas
      </Link>
    </Button>

    <AccountHeader account={account as any} />

    <AccountTabs 
      account={account as any} 
      deals={deals as any}
      members={members as any}
      projects={projects as any}
      tickets={tickets as any}
      users={users as any}
      contacts={contacts as any}
    />
  </div>
);
  } catch (error) {
    notFound();
  }
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/accounts/new/page.tsx">
import { directusServer } from '@/lib/directus';
import { readUsers, readItems } from '@directus/sdk';
import AccountForm from '@/components/crm/account-form';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

export const metadata = {
  title: 'Nueva Cuenta - CRM',
};

export default async function NewAccountPage() {
  const users = await directusServer.request(
    readUsers({
      fields: ['id', 'first_name', 'last_name'],
      filter: {
        status: {
          _eq: 'active',
        },
      },
    })
  );

  const countries = await directusServer.request(
    readItems('countries', {
      fields: ['id', 'name'],
      sort: ['name'],
    })
  );

  return (
    <div className="space-y-6">
      <Button variant="ghost" size="sm" asChild>
        <Link href="/dashboard/crm/accounts">
          <ArrowLeft className="mr-2 h-4 w-4" />
          Volver a Cuentas
        </Link>
      </Button>

      <div>
        <h1 className="text-3xl font-bold">Nueva Cuenta</h1>
        <p className="text-muted-foreground">
          Crea una nueva cuenta en el CRM
        </p>
      </div>

      <AccountForm
        users={users as any}
        countries={countries as any}
      />
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/accounts/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItems } from '@directus/sdk';
import AccountsTable from '@/components/crm/accounts-table';
import { Button } from '@/components/ui/button';
import { Plus } from 'lucide-react';
import Link from 'next/link';

export default async function AccountsPage() {
  // Obtener accounts de Directus
  const accounts = await directusServer.request(
    readItems('accounts', {
      fields: [
        'id',
        'name',
        'status',
        'email',
        'phone',
        'city',
        'account_owner.first_name',
        'account_owner.last_name',
        'date_created',
      ],
      sort: ['-date_created'],
      limit: 100,
    })
  );

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-3xl font-bold tracking-tight">Cuentas</h2>
          <p className="text-gray-500">
            Gestiona tus cuentas y empresas
          </p>
        </div>
        <Button asChild>
          <Link href="/dashboard/crm/accounts/new">
            <Plus className="mr-2 h-4 w-4" />
            Nueva Cuenta
          </Link>
        </Button>
      </div>

      {/* Stats r√°pidas */}
      <div className="grid gap-4 md:grid-cols-4">
        <div className="bg-white p-4 rounded-lg border border-gray-200">
          <p className="text-sm text-gray-500">Total Cuentas</p>
          <p className="text-2xl font-bold">{accounts.length}</p>
        </div>
        <div className="bg-white p-4 rounded-lg border border-gray-200">
          <p className="text-sm text-gray-500">Activas</p>
          <p className="text-2xl font-bold">
            {accounts.filter((a) => a.status === 'active').length}
          </p>
        </div>
        <div className="bg-white p-4 rounded-lg border border-gray-200">
          <p className="text-sm text-gray-500">Leads</p>
          <p className="text-2xl font-bold">
            {accounts.filter((a) => a.status === 'lead').length}
          </p>
        </div>
        <div className="bg-white p-4 rounded-lg border border-gray-200">
          <p className="text-sm text-gray-500">Prospects</p>
          <p className="text-2xl font-bold">
            {accounts.filter((a) => a.status === 'prospect').length}
          </p>
        </div>
      </div>

      {/* Tabla */}
      <AccountsTable accounts={accounts} />
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/activities/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItems } from '@directus/sdk';
import ActivitiesListClient from '@/components/crm/activities-list-client';
import { Button } from '@/components/ui/button';
import { Plus } from 'lucide-react';
import Link from 'next/link';

export const metadata = {
  title: 'Actividades - CRM',
};

export default async function ActivitiesPage() {
  const activities = await directusServer.request(
    readItems('activities', {
      fields: [
        'id',
        'type',
        'subject',
        'description',
        'scheduled_at',
        'completed_at',
        'date_created',
        'owner.id',
        'owner.first_name',
        'owner.last_name',
        'deal.id',
        'deal.title',
        'account.id',
        'account.name',
        'contact.id',
        'contact.first_name',
        'contact.last_name',
      ],
      sort: ['-date_created'],
    })
  );

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">Actividades</h1>
          <p className="text-muted-foreground">
            Gestiona tus actividades y seguimientos
          </p>
        </div>
        <Button asChild>
          <Link href="/dashboard/crm/activities/new">
            <Plus className="mr-2 h-4 w-4" />
            Nueva Actividad
          </Link>
        </Button>
      </div>

      <ActivitiesListClient activities={activities as any} />
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/contacts/[id]/edit/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItem } from '@directus/sdk';
import { notFound } from 'next/navigation';
import ContactForm from '@/components/crm/contact-form';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

interface EditContactPageProps {
  params: Promise<{
    id: string;
  }>;
}

export default async function EditContactPage({ params }: EditContactPageProps) {
  const { id } = await params;

  try {
    const contact = await directusServer.request(
      readItem('contacts', id, {
        fields: ['*'],
      })
    );

    return (
      <div className="space-y-6">
        <Button variant="ghost" size="sm" asChild>
          <Link href={`/dashboard/crm/contacts/${id}`}>
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver al contacto
          </Link>
        </Button>

        <div>
          <h1 className="text-3xl font-bold">Editar Contacto</h1>
          <p className="text-muted-foreground">
            Actualiza la informacion del contacto
          </p>
        </div>

        <ContactForm contact={contact} />
      </div>
    );
  } catch (error) {
    notFound();
  }
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/contacts/[id]/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItem, readItems } from '@directus/sdk';
import { notFound } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { ArrowLeft, Edit, Mail, Phone, FileText } from 'lucide-react';
import Link from 'next/link';

interface ContactDetailPageProps {
  params: Promise<{
    id: string;
  }>;
}

export default async function ContactDetailPage({ params }: ContactDetailPageProps) {
  const { id } = await params;

  try {
    const contact = await directusServer.request(
      readItem('contacts', id, {
        fields: ['*'],
      })
    );

    // Obtener accounts relacionadas via account_members
    const accountMembers = await directusServer.request(
      readItems('account_members', {
        filter: {
          contact: {
            _eq: id,
          },
        },
        fields: [
          'id',
          'job_title',
          'is_primary',
          'account.id',
          'account.name',
        ],
      })
    );

    // Obtener deals relacionados
    const deals = await directusServer.request(
      readItems('deals', {
        filter: {
          contact: {
            _eq: id,
          },
        },
        fields: [
          'id',
          'title',
          'value_eur',
          'stage.label',
        ],
        sort: ['-date_created'],
      })
    );

    return (
      <div className="space-y-6">
        <Button variant="ghost" size="sm" asChild>
          <Link href="/dashboard/crm/contacts">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a Contactos
          </Link>
        </Button>

        {/* Header */}
        <div className="flex items-start justify-between">
          <div>
            <h1 className="text-3xl font-bold">
              {contact.first_name} {contact.last_name}
            </h1>
            <p className="text-muted-foreground mt-1">
                Creado el {contact.date_created 
                    ? new Date(contact.date_created).toLocaleDateString('es-ES', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                    })
                : 'Fecha desconocida'}
            </p>
          </div>
          <Button asChild>
            <Link href={`/dashboard/crm/contacts/${id}/edit`}>
              <Edit className="mr-2 h-4 w-4" />
              Editar
            </Link>
          </Button>
        </div>

        {/* Info Cards */}
        <div className="grid gap-4 md:grid-cols-2">
          <Card>
            <CardHeader>
              <CardTitle>Informacion de contacto</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              {contact.email && (
                <div className="flex items-center gap-2">
                  <Mail className="h-4 w-4 text-muted-foreground" />
                  <a href={`mailto:${contact.email}`} className="hover:underline">
                    {contact.email}
                  </a>
                </div>
              )}
              {contact.phone && (
                <div className="flex items-center gap-2">
                  <Phone className="h-4 w-4 text-muted-foreground" />
                  <a href={`tel:${contact.phone}`} className="hover:underline">
                    {contact.phone}
                  </a>
                </div>
              )}
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle>Cuentas asociadas</CardTitle>
            </CardHeader>
            <CardContent>
              {accountMembers.length > 0 ? (
                <div className="space-y-2">
                  {accountMembers.map((member: any) => (
                    <div key={member.id}>
                      <Link
                        href={`/dashboard/crm/accounts/${member.account.id}`}
                        className="font-medium hover:underline"
                      >
                        {member.account.name}
                      </Link>
                      {member.job_title && (
                        <p className="text-sm text-muted-foreground">
                          {member.job_title}
                        </p>
                      )}
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-sm text-muted-foreground">
                  Sin cuentas asociadas
                </p>
              )}
            </CardContent>
          </Card>
        </div>

        {/* Deals */}
        <Card>
          <CardHeader>
            <CardTitle>Deals relacionados</CardTitle>
          </CardHeader>
          <CardContent>
            {deals.length > 0 ? (
              <div className="space-y-3">
                {deals.map((deal: any) => (
                  <div
                    key={deal.id}
                    className="flex items-center justify-between p-3 border rounded-lg"
                  >
                    <div>
                      <Link
                        href={`/dashboard/crm/deals/${deal.id}`}
                        className="font-medium hover:underline"
                      >
                        {deal.title}
                      </Link>
                      <p className="text-sm text-muted-foreground">
                        {deal.stage.label}
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold">
                        {deal.value_eur
                          ? new Intl.NumberFormat('es-ES', {
                              style: 'currency',
                              currency: 'EUR',
                            }).format(deal.value_eur)
                          : '-'}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <p className="text-center py-8 text-muted-foreground">
                No hay deals asociados
              </p>
            )}
          </CardContent>
        </Card>

        {/* Notas */}
        {contact.notes && (
          <Card>
            <CardHeader>
              <div className="flex items-center gap-2">
                <FileText className="h-5 w-5" />
                <CardTitle>Notas</CardTitle>
              </div>
            </CardHeader>
            <CardContent>
              <p className="whitespace-pre-wrap">{contact.notes}</p>
            </CardContent>
          </Card>
        )}
      </div>
    );
  } catch (error) {
    notFound();
  }
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/contacts/new/page.tsx">
import ContactForm from '@/components/crm/contact-form';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

export const metadata = {
  title: 'Nuevo Contacto - CRM',
};

export default function NewContactPage() {
  return (
    <div className="space-y-6">
      <Button variant="ghost" size="sm" asChild>
        <Link href="/dashboard/crm/contacts">
          <ArrowLeft className="mr-2 h-4 w-4" />
          Volver a Contactos
        </Link>
      </Button>

      <div>
        <h1 className="text-3xl font-bold">Nuevo Contacto</h1>
        <p className="text-muted-foreground">
          Crea un nuevo contacto en el CRM
        </p>
      </div>

      <ContactForm />
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/contacts/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItems } from '@directus/sdk';
import ContactsListClient from '@/components/crm/contacts-list-client';
import { Button } from '@/components/ui/button';
import { Plus } from 'lucide-react';
import Link from 'next/link';

export const metadata = {
  title: 'Contactos - CRM',
};

export default async function ContactsPage() {
  const contacts = await directusServer.request(
    readItems('contacts', {
      fields: [
        'id',
        'first_name',
        'last_name',
        'email',
        'phone',
        'date_created',
      ],
      sort: ['-date_created'],
      limit: -1,
    })
  );

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">Contactos</h1>
          <p className="text-muted-foreground">
            Gestiona los contactos de tu CRM
          </p>
        </div>
        <Button asChild>
          <Link href="/dashboard/crm/contacts/new">
            <Plus className="mr-2 h-4 w-4" />
            Nuevo Contacto
          </Link>
        </Button>
      </div>

      <ContactsListClient contacts={contacts as any} />
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/deals/[id]/edit/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItem, readItems, readUsers } from '@directus/sdk';
import { notFound } from 'next/navigation';
import DealForm from '@/components/crm/deal-form';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

interface EditDealPageProps {
  params: Promise<{
    id: string;
  }>;
}

export default async function EditDealPage({ params }: EditDealPageProps) {
  const { id } = await params;

  try {
    const deal = await directusServer.request(
      readItem('deals', id, {
        fields: [
          '*',
          'account.id',
          'contact.id',
          'owner.id',
          'stage.id',
        ],
      })
    );

    // Obtener accounts
    const accounts = await directusServer.request(
      readItems('accounts', {
        fields: ['id', 'name'],
        sort: ['name'],
      })
    );

    // Obtener contacts
    const contacts = await directusServer.request(
      readItems('contacts', {
        fields: ['id', 'first_name', 'last_name', 'email'],
        sort: ['first_name'],
      })
    );

    // Obtener stages
    const stages = await directusServer.request(
      readItems('deal_stages', {
        fields: ['id', 'key', 'label'],
        sort: ['key'],
      })
    );

    // Obtener users
    const users = await directusServer.request(
      readUsers({
        fields: ['id', 'first_name', 'last_name'],
        filter: {
          status: {
            _eq: 'active',
          },
        },
      })
    );

    return (
      <div className="space-y-6">
        <Button variant="ghost" size="sm" asChild>
          <Link href={`/dashboard/crm/deals/${id}`}>
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver al deal
          </Link>
        </Button>

        <div>
          <h1 className="text-3xl font-bold">Editar Deal</h1>
          <p className="text-muted-foreground">
            Actualiza la informacion del deal
          </p>
        </div>

        <DealForm
          deal={deal}
          accounts={accounts as any}
          contacts={contacts as any}
          stages={stages as any}
          users={users as any}
        />
      </div>
    );
  } catch (error) {
    notFound();
  }
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/deals/new/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItems, readUsers } from '@directus/sdk';
import DealForm from '@/components/crm/deal-form';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

export const metadata = {
  title: 'Nuevo Deal - CRM',
};

export default async function NewDealPage() {
  // Obtener accounts
  const accounts = await directusServer.request(
    readItems('accounts', {
      fields: ['id', 'name'],
      sort: ['name'],
    })
  );

  // Obtener contacts
  const contacts = await directusServer.request(
    readItems('contacts', {
      fields: ['id', 'first_name', 'last_name', 'email'],
      sort: ['first_name'],
    })
  );

  // Obtener stages
  const stages = await directusServer.request(
    readItems('deal_stages', {
      fields: ['id', 'key', 'label'],
      sort: ['key'],
    })
  );

  // Obtener users (owners)
  const users = await directusServer.request(
    readUsers({
      fields: ['id', 'first_name', 'last_name'],
      filter: {
        status: {
          _eq: 'active',
        },
      },
    })
  );

  return (
    <div className="space-y-6">
      <Button variant="ghost" size="sm" asChild>
        <Link href="/dashboard/crm/deals">
          <ArrowLeft className="mr-2 h-4 w-4" />
          Volver a Deals
        </Link>
      </Button>

      <div>
        <h1 className="text-3xl font-bold">Nuevo Deal</h1>
        <p className="text-muted-foreground">
          Crea un nuevo deal en el CRM
        </p>
      </div>

      <DealForm
        accounts={accounts as any}
        contacts={contacts as any}
        stages={stages as any}
        users={users as any}
      />
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/deals/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItems, readUsers } from '@directus/sdk';
import DealsListClient from '@/components/crm/deals-list-client';
import { Button } from '@/components/ui/button';
import { Plus, Kanban } from 'lucide-react';
import Link from 'next/link';
import type { DealWithRelations, DealStage } from '@/types/crm';

export const metadata = {
  title: 'Deals - CRM',
};

interface Owner {
  id: string;
  first_name: string;
  last_name: string;
}

interface AccountSimple {
  id: string;
  name: string;
}

export default async function DealsPage() {
  // Obtener deals
  const dealsData = await directusServer.request(
    readItems('deals', {
      fields: [
        'id',
        'title',
        'value_eur',
        'probability',
        'expected_close_date',
        'date_created',
        'account.id',
        'account.name',
        'contact.id',
        'contact.first_name',
        'contact.last_name',
        'owner.id',
        'owner.first_name',
        'owner.last_name',
        'stage.id',
        'stage.key',
        'stage.label',
      ],
      sort: ['-date_created'],
    })
  );

  // Obtener stages para filtros
  const stagesData = await directusServer.request(
    readItems('deal_stages', {
      fields: ['id', 'key', 'label'],
      sort: ['label'],
    })
  );

  // Obtener owners para filtros - USAR readUsers
  const ownersData = await directusServer.request(
    readUsers({
      fields: ['id', 'first_name', 'last_name'],
      filter: {
        status: {
          _eq: 'active',
        },
      },
    })
  );

  // Obtener accounts para filtros
  const accountsData = await directusServer.request(
    readItems('accounts', {
      fields: ['id', 'name'],
      sort: ['name'],
    })
  );

  // Type casting para que coincida con los tipos esperados
  const deals = dealsData as unknown as DealWithRelations[];
  const stages = stagesData as unknown as DealStage[];
  const owners = ownersData as unknown as Owner[];
  const accounts = accountsData as unknown as AccountSimple[];

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">Deals</h1>
          <p className="text-muted-foreground">
            Gestiona tus deals y oportunidades de venta
          </p>
        </div>
        <div className="flex items-center gap-2">
          <Button variant="outline" asChild>
            <Link href="/dashboard/crm/deals/pipeline">
              <Kanban className="mr-2 h-4 w-4" />
              Vista Pipeline
            </Link>
          </Button>
          <Button asChild>
            <Link href="/dashboard/crm/deals/new">
              <Plus className="mr-2 h-4 w-4" />
              Nuevo Deal
            </Link>
          </Button>
        </div>
      </div>

      {/* Lista de deals */}
      <DealsListClient
        deals={deals}
        stages={stages}
        owners={owners}
        accounts={accounts}
      />
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/deals/pipeline/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItems, readUsers } from '@directus/sdk';
import DealsPipeline from '@/components/crm/deals-pipeline';
import { Button } from '@/components/ui/button';
import { List } from 'lucide-react';
import Link from 'next/link';

export const metadata = {
  title: 'Pipeline - Deals',
};

export default async function PipelinePage() {
  // Obtener stages
  const stages = await directusServer.request(
    readItems('deal_stages', {
      fields: ['id', 'key', 'label'],
      sort: ['key'],
    })
  );

  // Obtener deals con todas sus relaciones
  const deals = await directusServer.request(
    readItems('deals', {
      fields: [
        'id',
        'title',
        'value_eur',
        'probability',
        'stage.id',
        'stage.key',
        'stage.label',
        'account.id',
        'account.name',
        'contact.id',
        'contact.first_name',
        'contact.last_name',
        'owner.id',
        'owner.first_name',
        'owner.last_name',
      ],
      sort: ['-date_created'],
    })
  );

  // Obtener owners para filtros
  const owners = await directusServer.request(
    readUsers({
      fields: ['id', 'first_name', 'last_name'],
      filter: {
        status: {
          _eq: 'active',
        },
      },
    })
  );

  // Obtener accounts para filtros
  const accounts = await directusServer.request(
    readItems('accounts', {
      fields: ['id', 'name'],
      sort: ['name'],
    })
  );

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">Pipeline de Deals</h1>
          <p className="text-muted-foreground">
            Vista kanban de tus deals por stage
          </p>
        </div>
        <Button variant="outline" asChild>
          <Link href="/dashboard/crm/deals">
            <List className="mr-2 h-4 w-4" />
            Vista Lista
          </Link>
        </Button>
      </div>

      {/* Pipeline */}
      <DealsPipeline
        stages={stages as any}
        deals={deals as any}
        owners={owners as any}
        accounts={accounts as any}
      />
    </div>
  );
}
</file>

<file path="src/app/(dashboard)/dashboard/page.tsx">
// src/app/(dashboard)/dashboard/page.tsx
import { directusServer } from '@/lib/directus';
import { readItems } from '@directus/sdk';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { 
  Users, 
  Briefcase, 
  FolderKanban, 
  Ticket,
  Calendar,
  CheckCircle2,
  TrendingUp,
  AlertCircle
} from 'lucide-react';
import Link from 'next/link';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';

export default async function DashboardPage() {
  try {
    // CRM Data
    const accounts = await directusServer.request(
      readItems('accounts', {
        fields: ['id'],
        limit: -1,
      })
    );

    const deals = await directusServer.request(
      readItems('deals', {
        fields: [
          'id',
          'value_eur',
          { stage: ['key'] }
        ],
        limit: -1,
      })
    );

    const activeDeals = deals.filter((d: any) => 
      d.stage?.key !== 'won' && d.stage?.key !== 'lost'
    );

    const totalPipelineValue = activeDeals.reduce(
      (sum: number, deal: any) => sum + (deal.value_eur || 0), 
      0
    );

    // Activities Data
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);

    const todayEnd = new Date();
    todayEnd.setHours(23, 59, 59, 999);

    const todayActivities = await directusServer.request(
      readItems('activities', {
        filter: {
          completed_at: { _null: true },
          scheduled_at: {
            _gte: todayStart.toISOString(),
            _lte: todayEnd.toISOString(),
          },
        },
        fields: [
          'id',
          'subject',
          'type',
          'scheduled_at',
          { deal: ['title'] }
        ],
        sort: ['scheduled_at'],
        limit: 5,
      })
    );

    const pendingActivities = await directusServer.request(
      readItems('activities', {
        filter: {
          completed_at: { _null: true },
        },
        fields: ['id'],
        limit: -1,
      })
    );

    // TODO: Projects data (cuando lo implementes)
    const projects = { active: 0, total: 0 };
    
    // TODO: Tickets data (cuando lo implementes)
    const tickets = { open: 0, unassigned: 0 };

    // TODO: Tasks data (cuando lo implementes)
    const tasks = { pending: 0, overdue: 0 };

    const stats = [
      {
        name: 'Cuentas',
        value: accounts.length.toString(),
        icon: Users,
        description: 'Clientes activos',
        href: '/dashboard/crm/accounts',
        color: 'text-blue-600',
      },
      {
        name: 'Deals Activos',
        value: activeDeals.length.toString(),
        icon: Briefcase,
        description: `‚Ç¨${totalPipelineValue.toLocaleString('es-ES')}`,
        href: '/dashboard/crm/deals',
        color: 'text-green-600',
      },
      {
        name: 'Actividades Hoy',
        value: todayActivities.length.toString(),
        icon: Calendar,
        description: `${pendingActivities.length} pendientes total`,
        href: '/dashboard/crm/activities',
        color: 'text-purple-600',
      },
      {
        name: 'Proyectos',
        value: projects.active.toString(),
        icon: FolderKanban,
        description: 'Pr√≥ximamente',
        href: '/dashboard',
        color: 'text-orange-600',
      },
      {
        name: 'Tickets',
        value: tickets.open.toString(),
        icon: Ticket,
        description: 'Pr√≥ximamente',
        href: '/dashboard',
        color: 'text-red-600',
      },
      {
        name: 'Tareas',
        value: tasks.pending.toString(),
        icon: CheckCircle2,
        description: 'Pr√≥ximamente',
        href: '/dashboard',
        color: 'text-indigo-600',
      },
    ];

    const getActivityIcon = (type: string | null) => {
      const icons: Record<string, string> = {
        call: 'üìû',
        meeting: 'üë•',
        email: 'üìß',
        follow_up: '‚Ü™Ô∏è',
        note: 'üìù',
      };
      return type ? icons[type] || 'üìã' : 'üìã';
    };

    return (
      <div className="space-y-6">
        <div>
          <h2 className="text-3xl font-bold tracking-tight">Dashboard</h2>
          <p className="text-muted-foreground">
            Vista general de tu agencia
          </p>
        </div>

        {/* Stats Grid */}
        <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          {stats.map((stat) => (
            <Link key={stat.name} href={stat.href}>
              <Card className="cursor-pointer transition-all hover:shadow-md">
                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                  <CardTitle className="text-sm font-medium">
                    {stat.name}
                  </CardTitle>
                  <stat.icon className={`h-5 w-5 ${stat.color}`} />
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold">{stat.value}</div>
                  <p className="text-xs text-muted-foreground">{stat.description}</p>
                </CardContent>
              </Card>
            </Link>
          ))}
        </div>

        {/* Quick Access */}
        <div className="grid gap-4 md:grid-cols-3">
          <Link href="/dashboard/crm">
            <Card className="cursor-pointer transition-all hover:shadow-md hover:border-primary">
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Briefcase className="h-5 w-5 text-green-600" />
                  CRM
                </CardTitle>
                <CardDescription>
                  Gestiona cuentas, deals y actividades
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="flex items-center justify-between text-sm">
                  <span className="text-muted-foreground">Ver dashboard ‚Üí</span>
                </div>
              </CardContent>
            </Card>
          </Link>

          <Card className="opacity-50">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <FolderKanban className="h-5 w-5 text-orange-600" />
                Proyectos
              </CardTitle>
              <CardDescription>
                Gesti√≥n de proyectos y tareas
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Badge variant="secondary">Pr√≥ximamente</Badge>
            </CardContent>
          </Card>

          <Card className="opacity-50">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Ticket className="h-5 w-5 text-red-600" />
                Tickets
              </CardTitle>
              <CardDescription>
                Sistema de soporte al cliente
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Badge variant="secondary">Pr√≥ximamente</Badge>
            </CardContent>
          </Card>
        </div>

        {/* Today's Activities & Quick Stats */}
        <div className="grid gap-4 md:grid-cols-2">
          {/* Today's Activities */}
          <Card>
            <CardHeader>
              <CardTitle>Actividades de Hoy</CardTitle>
              <CardDescription>
                Tareas programadas para hoy
              </CardDescription>
            </CardHeader>
            <CardContent>
              {todayActivities.length > 0 ? (
                <div className="space-y-4">
                  {todayActivities.map((activity: any) => (
                    <div
                      key={activity.id}
                      className="flex items-start gap-3 p-3 rounded-lg hover:bg-muted/50 transition-colors"
                    >
                      <span className="text-lg">{getActivityIcon(activity.type)}</span>
                      <div className="flex-1 space-y-1">
                        <p className="text-sm font-medium leading-none">{activity.subject}</p>
                        {activity.deal && (
                          <p className="text-xs text-muted-foreground">
                            {activity.deal.title}
                          </p>
                        )}
                        {activity.scheduled_at && (
                          <p className="text-xs text-muted-foreground">
                            {new Date(activity.scheduled_at).toLocaleTimeString('es-ES', {
                              hour: '2-digit',
                              minute: '2-digit',
                            })}
                          </p>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-sm text-muted-foreground">
                  No hay actividades programadas para hoy
                </p>
              )}
            </CardContent>
          </Card>

          {/* CRM Quick Stats */}
          <Card>
            <CardHeader>
              <CardTitle>Resumen CRM</CardTitle>
              <CardDescription>
                M√©tricas principales
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">Pipeline Value</span>
                <span className="text-lg font-bold">
                  ‚Ç¨{totalPipelineValue.toLocaleString('es-ES')}
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">Deals Activos</span>
                <span className="text-lg font-bold">{activeDeals.length}</span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">Cuentas</span>
                <span className="text-lg font-bold">{accounts.length}</span>
              </div>
              <Link href="/dashboard/crm">
                <Button variant="outline" className="w-full mt-4">
                  Ver Dashboard CRM ‚Üí
                </Button>
              </Link>
            </CardContent>
          </Card>
        </div>
      </div>
    );
  } catch (error) {
    console.error('Error loading dashboard:', error);
    return (
      <div className="space-y-6">
        <div>
          <h2 className="text-3xl font-bold tracking-tight">Dashboard</h2>
          <p className="text-muted-foreground">
            Error al cargar las m√©tricas
          </p>
        </div>
      </div>
    );
  }
}
</file>

<file path="src/app/(dashboard)/layout.tsx">
import { redirect } from 'next/navigation';
import { auth } from '@/lib/auth';
import DashboardNav from '@/components/dashboard/dashboard-nav';
import DashboardHeader from '@/components/dashboard/dashboard-header';
import { Toaster } from '@/components/ui/sonner';

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await auth();

  if (!session) {
    redirect('/login');
  }

  // Solo empleados y admins
  if (session.user.role === 'Cliente') {
    redirect('/portal');
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <DashboardHeader user={session.user} />

      <div className="flex">
        {/* Sidebar */}
        <DashboardNav />

        {/* Main content */}
        <main className="flex-1 p-6">
          {children}
        </main>
      </div>
      
      <Toaster />
    </div>
  );
}
</file>

<file path="src/app/api/auth/[...nextauth]/route.ts">
import { handlers } from '@/lib/auth';

export const { GET, POST } = handlers;
</file>

<file path="src/app/api/auth/route.ts">

</file>

<file path="src/app/api/crm/account-members/[id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { deleteItem } from '@directus/sdk';

export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json(
        { error: 'No autenticado' },
        { status: 401 }
      );
    }

    const { id } = await params;

    await directusServer.request(deleteItem('account_members', id));

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Error deleting account member:', error);
    return NextResponse.json(
      { error: 'Error al eliminar el miembro' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/crm/account-members/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { createItem } from '@directus/sdk';
import { z } from 'zod';

const schema = z.object({
  account: z.string().min(1),
  user: z.string().optional(),
  contact: z.string().optional(),
  job_title: z.string().optional(),
  is_primary: z.boolean(),
}).refine(
  (data) => data.user || data.contact,
  { message: 'Debe proporcionar un usuario o un contacto' }
);

export async function POST(request: NextRequest) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json(
        { error: 'No autenticado' },
        { status: 401 }
      );
    }

    const body = await request.json();
    const validatedData = schema.parse(body);

    const member = await directusServer.request(
      createItem('account_members', {
        account: validatedData.account,
        user: validatedData.user || undefined,
        contact: validatedData.contact || undefined,
        job_title: validatedData.job_title || undefined,
        is_primary: validatedData.is_primary,
      })
    );

    return NextResponse.json(member);
  } catch (error) {
    console.error('Error creating account member:', error);
    return NextResponse.json(
      { error: 'Error al crear el miembro' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/crm/accounts/[id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { updateItem } from '@directus/sdk';
import { accountSchema } from '@/lib/validations/account';

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json(
        { error: 'No autenticado' },
        { status: 401 }
      );
    }

    const { id } = await params;
    const body = await request.json();
    const validatedData = accountSchema.parse(body);

    const account = await directusServer.request(
      updateItem('accounts', id, {
        name: validatedData.name,
        legal_name: validatedData.legal_name || undefined,
        status: validatedData.status || undefined,
        website: validatedData.website || undefined,
        phone: validatedData.phone || undefined,
        email: validatedData.email || undefined,
        tax_id: validatedData.tax_id || undefined,
        address: validatedData.address || undefined,
        city: validatedData.city || undefined,
        postal_code: validatedData.zip_code || undefined,
        notes: validatedData.notes || undefined,
        account_owner: validatedData.account_owner || undefined,
        country: validatedData.country || undefined,
      })
    );

    return NextResponse.json(account);
  } catch (error) {
    console.error('Error updating account:', error);
    return NextResponse.json(
      { error: 'Error al actualizar la cuenta' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/crm/accounts/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { createItem } from '@directus/sdk';
import { accountSchema } from '@/lib/validations/account';

export async function POST(request: NextRequest) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json(
        { error: 'No autenticado' },
        { status: 401 }
      );
    }

    const body = await request.json();
    const validatedData = accountSchema.parse(body);

    const account = await directusServer.request(
      createItem('accounts', {
        name: validatedData.name,
        legal_name: validatedData.legal_name || undefined,
        status: validatedData.status || undefined,
        website: validatedData.website || undefined,
        phone: validatedData.phone || undefined,
        email: validatedData.email || undefined,
        tax_id: validatedData.tax_id || undefined,
        address: validatedData.address || undefined,
        city: validatedData.city || undefined,
        zip_code: validatedData.zip_code || undefined,
        notes: validatedData.notes || undefined,
        account_owner: validatedData.account_owner || undefined,
        country: validatedData.country || undefined,
      })
    );

    return NextResponse.json(account);
  } catch (error) {
    console.error('Error creating account:', error);
    return NextResponse.json(
      { error: 'Error al crear la cuenta' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/crm/activities/[id]/complete/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { updateItem } from '@directus/sdk';

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json({ error: 'No autenticado' }, { status: 401 });
    }

    const { id } = await params;

    const activity = await directusServer.request(
      updateItem('activities', id, {
        completed_at: new Date().toISOString(),
      })
    );

    return NextResponse.json(activity);
  } catch (error) {
    console.error('Error completing activity:', error);
    return NextResponse.json({ error: 'Error al completar la actividad' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/crm/activities/[id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { deleteItem, updateItem, readItems } from '@directus/sdk';
import { activitySchema } from '@/lib/validations/activity';

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json({ error: 'No autenticado' }, { status: 401 });
    }

    const { id } = await params;
    const body = await request.json();
    const validatedData = activitySchema.parse(body);

    // Si se proporciona un deal, obtener autom√°ticamente el account asociado
    let accountId = validatedData.account;

    if (validatedData.deal && !accountId) {
      const deals = await directusServer.request(
        readItems('deals', {
          filter: {
            id: {
              _eq: validatedData.deal,
            },
          },
          fields: ['account'],
          limit: 1,
        })
      );

      if (deals && deals.length > 0) {
        accountId = deals[0].account as string;
      }
    }

    // Si is_completed es true, establecer completed_at a la fecha actual
    const completedAt = validatedData.is_completed ? new Date().toISOString() : null;

    const activity = await directusServer.request(
      updateItem('activities', id, {
        subject: validatedData.subject,
        type: validatedData.type || null,
        description: validatedData.description || null,
        owner: validatedData.owner,
        scheduled_at: validatedData.scheduled_at || null,
        completed_at: completedAt,
        deal: validatedData.deal || null,
        account: accountId || null,
        contact: validatedData.contact || null,
      })
    );

    return NextResponse.json(activity);
  } catch (error) {
    console.error('Error updating activity:', error);
    return NextResponse.json({ error: 'Error al actualizar la actividad' }, { status: 500 });
  }
}

export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json({ error: 'No autenticado' }, { status: 401 });
    }

    const { id } = await params;
    await directusServer.request(deleteItem('activities', id));

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Error deleting activity:', error);
    return NextResponse.json({ error: 'Error al eliminar la actividad' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/crm/activities/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { createItem, readItems } from '@directus/sdk';
import { activitySchema } from '@/lib/validations/activity';

export async function POST(request: NextRequest) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json({ error: 'No autenticado' }, { status: 401 });
    }

    const body = await request.json();
    const validatedData = activitySchema.parse(body);

    // Si se proporciona un deal, obtener autom√°ticamente el account asociado
    let accountId = validatedData.account;

    if (validatedData.deal && !accountId) {
      const deals = await directusServer.request(
        readItems('deals', {
          filter: {
            id: {
              _eq: validatedData.deal,
            },
          },
          fields: ['account'],
          limit: 1,
        })
      );

      if (deals && deals.length > 0) {
        accountId = deals[0].account as string;
      }
    }

    // Si is_completed es true, establecer completed_at a la fecha actual
    const completedAt = validatedData.is_completed ? new Date().toISOString() : undefined;

    const activity = await directusServer.request(
      createItem('activities', {
        subject: validatedData.subject,
        type: validatedData.type || undefined,
        description: validatedData.description || undefined,
        owner: validatedData.owner,
        scheduled_at: validatedData.scheduled_at || undefined,
        completed_at: completedAt,
        deal: validatedData.deal || undefined,
        account: accountId || undefined,
        contact: validatedData.contact || undefined,
      })
    );

    return NextResponse.json(activity);
  } catch (error) {
    console.error('Error creating activity:', error);
    return NextResponse.json({ error: 'Error al crear la actividad' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/crm/contacts/[id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { updateItem } from '@directus/sdk';
import { contactSchema } from '@/lib/validations/contact';

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json(
        { error: 'No autenticado' },
        { status: 401 }
      );
    }

    const { id } = await params;
    const body = await request.json();
    const validatedData = contactSchema.parse(body);

    const contact = await directusServer.request(
      updateItem('contacts', id, {
        first_name: validatedData.first_name,
        last_name: validatedData.last_name || undefined,
        email: validatedData.email,
        phone: validatedData.phone || undefined,
        notes: validatedData.notes || undefined,
      })
    );

    return NextResponse.json(contact);
  } catch (error) {
    console.error('Error updating contact:', error);
    return NextResponse.json(
      { error: 'Error al actualizar el contacto' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/crm/contacts/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { createItem } from '@directus/sdk';
import { contactSchema } from '@/lib/validations/contact';

export async function POST(request: NextRequest) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json(
        { error: 'No autenticado' },
        { status: 401 }
      );
    }

    const body = await request.json();
    const validatedData = contactSchema.parse(body);

    const contact = await directusServer.request(
      createItem('contacts', {
        first_name: validatedData.first_name,
        last_name: validatedData.last_name || undefined,
        email: validatedData.email,
        phone: validatedData.phone || undefined,
        notes: validatedData.notes || undefined,
      })
    );

    return NextResponse.json(contact);
  } catch (error) {
    console.error('Error creating contact:', error);
    return NextResponse.json(
      { error: 'Error al crear el contacto' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/crm/deal-items/[id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { deleteItem } from '@directus/sdk';

export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json(
        { error: 'No autenticado' },
        { status: 401 }
      );
    }

    const { id } = await params;

    await directusServer.request(deleteItem('deal_items', id));

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Error deleting deal item:', error);
    return NextResponse.json(
      { error: 'Error al eliminar el item' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/crm/deal-items/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { createItem } from '@directus/sdk';
import { z } from 'zod';

const schema = z.object({
  deal: z.string().min(1),
  package: z.string().min(1),
  quantity: z.number().int().positive(),
  unit_price: z.number().positive(),
  notes: z.string().optional(),
});

export async function POST(request: NextRequest) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json(
        { error: 'No autenticado' },
        { status: 401 }
      );
    }

    const body = await request.json();
    const validatedData = schema.parse(body);

    const dealItem = await directusServer.request(
      createItem('deal_items', {
        deal: validatedData.deal,
        package: validatedData.package,
        quantity: validatedData.quantity,
        unit_price: validatedData.unit_price,
        notes: validatedData.notes || undefined,
      })
    );

    return NextResponse.json(dealItem);
  } catch (error) {
    console.error('Error creating deal item:', error);
    return NextResponse.json(
      { error: 'Error al crear el item' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/crm/deals/[id]/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { updateItem } from '@directus/sdk';
import { dealSchema } from '@/lib/validations/deal';

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json(
        { error: 'No autenticado' },
        { status: 401 }
      );
    }

    const { id } = await params;
    const body = await request.json();
    const validatedData = dealSchema.parse(body);

    const deal = await directusServer.request(
      updateItem('deals', id, {
        title: validatedData.title,
        account: validatedData.account,
        contact: validatedData.contact || undefined,
        owner: validatedData.owner || undefined,
        stage: validatedData.stage,
        value_eur: validatedData.value_eur || undefined,
        probability: validatedData.probability || undefined,
        expected_close_date: validatedData.expected_close_date || undefined,
        notes: validatedData.notes || undefined,
      })
    );

    return NextResponse.json(deal);
  } catch (error) {
    console.error('Error updating deal:', error);
    return NextResponse.json(
      { error: 'Error al actualizar el deal' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/crm/deals/[id]/stage/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { updateItem } from '@directus/sdk';
import { z } from 'zod';

const schema = z.object({
  stage: z.string().min(1, 'El stage es obligatorio'),
});

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json(
        { error: 'No autenticado' },
        { status: 401 }
      );
    }

    const { id } = await params;
    const body = await request.json();
    const validatedData = schema.parse(body);

    const deal = await directusServer.request(
      updateItem('deals', id, {
        stage: validatedData.stage,
      })
    );

    return NextResponse.json(deal);
  } catch (error) {
    console.error('Error updating deal stage:', error);
    return NextResponse.json(
      { error: 'Error al actualizar el stage del deal' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/crm/deals/route.ts">
import { NextRequest, NextResponse } from 'next/server';
import { auth } from '@/lib/auth';
import { directusServer } from '@/lib/directus';
import { createItem } from '@directus/sdk';
import { dealSchema } from '@/lib/validations/deal';

export async function POST(request: NextRequest) {
  try {
    const session = await auth();

    if (!session) {
      return NextResponse.json(
        { error: 'No autenticado' },
        { status: 401 }
      );
    }

    const body = await request.json();
    const validatedData = dealSchema.parse(body);

    const deal = await directusServer.request(
      createItem('deals', {
        title: validatedData.title,
        account: validatedData.account,
        contact: validatedData.contact || undefined,
        owner: validatedData.owner || undefined,
        stage: validatedData.stage,
        value_eur: validatedData.value_eur || undefined,
        probability: validatedData.probability || undefined,
        expected_close_date: validatedData.expected_close_date || undefined,
        notes: validatedData.notes || undefined,
      })
    );

    return NextResponse.json(deal);
  } catch (error) {
    console.error('Error creating deal:', error);
    return NextResponse.json(
      { error: 'Error al crear el deal' },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/test-directus/route.ts">
import { NextResponse } from 'next/server';

export async function GET() {
  const directusUrl = process.env.NEXT_PUBLIC_DIRECTUS_URL;
  
  try {
    // Test b√°sico de conexi√≥n
    const response = await fetch(`${directusUrl}/server/info`, {
      headers: {
        'Content-Type': 'application/json',
      },
    });
    
    const data = await response.json();
    
    return NextResponse.json({
      success: true,
      directusUrl,
      serverInfo: data,
    });
  } catch (error) {
    return NextResponse.json({
      success: false,
      error: String(error),
      directusUrl,
    }, { status: 500 });
  }
}
</file>

<file path="src/app/globals.css">
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
  --color-sidebar-ring: var(--sidebar-ring);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar: var(--sidebar);
  --color-chart-5: var(--chart-5);
  --color-chart-4: var(--chart-4);
  --color-chart-3: var(--chart-3);
  --color-chart-2: var(--chart-2);
  --color-chart-1: var(--chart-1);
  --color-ring: var(--ring);
  --color-input: var(--input);
  --color-border: var(--border);
  --color-destructive: var(--destructive);
  --color-accent-foreground: var(--accent-foreground);
  --color-accent: var(--accent);
  --color-muted-foreground: var(--muted-foreground);
  --color-muted: var(--muted);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-secondary: var(--secondary);
  --color-primary-foreground: var(--primary-foreground);
  --color-primary: var(--primary);
  --color-popover-foreground: var(--popover-foreground);
  --color-popover: var(--popover);
  --color-card-foreground: var(--card-foreground);
  --color-card: var(--card);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
  --radius-2xl: calc(var(--radius) + 8px);
  --radius-3xl: calc(var(--radius) + 12px);
  --radius-4xl: calc(var(--radius) + 16px);
}

:root {
  --radius: 0.625rem;
  --background: oklch(1 0 0);
  --foreground: oklch(0.129 0.042 264.695);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.129 0.042 264.695);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.129 0.042 264.695);
  --primary: oklch(0.208 0.042 265.755);
  --primary-foreground: oklch(0.984 0.003 247.858);
  --secondary: oklch(0.968 0.007 247.896);
  --secondary-foreground: oklch(0.208 0.042 265.755);
  --muted: oklch(0.968 0.007 247.896);
  --muted-foreground: oklch(0.554 0.046 257.417);
  --accent: oklch(0.968 0.007 247.896);
  --accent-foreground: oklch(0.208 0.042 265.755);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.929 0.013 255.508);
  --input: oklch(0.929 0.013 255.508);
  --ring: oklch(0.704 0.04 256.788);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --sidebar: oklch(0.984 0.003 247.858);
  --sidebar-foreground: oklch(0.129 0.042 264.695);
  --sidebar-primary: oklch(0.208 0.042 265.755);
  --sidebar-primary-foreground: oklch(0.984 0.003 247.858);
  --sidebar-accent: oklch(0.968 0.007 247.896);
  --sidebar-accent-foreground: oklch(0.208 0.042 265.755);
  --sidebar-border: oklch(0.929 0.013 255.508);
  --sidebar-ring: oklch(0.704 0.04 256.788);
}

.dark {
  --background: oklch(0.129 0.042 264.695);
  --foreground: oklch(0.984 0.003 247.858);
  --card: oklch(0.208 0.042 265.755);
  --card-foreground: oklch(0.984 0.003 247.858);
  --popover: oklch(0.208 0.042 265.755);
  --popover-foreground: oklch(0.984 0.003 247.858);
  --primary: oklch(0.929 0.013 255.508);
  --primary-foreground: oklch(0.208 0.042 265.755);
  --secondary: oklch(0.279 0.041 260.031);
  --secondary-foreground: oklch(0.984 0.003 247.858);
  --muted: oklch(0.279 0.041 260.031);
  --muted-foreground: oklch(0.704 0.04 256.788);
  --accent: oklch(0.279 0.041 260.031);
  --accent-foreground: oklch(0.984 0.003 247.858);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: oklch(0.551 0.027 264.364);
  --chart-1: oklch(0.488 0.243 264.376);
  --chart-2: oklch(0.696 0.17 162.48);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: oklch(0.208 0.042 265.755);
  --sidebar-foreground: oklch(0.984 0.003 247.858);
  --sidebar-primary: oklch(0.488 0.243 264.376);
  --sidebar-primary-foreground: oklch(0.984 0.003 247.858);
  --sidebar-accent: oklch(0.279 0.041 260.031);
  --sidebar-accent-foreground: oklch(0.984 0.003 247.858);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: oklch(0.551 0.027 264.364);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}
</file>

<file path="src/app/layout.tsx">
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import './globals.css';
import { Toaster } from '@/components/ui/sonner';
import SessionProvider from '@/components/providers/session-provider';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'Agency OS - CRM & Project Management',
  description: 'Sistema de gesti√≥n para agencias digitales',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="es">
      <body className={inter.className}>
        <SessionProvider>
          {children}
          <Toaster />
        </SessionProvider>
      </body>
    </html>
  );
}
</file>

<file path="src/app/page.tsx">
import { redirect } from 'next/navigation';
import { auth } from '@/lib/auth';

export default async function Home() {
  const session = await auth();

  if (!session) {
    redirect('/login');
  }

  // Redireccionar seg√∫n rol
  if (session.user.role === 'Cliente') {
    redirect('/portal');
  }

  redirect('/dashboard');
}
</file>

<file path="src/components/crm/account-form.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { accountSchema, type AccountFormValues } from '@/lib/validations/account';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

interface User {
  id: string;
  first_name: string;
  last_name: string;
}

interface Country {
  id: string;
  name: string;
}

interface Props {
  account?: any;
  users: User[];
  countries: Country[];
}

export default function AccountForm({ account, users, countries }: Props) {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<AccountFormValues>({
    resolver: zodResolver(accountSchema),
    defaultValues: {
      name: account?.name || '',
      legal_name: account?.legal_name || '',
      status: account?.status || 'lead',
      website: account?.website || '',
      phone: account?.phone || '',
      email: account?.email || '',
      tax_id: account?.tax_id || '',
      address: account?.address || '',
      city: account?.city || '',
      zip_code: account?.zip_code || '',
      notes: account?.notes || '',
      account_owner: account?.account_owner?.id || '',
      country: account?.country?.id || '',
    },
  });

  const onSubmit = async (data: AccountFormValues) => {
    setIsLoading(true);

    try {
      const url = account
        ? `/api/crm/accounts/${account.id}`
        : '/api/crm/accounts';

      const method = account ? 'PATCH' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Error al guardar la cuenta');
      }

      toast.success(
        account ? 'Cuenta actualizada' : 'Cuenta creada',
        {
          description: account
            ? 'La cuenta se ha actualizado correctamente'
            : 'La cuenta se ha creado correctamente',
        }
      );

      router.push('/dashboard/crm/accounts');
      router.refresh();
    } catch (error) {
      toast.error('Error', {
        description: 'Ha ocurrido un error al guardar la cuenta',
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
        {/* Informacion basica */}
        <Card>
          <CardHeader>
            <CardTitle>Informacion basica</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid gap-4 md:grid-cols-2">
              <FormField
                control={form.control}
                name="name"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Nombre *</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="legal_name"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Nombre legal</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="status"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Estado</FormLabel>
                    <Select
                      onValueChange={field.onChange}
                      defaultValue={field.value}
                    >
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona un estado" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        <SelectItem value="prospect">Prospect</SelectItem>
                        <SelectItem value="lead">Lead</SelectItem>
                        <SelectItem value="active">Active</SelectItem>
                        <SelectItem value="on_hold">On Hold</SelectItem>
                        <SelectItem value="inactive">Inactive</SelectItem>
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="tax_id"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>NIF/CIF</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
          </CardContent>
        </Card>

        {/* Informacion de contacto */}
        <Card>
          <CardHeader>
            <CardTitle>Informacion de contacto</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid gap-4 md:grid-cols-2">
              <FormField
                control={form.control}
                name="email"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Email</FormLabel>
                    <FormControl>
                      <Input {...field} type="email" />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="phone"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Telefono</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="website"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Website</FormLabel>
                    <FormControl>
                      <Input {...field} placeholder="https://ejemplo.com" />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
          </CardContent>
        </Card>

        {/* Direccion */}
        <Card>
          <CardHeader>
            <CardTitle>Direccion</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="address"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Direccion</FormLabel>
                  <FormControl>
                    <Input {...field} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="grid gap-4 md:grid-cols-3">
              <FormField
                control={form.control}
                name="city"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Ciudad</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="zip_code"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Codigo Postal</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="country"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Pais</FormLabel>
                    <Select
                      onValueChange={field.onChange}
                      defaultValue={field.value}
                    >
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona un pais" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {countries.map((country) => (
                          <SelectItem key={country.id} value={country.id}>
                            {country.name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
          </CardContent>
        </Card>

        {/* Asignacion y notas */}
        <Card>
          <CardHeader>
            <CardTitle>Asignacion y notas</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="account_owner"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Propietario de la cuenta</FormLabel>
                  <Select
                    onValueChange={field.onChange}
                    defaultValue={field.value}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Selecciona un usuario" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {users.map((user) => (
                        <SelectItem key={user.id} value={user.id}>
                          {user.first_name} {user.last_name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="notes"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Notas</FormLabel>
                  <FormControl>
                    <Textarea {...field} rows={4} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        {/* Botones */}
        <div className="flex items-center gap-4">
          <Button type="submit" disabled={isLoading}>
            {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
            {account ? 'Actualizar cuenta' : 'Crear cuenta'}
          </Button>
          <Button
            type="button"
            variant="outline"
            onClick={() => router.back()}
            disabled={isLoading}
          >
            Cancelar
          </Button>
        </div>
      </form>
    </Form>
  );
}
</file>

<file path="src/components/crm/account-header.tsx">
'use client';

import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { getStatusColor } from '@/lib/utils';
import { Mail, Phone, MapPin, Globe, Building2, Edit } from 'lucide-react';
import Link from 'next/link';

const statusLabels: Record<string, string> = {
  prospect: 'Prospect',
  lead: 'Lead',
  active: 'Activo',
  on_hold: 'En Pausa',
  inactive: 'Inactivo',
};

interface AccountHeaderProps {
  account: any;
}

export default function AccountHeader({ account }: AccountHeaderProps) {
  return (
    <Card>
      <CardContent className="pt-6">
        <div className="flex items-start justify-between">
          <div className="space-y-4 flex-1">
            {/* Nombre y estado */}
            <div className="flex items-center gap-3">
              <div className="bg-blue-100 text-blue-600 rounded-lg p-3">
                <Building2 className="h-6 w-6" />
              </div>
              <div>
                <h1 className="text-2xl font-bold">{account.name}</h1>
                {account.legal_name && account.legal_name !== account.name && (
                  <p className="text-sm text-gray-500">{account.legal_name}</p>
                )}
              </div>
              {account.status && (
                <Badge className={getStatusColor(account.status)}>
                  {statusLabels[account.status] || account.status}
                </Badge>
              )}
            </div>

            {/* Informaci√≥n de contacto */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {account.email && (
                <div className="flex items-center gap-2 text-sm">
                  <Mail className="h-4 w-4 text-gray-400" />
                  <a href={`mailto:${account.email}`} className="text-blue-600 hover:underline">
                    {account.email}
                  </a>
                </div>
              )}
              {account.phone && (
                <div className="flex items-center gap-2 text-sm">
                  <Phone className="h-4 w-4 text-gray-400" />
                  <a href={`tel:${account.phone}`} className="text-blue-600 hover:underline">
                    {account.phone}
                  </a>
                </div>
              )}
              {account.website && (
                <div className="flex items-center gap-2 text-sm">
                  <Globe className="h-4 w-4 text-gray-400" />
                  <a
                    href={account.website}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-blue-600 hover:underline"
                  >
                    {account.website}
                  </a>
                </div>
              )}
              {(account.city || account.country?.name) && (
                <div className="flex items-center gap-2 text-sm">
                  <MapPin className="h-4 w-4 text-gray-400" />
                  <span className="text-gray-600">
                    {[account.city, account.country?.name].filter(Boolean).join(', ')}
                  </span>
                </div>
              )}
            </div>

            {/* Responsable */}
            {account.account_owner && (
              <div className="pt-2 border-t">
                <p className="text-sm text-gray-500">Responsable de cuenta</p>
                <p className="text-sm font-medium">
                  {`${account.account_owner.first_name || ''} ${account.account_owner.last_name || ''}`.trim()}
                </p>
              </div>
            )}
          </div>

          {/* Acciones */}
          <div className="flex gap-2">
            <Button asChild>
              <Link href={`/dashboard/crm/accounts/${account.id}/edit`}>
                <Edit className="mr-2 h-4 w-4" />
                Editar
              </Link>
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
</file>

<file path="src/components/crm/account-members.tsx">
'use client';

import { useState } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { User, Users, Mail, Briefcase, Star, Trash2 } from 'lucide-react';
import { toast } from 'sonner';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { useRouter } from 'next/navigation';
import AddInternalMemberDialog from './add-internal-member-dialog';
import AddExternalMemberDialog from './add-external-member-dialog';

interface AccountMember {
  id: string;
  user?: {
    id: string;
    first_name: string;
    last_name: string;
    email: string;
  } | null;
  contact?: {
    id: string;
    first_name: string;
    last_name: string;
    email: string;
  } | null;
  job_title?: string | null;
  is_primary: boolean;
}

interface User {
  id: string;
  first_name: string;
  last_name: string;
}

interface Contact {
  id: string;
  first_name: string;
  last_name: string;
  email: string;
}

interface Props {
  accountId: string;
  members: AccountMember[];
  users: User[];
  contacts: Contact[];
}

export default function AccountMembers({ accountId, members, users, contacts }: Props) {
  const router = useRouter();
  const [memberToDelete, setMemberToDelete] = useState<string | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const internalMembers = members.filter((m) => m.user);
  const externalMembers = members.filter((m) => m.contact);

  const handleDelete = async () => {
    if (!memberToDelete) return;

    setIsDeleting(true);
    try {
      const response = await fetch(`/api/crm/account-members/${memberToDelete}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        throw new Error('Error al eliminar el miembro');
      }

      toast.success('Miembro eliminado', {
        description: 'El miembro se ha eliminado correctamente',
      });

      router.refresh();
    } catch (error) {
      toast.error('Error', {
        description: 'Ha ocurrido un error al eliminar el miembro',
      });
    } finally {
      setIsDeleting(false);
      setMemberToDelete(null);
    }
  };

  return (
    <div className="space-y-6">
      {/* Equipo interno */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Users className="h-5 w-5" />
              <CardTitle>Equipo interno</CardTitle>
            </div>
            <AddInternalMemberDialog accountId={accountId} users={users} />
          </div>
        </CardHeader>
        <CardContent>
          {internalMembers.length > 0 ? (
            <div className="space-y-3">
              {internalMembers.map((member) => (
                <div
                  key={member.id}
                  className="flex items-center justify-between p-3 border rounded-lg"
                >
                  <div className="flex items-center gap-3">
                    <div className="h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center">
                      <User className="h-5 w-5 text-primary" />
                    </div>
                    <div>
                      <div className="flex items-center gap-2">
                        <p className="font-medium">
                          {member.user?.first_name} {member.user?.last_name}
                        </p>
                        {member.is_primary && (
                          <Badge variant="secondary" className="gap-1">
                            <Star className="h-3 w-3" />
                            Principal
                          </Badge>
                        )}
                      </div>
                      {member.job_title && (
                        <div className="flex items-center gap-1 text-sm text-muted-foreground">
                          <Briefcase className="h-3 w-3" />
                          {member.job_title}
                        </div>
                      )}
                      <div className="flex items-center gap-1 text-sm text-muted-foreground">
                        <Mail className="h-3 w-3" />
                        {member.user?.email}
                      </div>
                    </div>
                  </div>
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => setMemberToDelete(member.id)}
                  >
                    <Trash2 className="h-4 w-4 text-destructive" />
                  </Button>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-8 text-muted-foreground">
              No hay empleados asignados a esta cuenta
            </div>
          )}
        </CardContent>
      </Card>

      {/* Contactos externos */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <User className="h-5 w-5" />
              <CardTitle>Contactos del cliente</CardTitle>
            </div>
            <AddExternalMemberDialog accountId={accountId} contacts={contacts} />
          </div>
        </CardHeader>
        <CardContent>
          {externalMembers.length > 0 ? (
            <div className="space-y-3">
              {externalMembers.map((member) => (
                <div
                  key={member.id}
                  className="flex items-center justify-between p-3 border rounded-lg"
                >
                  <div className="flex items-center gap-3">
                    <div className="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center">
                      <User className="h-5 w-5 text-blue-600" />
                    </div>
                    <div>
                      <div className="flex items-center gap-2">
                        <p className="font-medium">
                          {member.contact?.first_name} {member.contact?.last_name}
                        </p>
                        {member.is_primary && (
                          <Badge variant="secondary" className="gap-1">
                            <Star className="h-3 w-3" />
                            Principal
                          </Badge>
                        )}
                      </div>
                      {member.job_title && (
                        <div className="flex items-center gap-1 text-sm text-muted-foreground">
                          <Briefcase className="h-3 w-3" />
                          {member.job_title}
                        </div>
                      )}
                      <div className="flex items-center gap-1 text-sm text-muted-foreground">
                        <Mail className="h-3 w-3" />
                        {member.contact?.email}
                      </div>
                    </div>
                  </div>
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => setMemberToDelete(member.id)}
                  >
                    <Trash2 className="h-4 w-4 text-destructive" />
                  </Button>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-8 text-muted-foreground">
              No hay contactos del cliente asociados
            </div>
          )}
        </CardContent>
      </Card>

      {/* Dialog de confirmacion */}
      <AlertDialog open={!!memberToDelete} onOpenChange={() => setMemberToDelete(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Eliminar miembro</AlertDialogTitle>
            <AlertDialogDescription>
              Esta accion eliminara el miembro del equipo de esta cuenta. Esta accion no se puede deshacer.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDelete}
              disabled={isDeleting}
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              {isDeleting ? 'Eliminando...' : 'Eliminar'}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}
</file>

<file path="src/components/crm/account-tabs.tsx">
'use client';

import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Users, Plus } from 'lucide-react';
import AccountMembers from './account-members';

interface Deal {
  id: string;
  title: string;
  value_eur: number | null;
  stage: {
    label: string;
  };
}

interface AccountMember {
  id: string;
  user?: {
    id: string;
    first_name: string;
    last_name: string;
    email: string;
  } | null;
  contact?: {
    id: string;
    first_name: string;
    last_name: string;
    email: string;
  } | null;
  job_title?: string | null;
  is_primary: boolean;
}

interface Project {
  id: string;
  name: string;
  status: {
    label: string;
  };
}

interface Ticket {
  id: string;
  subject: string;
  status: {
    label: string;
  };
  priority: {
    label: string;
  };
}

interface Account {
  id: string;
  name: string;
  notes?: string | null;
  date_created: string;
}

interface User {
  id: string;
  first_name: string;
  last_name: string;
}

interface Contact {
  id: string;
  first_name: string;
  last_name: string;
  email: string;
}

interface Props {
  account: Account;
  deals: Deal[];
  members: AccountMember[];
  projects: Project[];
  tickets: Ticket[];
  users: User[];
  contacts: Contact[];
}

export default function AccountTabs({ account, deals, members, projects, tickets, users, contacts }: Props) {
  return (
    <Tabs defaultValue="overview" className="space-y-4">
      <TabsList>
        <TabsTrigger value="overview">Resumen</TabsTrigger>
        <TabsTrigger value="team">
          Equipo
          {members.length > 0 && (
            <Badge variant="secondary" className="ml-2">
              {members.length}
            </Badge>
          )}
        </TabsTrigger>
        <TabsTrigger value="deals">
          Deals
          {deals.length > 0 && (
            <Badge variant="secondary" className="ml-2">
              {deals.length}
            </Badge>
          )}
        </TabsTrigger>
      </TabsList>

      {/* Tab: Overview */}
      <TabsContent value="overview">
        <Card>
          <CardHeader>
            <CardTitle>Informacion de la cuenta</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div>
                <label className="text-sm font-medium text-muted-foreground">
                  Fecha de creacion
                </label>
                <p className="mt-1">
                  {new Date(account.date_created).toLocaleDateString('es-ES', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                  })}
                </p>
              </div>
              {account.notes && (
                <div>
                  <label className="text-sm font-medium text-muted-foreground">
                    Notas
                  </label>
                  <p className="mt-1 whitespace-pre-wrap">{account.notes}</p>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      </TabsContent>

      {/* Tab: Equipo */}
      <TabsContent value="team">
        <AccountMembers 
          accountId={account.id} 
          members={members}
          users={users}
          contacts={contacts}
        />
      </TabsContent>

      {/* Tab: Deals */}
      <TabsContent value="deals">
        <Card>
          <CardHeader>
            <CardTitle>Deals relacionados</CardTitle>
          </CardHeader>
          <CardContent>
            {deals.length > 0 ? (
              <div className="space-y-3">
                {deals.map((deal) => (
                  <div
                    key={deal.id}
                    className="flex items-center justify-between p-3 border rounded-lg"
                  >
                    <div>
                      <h4 className="font-medium">{deal.title}</h4>
                      <p className="text-sm text-muted-foreground">
                        {deal.stage.label}
                      </p>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold">
                        {deal.value_eur
                          ? new Intl.NumberFormat('es-ES', {
                              style: 'currency',
                              currency: 'EUR',
                            }).format(deal.value_eur)
                          : '-'}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            ) : (
              <div className="text-center py-8 text-muted-foreground">
                No hay deals asociados a esta cuenta
              </div>
            )}
          </CardContent>
        </Card>
      </TabsContent>
    </Tabs>
  );
}
</file>

<file path="src/components/crm/accounts-table.tsx">
'use client';

import { useState } from 'react';
import Link from 'next/link';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Account } from '@/lib/directus';
import { formatDate, getStatusColor } from '@/lib/utils';
import { Search, Mail, Phone, ExternalLink } from 'lucide-react';

interface AccountsTableProps {
  accounts: any[];
}

const statusLabels: Record<string, string> = {
  prospect: 'Prospect',
  lead: 'Lead',
  active: 'Activo',
  on_hold: 'En Pausa',
  inactive: 'Inactivo',
};

export default function AccountsTable({ accounts }: AccountsTableProps) {
  const [search, setSearch] = useState('');

  const filteredAccounts = accounts.filter((account) => {
    const searchLower = search.toLowerCase();
    return (
      account.name?.toLowerCase().includes(searchLower) ||
      account.email?.toLowerCase().includes(searchLower) ||
      account.city?.toLowerCase().includes(searchLower)
    );
  });

  return (
    <div className="space-y-4">
      {/* B√∫squeda */}
      <div className="flex items-center gap-2">
        <div className="relative flex-1 max-w-sm">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
          <Input
            placeholder="Buscar cuentas..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10"
          />
        </div>
      </div>

      {/* Tabla */}
      <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>Nombre</TableHead>
              <TableHead>Estado</TableHead>
              <TableHead>Contacto</TableHead>
              <TableHead>Ubicaci√≥n</TableHead>
              <TableHead>Responsable</TableHead>
              <TableHead>Creado</TableHead>
              <TableHead className="w-[50px]"></TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {filteredAccounts.length === 0 ? (
              <TableRow>
                <TableCell colSpan={7} className="text-center py-8 text-gray-500">
                  {search ? 'No se encontraron cuentas' : 'No hay cuentas creadas'}
                </TableCell>
              </TableRow>
            ) : (
              filteredAccounts.map((account) => (
                <TableRow key={account.id}>
                  <TableCell>
                    <Link
                      href={`/dashboard/crm/accounts/${account.id}`}
                      className="font-medium hover:underline"
                    >
                      {account.name}
                    </Link>
                  </TableCell>
                  <TableCell>
                    {account.status && (
                      <Badge
                        variant="secondary"
                        className={getStatusColor(account.status)}
                      >
                        {statusLabels[account.status] || account.status}
                      </Badge>
                    )}
                  </TableCell>
                  <TableCell>
                    <div className="space-y-1">
                      {account.email && (
                        <div className="flex items-center gap-1 text-sm text-gray-600">
                          <Mail className="h-3 w-3" />
                          <a
                            href={`mailto:${account.email}`}
                            className="hover:underline"
                          >
                            {account.email}
                          </a>
                        </div>
                      )}
                      {account.phone && (
                        <div className="flex items-center gap-1 text-sm text-gray-600">
                          <Phone className="h-3 w-3" />
                          <a
                            href={`tel:${account.phone}`}
                            className="hover:underline"
                          >
                            {account.phone}
                          </a>
                        </div>
                      )}
                    </div>
                  </TableCell>
                  <TableCell className="text-sm text-gray-600">
                    {account.city || '-'}
                  </TableCell>
                  <TableCell className="text-sm">
                    {account.account_owner
                      ? `${account.account_owner.first_name || ''} ${
                          account.account_owner.last_name || ''
                        }`.trim()
                      : '-'}
                  </TableCell>
                  <TableCell className="text-sm text-gray-500">
                    {formatDate(account.date_created, 'dd/MM/yyyy')}
                  </TableCell>
                  <TableCell>
                    <Button
                      variant="ghost"
                      size="sm"
                      asChild
                    >
                      <Link href={`/dashboard/crm/accounts/${account.id}`}>
                        <ExternalLink className="h-4 w-4" />
                      </Link>
                    </Button>
                  </TableCell>
                </TableRow>
              ))
            )}
          </TableBody>
        </Table>
      </div>

      {/* Resumen */}
      <div className="text-sm text-gray-500">
        Mostrando {filteredAccounts.length} de {accounts.length} cuentas
      </div>
    </div>
  );
}
</file>

<file path="src/components/crm/activities-list-client.tsx">
'use client';

import { useState, useMemo } from 'react';
import { Input } from '@/components/ui/input';
import { Card } from '@/components/ui/card';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import ActivitiesTable from './activities-table';
import { Search } from 'lucide-react';

interface Activity {
  id: string;
  type: string | null;
  subject: string;
  description?: string | null;
  scheduled_at?: string | null;
  completed_at?: string | null;
  date_created: string;
  owner?: {
    id: string;
    first_name: string;
    last_name: string;
  } | null;
  deal?: {
    id: string;
    title: string;
  } | null;
  account?: {
    id: string;
    name: string;
  } | null;
}

interface Props {
  activities: Activity[];
}

export default function ActivitiesListClient({ activities }: Props) {
  const [search, setSearch] = useState('');
  const [statusFilter, setStatusFilter] = useState('all');
  const [typeFilter, setTypeFilter] = useState('all');

  const filteredActivities = useMemo(() => {
    return activities.filter((activity) => {
      const searchLower = search.toLowerCase();
      const matchesSearch =
        activity.subject.toLowerCase().includes(searchLower) ||
        (activity.description && activity.description.toLowerCase().includes(searchLower));

      const matchesStatus =
        statusFilter === 'all' ||
        (statusFilter === 'completed' && activity.completed_at) ||
        (statusFilter === 'pending' && !activity.completed_at);

      const matchesType = typeFilter === 'all' || activity.type === typeFilter;

      return matchesSearch && matchesStatus && matchesType;
    });
  }, [activities, search, statusFilter, typeFilter]);

  return (
    <div className="space-y-4">
      {/* Filtros */}
      <Card className="p-4">
        <div className="flex items-center gap-4">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
            <Input
              placeholder="Buscar actividades..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-9"
            />
          </div>
          <Select value={statusFilter} onValueChange={setStatusFilter}>
            <SelectTrigger className="w-[180px]">
              <SelectValue placeholder="Estado" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Todas</SelectItem>
              <SelectItem value="pending">Pendientes</SelectItem>
              <SelectItem value="completed">Completadas</SelectItem>
            </SelectContent>
          </Select>
          <Select value={typeFilter} onValueChange={setTypeFilter}>
            <SelectTrigger className="w-[180px]">
              <SelectValue placeholder="Tipo" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Todos</SelectItem>
              <SelectItem value="call">Llamada</SelectItem>
              <SelectItem value="meeting">Reuni√≥n</SelectItem>
              <SelectItem value="email">Email</SelectItem>
              <SelectItem value="follow_up">Seguimiento</SelectItem>
              <SelectItem value="note">Nota</SelectItem>
            </SelectContent>
          </Select>
        </div>
      </Card>

      {/* Contador */}
      <div className="text-sm text-muted-foreground">
        {filteredActivities.length} actividad{filteredActivities.length !== 1 ? 'es' : ''}
      </div>

      {/* Tabla */}
      <ActivitiesTable activities={filteredActivities} />
    </div>
  );
}
</file>

<file path="src/components/crm/activities-table.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { formatDistanceToNow } from 'date-fns';
import { es } from 'date-fns/locale';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import {
  Phone,
  Users,
  Mail,
  Bell,
  FileText,
  CheckCircle2,
  Circle,
  Trash2,
  Edit,
} from 'lucide-react';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { toast } from 'sonner';

interface Activity {
  id: string;
  type: string | null;
  subject: string;
  scheduled_at?: string | null;
  completed_at?: string | null;
  date_created: string;
  owner?: {
    id: string;
    first_name: string;
    last_name: string;
  } | null;
  deal?: {
    id: string;
    title: string;
  } | null;
  account?: {
    id: string;
    name: string;
  } | null;
}

interface Props {
  activities: Activity[];
}

export default function ActivitiesTable({ activities }: Props) {
  const router = useRouter();
  const [activityToComplete, setActivityToComplete] = useState<string | null>(null);
  const [activityToDelete, setActivityToDelete] = useState<string | null>(null);
  const [isCompleting, setIsCompleting] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);

  const handleComplete = async () => {
    if (!activityToComplete) return;

    setIsCompleting(true);
    try {
      const response = await fetch(`/api/crm/activities/${activityToComplete}/complete`, {
        method: 'PATCH',
      });

      if (!response.ok) {
        throw new Error('Error al completar la actividad');
      }

      toast.success('Actividad completada');
      router.refresh();
    } catch (error) {
      toast.error('Error al completar la actividad');
    } finally {
      setIsCompleting(false);
      setActivityToComplete(null);
    }
  };

  const handleDelete = async () => {
    if (!activityToDelete) return;

    setIsDeleting(true);
    try {
      const response = await fetch(`/api/crm/activities/${activityToDelete}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        throw new Error('Error al eliminar la actividad');
      }

      toast.success('Actividad eliminada');
      router.refresh();
    } catch (error) {
      toast.error('Error al eliminar la actividad');
    } finally {
      setIsDeleting(false);
      setActivityToDelete(null);
    }
  };

  const getActivityIcon = (type: string | null) => {
    switch (type) {
      case 'call':
        return <Phone className="h-4 w-4" />;
      case 'meeting':
        return <Users className="h-4 w-4" />;
      case 'email':
        return <Mail className="h-4 w-4" />;
      case 'follow_up':
        return <Bell className="h-4 w-4" />;
      default:
        return <FileText className="h-4 w-4" />;
    }
  };

  const getTypeLabel = (type: string | null) => {
    const labels: Record<string, string> = {
      call: 'Llamada',
      meeting: 'Reuni√≥n',
      email: 'Email',
      follow_up: 'Seguimiento',
      note: 'Nota',
    };
    return type ? labels[type] : '-';
  };

  if (activities.length === 0) {
    return (
      <div className="text-center py-12 border rounded-lg">
        <p className="text-muted-foreground">No se encontraron actividades</p>
      </div>
    );
  }

  return (
    <>
      <div className="border rounded-lg overflow-hidden">
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-muted/50">
              <tr>
                <th className="px-4 py-3 text-left text-sm font-medium">Actividad</th>
                <th className="px-4 py-3 text-left text-sm font-medium">Tipo</th>
                <th className="px-4 py-3 text-left text-sm font-medium">Relacionado</th>
                <th className="px-4 py-3 text-left text-sm font-medium">Responsable</th>
                <th className="px-4 py-3 text-left text-sm font-medium">Estado</th>
                <th className="px-4 py-3 text-left text-sm font-medium">Fecha</th>
                <th className="px-4 py-3 text-right text-sm font-medium">Acciones</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {activities.map((activity) => (
                <tr key={activity.id} className="hover:bg-muted/50">
                  <td className="px-4 py-3">
                    <div className="font-medium">{activity.subject}</div>
                  </td>
                  <td className="px-4 py-3">
                    <div className="flex items-center gap-2">
                      {getActivityIcon(activity.type)}
                      <span className="text-sm">{getTypeLabel(activity.type)}</span>
                    </div>
                  </td>
                  <td className="px-4 py-3">
                    <div className="text-sm">
                      {activity.deal && (
                        <Link
                          href={`/dashboard/crm/deals/${activity.deal.id}`}
                          className="hover:underline"
                        >
                          {activity.deal.title}
                        </Link>
                      )}
                      {activity.account && !activity.deal && (
                        <Link
                          href={`/dashboard/crm/accounts/${activity.account.id}`}
                          className="hover:underline"
                        >
                          {activity.account.name}
                        </Link>
                      )}
                      {!activity.deal && !activity.account && (
                        <span className="text-muted-foreground">-</span>
                      )}
                    </div>
                  </td>
                  <td className="px-4 py-3 text-sm">
                    {activity.owner
                      ? `${activity.owner.first_name} ${activity.owner.last_name}`
                      : '-'}
                  </td>
                  <td className="px-4 py-3">
                    {activity.completed_at ? (
                      <Badge variant="default" className="gap-1">
                        <CheckCircle2 className="h-3 w-3" />
                        Completada
                      </Badge>
                    ) : (
                      <Badge variant="outline">Pendiente</Badge>
                    )}
                  </td>
                  <td className="px-4 py-3 text-sm text-muted-foreground">
                    {formatDistanceToNow(new Date(activity.date_created), {
                      addSuffix: true,
                      locale: es,
                    })}
                  </td>
                  <td className="px-4 py-3">
                    <div className="flex items-center justify-end gap-2">
                      {!activity.completed_at && (
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => setActivityToComplete(activity.id)}
                          title="Marcar como completada"
                          className="cursor-pointer hover:bg-green-100 hover:text-green-700" // <-- Agregar
                        >
                          <CheckCircle2 className="h-4 w-4 text-green-600" />
                        </Button>
                      )}
                      <Button
                        variant="ghost"
                        size="sm"
                        asChild
                        title="Editar"
                        className="cursor-pointer hover:bg-blue-100 hover:text-blue-700" // <-- Agregar
                      >
                        <Link href={`/dashboard/crm/activities/${activity.id}/edit`}>
                          <Edit className="h-4 w-4" />
                        </Link>
                      </Button>
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => setActivityToDelete(activity.id)}
                        title="Eliminar"
                        className="cursor-pointer hover:bg-red-100 hover:text-red-700" // <-- Agregar
                      >
                        <Trash2 className="h-4 w-4 text-destructive" />
                      </Button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      {/* Dialog para completar */}
      <AlertDialog
        open={!!activityToComplete}
        onOpenChange={() => setActivityToComplete(null)}
      >
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Completar actividad</AlertDialogTitle>
            <AlertDialogDescription>
              ¬øMarcar esta actividad como completada?
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isCompleting}>Cancelar</AlertDialogCancel>
            <AlertDialogAction onClick={handleComplete} disabled={isCompleting}>
              {isCompleting ? 'Completando...' : 'Completar'}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      {/* Dialog para eliminar */}
      <AlertDialog
        open={!!activityToDelete}
        onOpenChange={() => setActivityToDelete(null)}
      >
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Eliminar actividad</AlertDialogTitle>
            <AlertDialogDescription>
              Esta acci√≥n no se puede deshacer.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDelete}
              disabled={isDeleting}
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              {isDeleting ? 'Eliminando...' : 'Eliminar'}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
</file>

<file path="src/components/crm/add-activity-dialog.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { activitySchema, type ActivityFormValues } from '@/lib/validations/activity';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Checkbox } from '@/components/ui/checkbox';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
  FormDescription,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Loader2, Plus } from 'lucide-react';
import { toast } from 'sonner';

interface User {
  id: string;
  first_name: string;
  last_name: string;
}

interface Props {
  dealId: string;
  users: User[];
  currentUserId?: string;
}

const activityTypes = [
  { value: 'call', label: 'Llamada' },
  { value: 'meeting', label: 'Reuni√≥n' },
  { value: 'email', label: 'Email' },
  { value: 'follow_up', label: 'Seguimiento' },
  { value: 'note', label: 'Nota' },
];

export default function AddActivityDialog({ dealId, users, currentUserId }: Props) {
  const router = useRouter();
  const [open, setOpen] = useState(false);
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<ActivityFormValues>({
    resolver: zodResolver(activitySchema),
    defaultValues: {
      subject: '',
      type: undefined,
      description: '',
      owner: currentUserId || '',
      scheduled_at: '',
      deal: dealId,
      is_completed: false,
    },
  });

  const onSubmit = async (data: ActivityFormValues) => {
    setIsLoading(true);

    try {
      const response = await fetch('/api/crm/activities', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          ...data,
          deal: dealId,
        }),
      });

      if (!response.ok) {
        throw new Error('Error al crear la actividad');
      }

      toast.success('Actividad creada');
      setOpen(false);
      form.reset();
      router.refresh();
    } catch (error) {
      toast.error('Error al crear la actividad');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button size="sm">
          <Plus className="mr-2 h-4 w-4" />
          Nueva actividad
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>Nueva actividad</DialogTitle>
        </DialogHeader>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="subject"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Asunto *</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="Ej: Llamada de seguimiento" />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="grid gap-4 md:grid-cols-2">
              <FormField
                control={form.control}
                name="type"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Tipo</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona un tipo" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {activityTypes.map((type) => (
                          <SelectItem key={type.value} value={type.value}>
                            {type.label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="owner"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Responsable *</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona responsable" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {users.map((user) => (
                          <SelectItem key={user.id} value={user.id}>
                            {user.first_name} {user.last_name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <FormField
              control={form.control}
              name="scheduled_at"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Fecha programada</FormLabel>
                  <FormControl>
                    <Input {...field} type="datetime-local" />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="description"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Descripci√≥n</FormLabel>
                  <FormControl>
                    <Textarea {...field} rows={4} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="is_completed"
              render={({ field }) => (
                <FormItem className="flex flex-row items-start space-x-3 space-y-0 rounded-md border p-4">
                  <FormControl>
                    <Checkbox
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                  <div className="space-y-1 leading-none">
                    <FormLabel>Marcar como completada</FormLabel>
                    <FormDescription>
                      Se establecer√° la fecha de finalizaci√≥n al momento actual
                    </FormDescription>
                  </div>
                </FormItem>
              )}
            />

            <div className="flex justify-end gap-3">
              <Button
                type="button"
                variant="outline"
                onClick={() => setOpen(false)}
                disabled={isLoading}
              >
                Cancelar
              </Button>
              <Button type="submit" disabled={isLoading}>
                {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Crear
              </Button>
            </div>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/crm/add-deal-item-dialog.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Loader2, Plus } from 'lucide-react';
import { toast } from 'sonner';

const schema = z.object({
  package: z.string().min(1, 'Selecciona un servicio/producto'),
  quantity: z.number().int().positive('La cantidad debe ser mayor a 0'),
  unit_price: z.number().positive('El precio debe ser mayor a 0'),
  notes: z.string().optional(),
});

type FormValues = z.infer<typeof schema>;

interface ServicePackage {
  id: string;
  name: string;
  base_price: number | null;
}

interface Props {
  dealId: string;
  servicePackages: ServicePackage[];
}

export default function AddDealItemDialog({ dealId, servicePackages }: Props) {
  const router = useRouter();
  const [open, setOpen] = useState(false);
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<FormValues>({
    resolver: zodResolver(schema),
    defaultValues: {
      package: '',
      quantity: 1,
      unit_price: 0,
      notes: '',
    },
  });

  const selectedPackageId = form.watch('package');

  // Actualizar precio cuando se selecciona un paquete
const handlePackageChange = (packageId: string) => {
  form.setValue('package', packageId);
  const selectedPackage = servicePackages.find((p) => p.id === packageId);
  if (selectedPackage?.base_price !== null && selectedPackage?.base_price !== undefined) {
    // Convertir expl√≠citamente a n√∫mero
    form.setValue('unit_price', Number(selectedPackage.base_price));
  }
};

  const onSubmit = async (data: FormValues) => {
    setIsLoading(true);

    try {
      const response = await fetch('/api/crm/deal-items', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          deal: dealId,
          package: data.package,
          quantity: data.quantity,
          unit_price: data.unit_price,
          notes: data.notes || undefined,
        }),
      });

      if (!response.ok) {
        throw new Error('Error al a√±adir el item');
      }

      toast.success('Item a√±adido', {
        description: 'El item se ha a√±adido correctamente al deal',
      });

      setOpen(false);
      form.reset();
      router.refresh();
    } catch (error) {
      toast.error('Error', {
        description: 'Ha ocurrido un error al a√±adir el item',
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button size="sm">
          <Plus className="mr-2 h-4 w-4" />
          A√±adir item
        </Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>A√±adir servicio/producto al deal</DialogTitle>
        </DialogHeader>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="package"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Servicio/Producto *</FormLabel>
                  <Select
                    onValueChange={handlePackageChange}
                    defaultValue={field.value}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Selecciona un servicio" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                        {servicePackages.map((pkg) => (
                            <SelectItem key={pkg.id} value={pkg.id}>
                                {pkg.name}
                                {pkg.base_price !== null && pkg.base_price !== undefined && 
                                    ` - ${Number(pkg.base_price).toFixed(2)}‚Ç¨`
                                }
                            </SelectItem>
                        ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="grid gap-4 md:grid-cols-2">
                          <FormField
                              control={form.control}
                              name="quantity"
                              render={({ field }) => (
                                  <FormItem>
                                      <FormLabel>Cantidad *</FormLabel>
                                      <FormControl>
                                          <Input
                                              type="number"
                                              min="1"
                                              value={field.value}
                                              onChange={(e) => {
                                                  const value = e.target.value;
                                                  field.onChange(value === '' ? 1 : parseInt(value));
                                              }}
                                          />
                                      </FormControl>
                                      <FormMessage />
                                  </FormItem>
                              )}
                          />

                          <FormField
                              control={form.control}
                              name="unit_price"
                              render={({ field }) => (
                                  <FormItem>
                                      <FormLabel>Precio unitario (EUR) *</FormLabel>
                                      <FormControl>
                                          <Input
                                              type="number"
                                              step="0.01"
                                              min="0"
                                              value={field.value}
                                              onChange={(e) => {
                                                  const value = e.target.value;
                                                  field.onChange(value === '' ? 0 : parseFloat(value));
                                              }}
                                          />
                                      </FormControl>
                                      <FormMessage />
                                  </FormItem>
                              )}
                          />
            </div>

            <FormField
              control={form.control}
              name="notes"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Notas</FormLabel>
                  <FormControl>
                    <Textarea {...field} rows={3} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="flex justify-end gap-3">
              <Button
                type="button"
                variant="outline"
                onClick={() => setOpen(false)}
                disabled={isLoading}
              >
                Cancelar
              </Button>
              <Button type="submit" disabled={isLoading}>
                {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                A√±adir
              </Button>
            </div>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/crm/add-external-member-dialog.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import { Loader2, Plus } from 'lucide-react';
import { toast } from 'sonner';

const schema = z.object({
  contact: z.string().min(1, 'Selecciona un contacto'),
  job_title: z.string().optional(),
  is_primary: z.boolean(),
});

type FormValues = z.infer<typeof schema>;

interface Contact {
  id: string;
  first_name: string;
  last_name: string;
  email: string;
}

interface Props {
  accountId: string;
  contacts: Contact[];
}

export default function AddExternalMemberDialog({ accountId, contacts }: Props) {
  const router = useRouter();
  const [open, setOpen] = useState(false);
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<FormValues>({
    resolver: zodResolver(schema),
    defaultValues: {
        contact: '',
        job_title: '',
        is_primary: false,
    },
});

  const onSubmit = async (data: FormValues) => {
    setIsLoading(true);

    try {
      const response = await fetch('/api/crm/account-members', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          account: accountId,
          contact: data.contact,
          job_title: data.job_title || undefined,
          is_primary: data.is_primary,
        }),
      });

      if (!response.ok) {
        throw new Error('Error al a√±adir el contacto');
      }

      toast.success('Contacto a√±adido', {
        description: 'El contacto se ha a√±adido correctamente',
      });

      setOpen(false);
      form.reset();
      router.refresh();
    } catch (error) {
      toast.error('Error', {
        description: 'Ha ocurrido un error al a√±adir el contacto',
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button size="sm">
          <Plus className="mr-2 h-4 w-4" />
          Anadir contacto
        </Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Anadir contacto del cliente</DialogTitle>
        </DialogHeader>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="contact"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Contacto *</FormLabel>
                  <Select onValueChange={field.onChange} defaultValue={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Selecciona un contacto" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {contacts.map((contact) => (
                        <SelectItem key={contact.id} value={contact.id}>
                          {contact.first_name} {contact.last_name} ({contact.email})
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="job_title"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Cargo</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="Ej: Director de Marketing" />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="is_primary"
              render={({ field }) => (
                <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                  <FormControl>
                    <Checkbox
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                  <div className="space-y-1 leading-none">
                    <FormLabel>Marcar como contacto principal</FormLabel>
                  </div>
                </FormItem>
              )}
            />

            <div className="flex justify-end gap-3">
              <Button
                type="button"
                variant="outline"
                onClick={() => setOpen(false)}
                disabled={isLoading}
              >
                Cancelar
              </Button>
              <Button type="submit" disabled={isLoading}>
                {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Anadir
              </Button>
            </div>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/crm/add-internal-member-dialog.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import { Loader2, Plus } from 'lucide-react';
import { toast } from 'sonner';

const schema = z.object({
  user: z.string().min(1, 'Selecciona un empleado'),
  job_title: z.string().optional(),
  is_primary: z.boolean(),
});

type FormValues = z.infer<typeof schema>;

interface User {
  id: string;
  first_name: string;
  last_name: string;
}

interface Props {
  accountId: string;
  users: User[];
}

export default function AddInternalMemberDialog({ accountId, users }: Props) {
  const router = useRouter();
  const [open, setOpen] = useState(false);
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<FormValues>({
    resolver: zodResolver(schema),
    defaultValues: {
        user: '',
        job_title: '',
        is_primary: false,
    },
    });

  const onSubmit = async (data: FormValues) => {
    setIsLoading(true);

    try {
      const response = await fetch('/api/crm/account-members', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          account: accountId,
          user: data.user,
          job_title: data.job_title || undefined,
          is_primary: data.is_primary,
        }),
      });

      if (!response.ok) {
        throw new Error('Error al a√±adir el miembro');
      }

      toast.success('Empleado a√±adido', {
        description: 'El empleado se ha a√±adido correctamente al equipo',
      });

      setOpen(false);
      form.reset();
      router.refresh();
    } catch (error) {
      toast.error('Error', {
        description: 'Ha ocurrido un error al a√±adir el empleado',
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button size="sm">
          <Plus className="mr-2 h-4 w-4" />
          Anadir empleado
        </Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Anadir empleado al equipo</DialogTitle>
        </DialogHeader>
        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="user"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Empleado *</FormLabel>
                  <Select onValueChange={field.onChange} defaultValue={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Selecciona un empleado" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      {users.map((user) => (
                        <SelectItem key={user.id} value={user.id}>
                          {user.first_name} {user.last_name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="job_title"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Cargo</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="Ej: Account Manager" />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="is_primary"
              render={({ field }) => (
                <FormItem className="flex flex-row items-start space-x-3 space-y-0">
                  <FormControl>
                    <Checkbox
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  </FormControl>
                  <div className="space-y-1 leading-none">
                    <FormLabel>Marcar como contacto principal</FormLabel>
                  </div>
                </FormItem>
              )}
            />

            <div className="flex justify-end gap-3">
              <Button
                type="button"
                variant="outline"
                onClick={() => setOpen(false)}
                disabled={isLoading}
              >
                Cancelar
              </Button>
              <Button type="submit" disabled={isLoading}>
                {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                Anadir
              </Button>
            </div>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}
</file>

<file path="src/components/crm/contact-form.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { contactSchema, type ContactFormValues } from '@/lib/validations/contact';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

interface Props {
  contact?: any;
}

export default function ContactForm({ contact }: Props) {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<ContactFormValues>({
    resolver: zodResolver(contactSchema),
    defaultValues: {
      first_name: contact?.first_name || '',
      last_name: contact?.last_name || '',
      email: contact?.email || '',
      phone: contact?.phone || '',
      notes: contact?.notes || '',
    },
  });

  const onSubmit = async (data: ContactFormValues) => {
    setIsLoading(true);

    try {
      const url = contact
        ? `/api/crm/contacts/${contact.id}`
        : '/api/crm/contacts';

      const method = contact ? 'PATCH' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Error al guardar el contacto');
      }

      toast.success(
        contact ? 'Contacto actualizado' : 'Contacto creado',
        {
          description: contact
            ? 'El contacto se ha actualizado correctamente'
            : 'El contacto se ha creado correctamente',
        }
      );

      router.push('/dashboard/crm/contacts');
      router.refresh();
    } catch (error) {
      toast.error('Error', {
        description: 'Ha ocurrido un error al guardar el contacto',
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
        <Card>
          <CardHeader>
            <CardTitle>Informacion del contacto</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid gap-4 md:grid-cols-2">
              <FormField
                control={form.control}
                name="first_name"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Nombre *</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="last_name"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Apellidos</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="email"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Email *</FormLabel>
                    <FormControl>
                      <Input {...field} type="email" />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="phone"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Telefono</FormLabel>
                    <FormControl>
                      <Input {...field} />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>

            <FormField
              control={form.control}
              name="notes"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Notas</FormLabel>
                  <FormControl>
                    <Textarea {...field} rows={4} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        <div className="flex items-center gap-4">
          <Button type="submit" disabled={isLoading}>
            {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
            {contact ? 'Actualizar contacto' : 'Crear contacto'}
          </Button>
          <Button
            type="button"
            variant="outline"
            onClick={() => router.back()}
            disabled={isLoading}
          >
            Cancelar
          </Button>
        </div>
      </form>
    </Form>
  );
}
</file>

<file path="src/components/crm/contacts-list-client.tsx">
'use client';

import { useState, useMemo } from 'react';
import { Input } from '@/components/ui/input';
import { Card } from '@/components/ui/card';
import ContactsTable from './contacts-table';
import { Search } from 'lucide-react';

interface Contact {
  id: string;
  first_name: string;
  last_name: string;
  email: string;
  phone?: string | null;
  date_created: string;
}

interface Props {
  contacts: Contact[];
}

export default function ContactsListClient({ contacts }: Props) {
  const [search, setSearch] = useState('');

  const filteredContacts = useMemo(() => {
    return contacts.filter((contact) => {
      const searchLower = search.toLowerCase();
      const fullName = `${contact.first_name} ${contact.last_name}`.toLowerCase();
      const email = contact.email.toLowerCase();
      
      return (
        fullName.includes(searchLower) ||
        email.includes(searchLower) ||
        (contact.phone && contact.phone.includes(search))
      );
    });
  }, [contacts, search]);

  return (
    <div className="space-y-4">
      {/* Filtros */}
      <Card className="p-4">
        <div className="flex items-center gap-4">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-muted-foreground" />
            <Input
              placeholder="Buscar por nombre, email o telefono..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-9"
            />
          </div>
        </div>
      </Card>

      {/* Resultados */}
      <div className="text-sm text-muted-foreground">
        {filteredContacts.length} contacto{filteredContacts.length !== 1 ? 's' : ''}
      </div>

      {/* Tabla */}
      <ContactsTable contacts={filteredContacts} />
    </div>
  );
}
</file>

<file path="src/components/crm/contacts-table.tsx">
'use client';

import Link from 'next/link';
import { formatDistanceToNow } from 'date-fns';
import { es } from 'date-fns/locale';
import { Mail, Phone } from 'lucide-react';

interface Contact {
  id: string;
  first_name: string;
  last_name: string;
  email: string;
  phone?: string | null;
  date_created: string;
}

interface Props {
  contacts: Contact[];
}

export default function ContactsTable({ contacts }: Props) {
  if (contacts.length === 0) {
    return (
      <div className="text-center py-12 border rounded-lg">
        <p className="text-muted-foreground">No se encontraron contactos</p>
      </div>
    );
  }

  return (
    <div className="border rounded-lg overflow-hidden">
      <div className="overflow-x-auto">
        <table className="w-full">
          <thead className="bg-muted/50">
            <tr>
              <th className="px-4 py-3 text-left text-sm font-medium">Nombre</th>
              <th className="px-4 py-3 text-left text-sm font-medium">Email</th>
              <th className="px-4 py-3 text-left text-sm font-medium">Telefono</th>
              <th className="px-4 py-3 text-left text-sm font-medium">Creado</th>
            </tr>
          </thead>
          <tbody className="divide-y">
            {contacts.map((contact) => (
              <tr
                key={contact.id}
                className="hover:bg-muted/50 cursor-pointer transition-colors"
              >
                <td className="px-4 py-3">
                  <Link
                    href={`/dashboard/crm/contacts/${contact.id}`}
                    className="font-medium hover:underline"
                  >
                    {contact.first_name} {contact.last_name}
                  </Link>
                </td>
                <td className="px-4 py-3">
                  <div className="flex items-center gap-2 text-sm">
                    <Mail className="h-4 w-4 text-muted-foreground" />
                    <a 
                      href={`mailto:${contact.email}`}
                      className="hover:underline"
                      onClick={(e) => e.stopPropagation()}
                    >
                      {contact.email}
                    </a>
                  </div>
                </td>
                <td className="px-4 py-3">
                  {contact.phone ? (
                    <div className="flex items-center gap-2 text-sm">
                      <Phone className="h-4 w-4 text-muted-foreground" />
                      <a 
                        href={`tel:${contact.phone}`}
                        className="hover:underline"
                        onClick={(e) => e.stopPropagation()}
                      >
                        {contact.phone}
                      </a>
                    </div>
                  ) : (
                    <span className="text-sm text-muted-foreground">-</span>
                  )}
                </td>
                <td className="px-4 py-3 text-sm text-muted-foreground">
                  {formatDistanceToNow(new Date(contact.date_created), {
                    addSuffix: true,
                    locale: es,
                  })}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
}
</file>

<file path="src/components/crm/deal-activities-manager.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { formatDistanceToNow } from 'date-fns';
import { es } from 'date-fns/locale';
import {
  Calendar,
  CheckCircle2,
  Circle,
  Phone,
  Users,
  Mail,
  Bell,
  FileText,
  Trash2,
} from 'lucide-react';
import { toast } from 'sonner';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import AddActivityDialog from './add-activity-dialog';

interface Activity {
  id: string;
  type: string | null;
  subject: string;
  description?: string | null;
  scheduled_at?: string | null;
  completed_at?: string | null;
  owner?: {
    id: string;
    first_name: string;
    last_name: string;
  } | null;
  date_created: string;
}

interface User {
  id: string;
  first_name: string;
  last_name: string;
}

interface Props {
  dealId: string;
  activities: Activity[];
  users: User[];
  currentUserId: string;
}

export default function DealActivitiesManager({ dealId, activities, users, currentUserId }: Props) {
  const router = useRouter();
  const [activityToDelete, setActivityToDelete] = useState<string | null>(null);
  const [activityToComplete, setActivityToComplete] = useState<string | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);
  const [isCompleting, setIsCompleting] = useState(false);

  const handleDelete = async () => {
    if (!activityToDelete) return;

    setIsDeleting(true);
    try {
      const response = await fetch(`/api/crm/activities/${activityToDelete}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        throw new Error('Error al eliminar la actividad');
      }

      toast.success('Actividad eliminada');
      router.refresh();
    } catch (error) {
      toast.error('Error al eliminar la actividad');
    } finally {
      setIsDeleting(false);
      setActivityToDelete(null);
    }
  };

  const handleComplete = async () => {
    if (!activityToComplete) return;

    setIsCompleting(true);
    try {
      const response = await fetch(`/api/crm/activities/${activityToComplete}/complete`, {
        method: 'PATCH',
      });

      if (!response.ok) {
        throw new Error('Error al completar la actividad');
      }

      toast.success('Actividad completada');
      router.refresh();
    } catch (error) {
      toast.error('Error al completar la actividad');
    } finally {
      setIsCompleting(false);
      setActivityToComplete(null);
    }
  };

  const getActivityIcon = (type: string | null) => {
    switch (type) {
      case 'call':
        return <Phone className="h-5 w-5" />;
      case 'meeting':
        return <Users className="h-5 w-5" />;
      case 'email':
        return <Mail className="h-5 w-5" />;
      case 'follow_up':
        return <Bell className="h-5 w-5" />;
      default:
        return <FileText className="h-5 w-5" />;
    }
  };

  const getActivityTypeLabel = (type: string | null) => {
    const labels: Record<string, string> = {
      call: 'Llamada',
      meeting: 'Reuni√≥n',
      email: 'Email',
      follow_up: 'Seguimiento',
      note: 'Nota',
    };
    return type ? labels[type] || type : 'Actividad';
  };

  return (
    <>
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle>Historial de actividades</CardTitle>
            <AddActivityDialog
              dealId={dealId}
              users={users}
              currentUserId={currentUserId}
            />
          </div>
        </CardHeader>
        <CardContent>
          {activities.length > 0 ? (
            <div className="space-y-4">
              {activities.map((activity) => (
                <div
                  key={activity.id}
                  className="flex gap-4 pb-4 border-b last:border-0 last:pb-0"
                >
                  <div className="flex-shrink-0 text-muted-foreground">
                    {getActivityIcon(activity.type)}
                  </div>
                  <div className="flex-1 space-y-1">
                    <div className="flex items-start justify-between">
                      <div>
                        <h4 className="font-medium">{activity.subject}</h4>
                        <Badge variant="secondary" className="text-xs">
                          {getActivityTypeLabel(activity.type)}
                        </Badge>
                      </div>
                      <div className="flex items-center gap-2">
                        {!activity.completed_at && (
                          <Button
                            variant="ghost"
                            size="sm"
                            onClick={() => setActivityToComplete(activity.id)}
                            className="cursor-pointer hover:bg-green-100 hover:text-green-700" // <-- Agregar
                          >
                            <CheckCircle2 className="h-4 w-4 text-green-600" />
                          </Button>
                        )}
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => setActivityToDelete(activity.id)}
                          className="cursor-pointer hover:bg-red-100 hover:text-red-700" // <-- Agregar
                        >
                          <Trash2 className="h-4 w-4 text-destructive" />
                        </Button>
                      </div>
                    </div>
                    {activity.description && (
                      <p className="text-sm text-muted-foreground">
                        {activity.description}
                      </p>
                    )}
                    <div className="flex items-center gap-4 text-xs text-muted-foreground">
                      {activity.owner && (
                        <span>
                          {activity.owner.first_name} {activity.owner.last_name}
                        </span>
                      )}
                      {activity.scheduled_at && (
                        <div className="flex items-center gap-1">
                          <Calendar className="h-3 w-3" />
                          {new Date(activity.scheduled_at).toLocaleDateString('es-ES', {
                            day: 'numeric',
                            month: 'short',
                            year: 'numeric',
                          })}
                        </div>
                      )}
                      {activity.completed_at ? (
                        <Badge variant="default" className="text-xs">
                          Completada
                        </Badge>
                      ) : (
                        <Badge variant="outline" className="text-xs">
                          Pendiente
                        </Badge>
                      )}
                      <span>
                        {formatDistanceToNow(new Date(activity.date_created), {
                          addSuffix: true,
                          locale: es,
                        })}
                      </span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div className="text-center py-8 text-muted-foreground">
              No hay actividades registradas
            </div>
          )}
        </CardContent>
      </Card>

      {/* Delete dialog */}
      <AlertDialog
        open={!!activityToDelete}
        onOpenChange={() => setActivityToDelete(null)}
      >
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Eliminar actividad</AlertDialogTitle>
            <AlertDialogDescription>
              Esta acci√≥n no se puede deshacer.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDelete}
              disabled={isDeleting}
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              {isDeleting ? 'Eliminando...' : 'Eliminar'}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>

      {/* Complete dialog */}
      <AlertDialog
        open={!!activityToComplete}
        onOpenChange={() => setActivityToComplete(null)}
      >
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Completar actividad</AlertDialogTitle>
            <AlertDialogDescription>
              Marcar esta actividad como completada.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isCompleting}>Cancelar</AlertDialogCancel>
            <AlertDialogAction onClick={handleComplete} disabled={isCompleting}>
              {isCompleting ? 'Completando...' : 'Completar'}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
</file>

<file path="src/components/crm/deal-card.tsx">
'use client';

import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { Card, CardContent } from '@/components/ui/card';
import { Building2, User, TrendingUp } from 'lucide-react';
import Link from 'next/link';

interface Deal {
  id: string;
  title: string;
  value_eur: number | null;
  probability: number;
  account: {
    id: string;
    name: string;
  };
  contact?: {
    id: string;
    first_name: string;
    last_name: string;
  } | null;
  owner?: {
    id: string;
    first_name: string;
    last_name: string;
  } | null;
}

interface Props {
  deal: Deal;
  isDragging?: boolean;
}

export default function DealCard({ deal, isDragging = false }: Props) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging: isSortableDragging,
  } = useSortable({ id: deal.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isSortableDragging ? 0.5 : 1,
  };

  const formatCurrency = (value: number | null) => {
    if (!value) return '-';
    return new Intl.NumberFormat('es-ES', {
      style: 'currency',
      currency: 'EUR',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(value);
  };

  return (
    <Card
      ref={setNodeRef}
      style={style}
      {...attributes}
      {...listeners}
      className={`cursor-grab active:cursor-grabbing hover:shadow-md transition-shadow ${
        isDragging ? 'shadow-lg' : ''
      }`}
    >
      <CardContent className="p-3 space-y-2">
        <Link
          href={`/dashboard/crm/deals/${deal.id}`}
          className="font-medium text-sm hover:underline line-clamp-2"
          onClick={(e) => e.stopPropagation()}
        >
          {deal.title}
        </Link>

        {deal.value_eur && (
          <div className="flex items-center gap-1 text-sm font-semibold text-green-600">
            <TrendingUp className="h-3 w-3" />
            {formatCurrency(deal.value_eur)}
          </div>
        )}

        <div className="flex items-center gap-1 text-xs text-muted-foreground">
          <Building2 className="h-3 w-3" />
          <span className="truncate">{deal.account.name}</span>
        </div>

        {deal.contact && (
          <div className="flex items-center gap-1 text-xs text-muted-foreground">
            <User className="h-3 w-3" />
            <span className="truncate">
              {deal.contact.first_name} {deal.contact.last_name}
            </span>
          </div>
        )}

        {deal.owner && (
          <div className="text-xs text-muted-foreground">
            Owner: {deal.owner.first_name} {deal.owner.last_name}
          </div>
        )}

        <div className="flex items-center justify-between text-xs">
          <span className="text-muted-foreground">Probabilidad</span>
          <span className="font-medium">{deal.probability}%</span>
        </div>
      </CardContent>
    </Card>
  );
}
</file>

<file path="src/components/crm/deal-form.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { dealSchema, type DealFormValues } from '@/lib/validations/deal';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

interface Account {
  id: string;
  name: string;
}

interface Contact {
  id: string;
  first_name: string;
  last_name: string;
  email: string;
}

interface Stage {
  id: string;
  key: string;
  label: string;
}

interface User {
  id: string;
  first_name: string;
  last_name: string;
}

interface Props {
  deal?: any;
  accounts: Account[];
  contacts: Contact[];
  stages: Stage[];
  users: User[];
}

export default function DealForm({ deal, accounts, contacts, stages, users }: Props) {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<DealFormValues>({
    resolver: zodResolver(dealSchema),
    defaultValues: {
      title: deal?.title || '',
      account: deal?.account?.id || '',
      contact: deal?.contact?.id || '',
      owner: deal?.owner?.id || '',
      stage: deal?.stage?.id || '',
      value_eur: deal?.value_eur || null,
      probability: deal?.probability || 50,
      expected_close_date: deal?.expected_close_date || '',
      notes: deal?.notes || '',
    },
  });

  const onSubmit = async (data: DealFormValues) => {
    setIsLoading(true);

    try {
      const url = deal
        ? `/api/crm/deals/${deal.id}`
        : '/api/crm/deals';

      const method = deal ? 'PATCH' : 'POST';

      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      if (!response.ok) {
        throw new Error('Error al guardar el deal');
      }

      toast.success(
        deal ? 'Deal actualizado' : 'Deal creado',
        {
          description: deal
            ? 'El deal se ha actualizado correctamente'
            : 'El deal se ha creado correctamente',
        }
      );

      router.push('/dashboard/crm/deals');
      router.refresh();
    } catch (error) {
      toast.error('Error', {
        description: 'Ha ocurrido un error al guardar el deal',
      });
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
        {/* Informacion basica */}
        <Card>
          <CardHeader>
            <CardTitle>Informacion basica</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="title"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Titulo *</FormLabel>
                  <FormControl>
                    <Input {...field} placeholder="Ej: Campana de marketing Q1" />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="grid gap-4 md:grid-cols-2">
              <FormField
                control={form.control}
                name="account"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Cuenta *</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona una cuenta" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {accounts.map((account) => (
                          <SelectItem key={account.id} value={account.id}>
                            {account.name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="contact"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Contacto</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona un contacto" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {contacts.map((contact) => (
                          <SelectItem key={contact.id} value={contact.id}>
                            {contact.first_name} {contact.last_name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="stage"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Stage *</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona un stage" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {stages.map((stage) => (
                          <SelectItem key={stage.id} value={stage.id}>
                            {stage.label}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="owner"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Owner</FormLabel>
                    <Select onValueChange={field.onChange} defaultValue={field.value}>
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Selecciona un owner" />
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent>
                        {users.map((user) => (
                          <SelectItem key={user.id} value={user.id}>
                            {user.first_name} {user.last_name}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
          </CardContent>
        </Card>

        {/* Detalles financieros */}
        <Card>
          <CardHeader>
            <CardTitle>Detalles financieros</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid gap-4 md:grid-cols-3">
              <FormField
                control={form.control}
                name="value_eur"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Valor (EUR)</FormLabel>
                    <FormControl>
                      <Input
                        {...field}
                        type="number"
                        value={field.value || ''}
                        onChange={(e) =>
                          field.onChange(
                            e.target.value ? parseInt(e.target.value) : null
                          )
                        }
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="probability"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Probabilidad (%)</FormLabel>
                    <FormControl>
                      <Input
                        {...field}
                        type="number"
                        min="0"
                        max="100"
                        value={field.value || ''}
                        onChange={(e) =>
                          field.onChange(
                            e.target.value ? parseInt(e.target.value) : null
                          )
                        }
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <FormField
                control={form.control}
                name="expected_close_date"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Fecha de cierre esperada</FormLabel>
                    <FormControl>
                      <Input {...field} type="date" />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </div>
          </CardContent>
        </Card>

        {/* Notas */}
        <Card>
          <CardHeader>
            <CardTitle>Notas</CardTitle>
          </CardHeader>
          <CardContent>
            <FormField
              control={form.control}
              name="notes"
              render={({ field }) => (
                <FormItem>
                  <FormControl>
                    <Textarea {...field} rows={4} />
                  </FormControl>
                  <FormMessage />
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        {/* Botones */}
        <div className="flex items-center gap-4">
          <Button type="submit" disabled={isLoading}>
            {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
            {deal ? 'Actualizar deal' : 'Crear deal'}
          </Button>
          <Button
            type="button"
            variant="outline"
            onClick={() => router.back()}
            disabled={isLoading}
          >
            Cancelar
          </Button>
        </div>
      </form>
    </Form>
  );
}
</file>

<file path="src/components/crm/deal-header.tsx">
'use client';

import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Building2, User, Calendar, TrendingUp, Mail, Phone, Edit } from 'lucide-react';
import Link from 'next/link';

interface Deal {
  id: string;
  title: string;
  value_eur: number | null;
  probability: number;
  expected_close_date: string | null;
  account: {
    id: string;
    name: string;
    website?: string | null;
    phone?: string | null;
    email?: string | null;
  };
  contact?: {
    id: string;
    first_name: string;
    last_name: string;
    email?: string | null;
    phone?: string | null;
  } | null;
  owner?: {
    id: string;
    first_name: string;
    last_name: string;
    email?: string | null;
  } | null;
  stage: {
    id: string;
    key: string;
    label: string;
  };
  date_created: string;
}

interface Props {
  deal: Deal;
}

export default function DealHeader({ deal }: Props) {
  const formatCurrency = (value: number | null) => {
    if (!value) return '-';
    return new Intl.NumberFormat('es-ES', {
      style: 'currency',
      currency: 'EUR',
    }).format(value);
  };

  const getStageColor = (key: string) => {
    const colors: Record<string, string> = {
      lead: 'bg-gray-100 text-gray-800',
      qualified: 'bg-blue-100 text-blue-800',
      proposal: 'bg-purple-100 text-purple-800',
      negotiation: 'bg-orange-100 text-orange-800',
      won: 'bg-green-100 text-green-800',
      lost: 'bg-red-100 text-red-800',
    };
    return colors[key] || 'bg-gray-100 text-gray-800';
  };

  return (
    <div className="space-y-4">
      {/* Titulo y acciones */}
      <div className="flex items-start justify-between">
        <div>
          <h1 className="text-3xl font-bold">{deal.title}</h1>
          <div className="mt-2 flex items-center gap-2">
            <Badge variant="secondary" className={getStageColor(deal.stage.key)}>
              {deal.stage.label}
            </Badge>
          </div>
        </div>
        <Button asChild>
          <Link href={`/dashboard/crm/deals/${deal.id}/edit`}>
            <Edit className="mr-2 h-4 w-4" />
              Editar
            </Link>
        </Button>
      </div>

      {/* Metricas principales */}
      <div className="grid gap-4 md:grid-cols-4">
        <div className="rounded-lg border p-4">
          <div className="flex items-center gap-2 text-sm text-muted-foreground">
            <TrendingUp className="h-4 w-4" />
            <span>Valor</span>
          </div>
          <div className="mt-2 text-2xl font-bold">
            {formatCurrency(deal.value_eur)}
          </div>
        </div>

        <div className="rounded-lg border p-4">
          <div className="text-sm text-muted-foreground">Probabilidad</div>
          <div className="mt-2 text-2xl font-bold">{deal.probability}%</div>
        </div>

        <div className="rounded-lg border p-4">
          <div className="flex items-center gap-2 text-sm text-muted-foreground">
            <Calendar className="h-4 w-4" />
            <span>Cierre esperado</span>
          </div>
          <div className="mt-2 text-lg font-semibold">
            {deal.expected_close_date
              ? new Date(deal.expected_close_date).toLocaleDateString('es-ES', {
                  day: 'numeric',
                  month: 'short',
                  year: 'numeric',
                })
              : '-'}
          </div>
        </div>

        <div className="rounded-lg border p-4">
          <div className="text-sm text-muted-foreground">Owner</div>
          <div className="mt-2 text-lg font-semibold">
            {deal.owner
              ? `${deal.owner.first_name} ${deal.owner.last_name}`
              : '-'}
          </div>
        </div>
      </div>

      {/* Informacion de cuenta y contacto */}
      <div className="grid gap-4 md:grid-cols-2">
        {/* Cuenta */}
        <div className="rounded-lg border p-4">
          <div className="flex items-center gap-2 mb-3">
            <Building2 className="h-5 w-5 text-muted-foreground" />
            <h3 className="font-semibold">Cuenta</h3>
          </div>
          <div className="space-y-2">
            <div>
              <Link
                href={`/dashboard/crm/accounts/${deal.account.id}`}
                className="text-lg font-medium hover:underline"
              >
                {deal.account.name}
              </Link>
            </div>
            {deal.account.email && (
              <div className="flex items-center gap-2 text-sm text-muted-foreground">
                <Mail className="h-4 w-4" />
                <a href={`mailto:${deal.account.email}`} className="hover:underline">
                  {deal.account.email}
                </a>
              </div>
            )}
            {deal.account.phone && (
              <div className="flex items-center gap-2 text-sm text-muted-foreground">
                <Phone className="h-4 w-4" />
                <a href={`tel:${deal.account.phone}`} className="hover:underline">
                  {deal.account.phone}
                </a>
              </div>
            )}
          </div>
        </div>

        {/* Contacto */}
        <div className="rounded-lg border p-4">
          <div className="flex items-center gap-2 mb-3">
            <User className="h-5 w-5 text-muted-foreground" />
            <h3 className="font-semibold">Contacto</h3>
          </div>
          {deal.contact ? (
            <div className="space-y-2">
              <div>
                <Link
                  href={`/dashboard/crm/contacts/${deal.contact.id}`}
                  className="text-lg font-medium hover:underline"
                >
                  {deal.contact.first_name} {deal.contact.last_name}
                </Link>
              </div>
              {deal.contact.email && (
                <div className="flex items-center gap-2 text-sm text-muted-foreground">
                  <Mail className="h-4 w-4" />
                  <a href={`mailto:${deal.contact.email}`} className="hover:underline">
                    {deal.contact.email}
                  </a>
                </div>
              )}
              {deal.contact.phone && (
                <div className="flex items-center gap-2 text-sm text-muted-foreground">
                  <Phone className="h-4 w-4" />
                  <a href={`tel:${deal.contact.phone}`} className="hover:underline">
                    {deal.contact.phone}
                  </a>
                </div>
              )}
            </div>
          ) : (
            <p className="text-sm text-muted-foreground">Sin contacto asignado</p>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/crm/deal-items-manager.tsx">
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Plus, Trash2, Edit } from 'lucide-react';
import { toast } from 'sonner';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import AddDealItemDialog from './add-deal-item-dialog';

interface DealItem {
  id: string;
  package: {
    id: string;
    name: string;
  };
  quantity: number;
  unit_price: number | null;
  notes?: string | null;
}

interface ServicePackage {
  id: string;
  name: string;
  base_price: number | null;
}

interface Props {
  dealId: string;
  dealItems: DealItem[];
  servicePackages: ServicePackage[];
}

export default function DealItemsManager({ dealId, dealItems, servicePackages }: Props) {
  const router = useRouter();
  const [itemToDelete, setItemToDelete] = useState<string | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const handleDelete = async () => {
    if (!itemToDelete) return;

    setIsDeleting(true);
    try {
      const response = await fetch(`/api/crm/deal-items/${itemToDelete}`, {
        method: 'DELETE',
      });

      if (!response.ok) {
        throw new Error('Error al eliminar el item');
      }

      toast.success('Item eliminado', {
        description: 'El item se ha eliminado correctamente',
      });

      router.refresh();
    } catch (error) {
      toast.error('Error', {
        description: 'Ha ocurrido un error al eliminar el item',
      });
    } finally {
      setIsDeleting(false);
      setItemToDelete(null);
    }
  };

  const formatCurrency = (value: number | null) => {
    if (!value) return '-';
    return new Intl.NumberFormat('es-ES', {
      style: 'currency',
      currency: 'EUR',
    }).format(value);
  };

  const calculateTotal = () => {
    return dealItems.reduce((sum, item) => {
      const price = item.unit_price || 0;
      const qty = item.quantity || 1;
      return sum + price * qty;
    }, 0);
  };

  return (
    <>
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <CardTitle>Servicios y productos</CardTitle>
            <AddDealItemDialog dealId={dealId} servicePackages={servicePackages} />
          </div>
        </CardHeader>
        <CardContent>
          {dealItems.length > 0 ? (
            <div className="space-y-4">
              <div className="divide-y">
                {dealItems.map((item) => (
                  <div key={item.id} className="py-4 first:pt-0 last:pb-0">
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <h4 className="font-medium">{item.package.name}</h4>
                        {item.notes && (
                          <p className="text-sm text-muted-foreground mt-1">
                            {item.notes}
                          </p>
                        )}
                      </div>
                      <div className="flex items-center gap-4">
                        <div className="text-right">
                          <div className="font-semibold">
                            {formatCurrency(item.unit_price)}
                          </div>
                          <div className="text-sm text-muted-foreground">
                            Cantidad: {item.quantity}
                          </div>
                          <div className="text-sm font-medium mt-1">
                            Total: {formatCurrency((item.unit_price || 0) * item.quantity)}
                          </div>
                        </div>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => setItemToDelete(item.id)}
                        >
                          <Trash2 className="h-4 w-4 text-destructive" />
                        </Button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
              <div className="border-t pt-4 flex items-center justify-between">
                <span className="font-semibold">Total</span>
                <span className="text-xl font-bold">
                  {formatCurrency(calculateTotal())}
                </span>
              </div>
            </div>
          ) : (
            <div className="text-center py-8 text-muted-foreground">
              No hay items en este deal
            </div>
          )}
        </CardContent>
      </Card>

      {/* Dialog de confirmacion */}
      <AlertDialog open={!!itemToDelete} onOpenChange={() => setItemToDelete(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Eliminar item</AlertDialogTitle>
            <AlertDialogDescription>
              Esta accion eliminara el item del deal. Esta accion no se puede deshacer.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel disabled={isDeleting}>Cancelar</AlertDialogCancel>
            <AlertDialogAction
              onClick={handleDelete}
              disabled={isDeleting}
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
            >
              {isDeleting ? 'Eliminando...' : 'Eliminar'}
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
</file>

<file path="src/components/crm/deals-cards.tsx">
'use client';

import Link from 'next/link';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Building2, User, Calendar, TrendingUp } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns';
import { es } from 'date-fns/locale';
import type { DealWithRelations } from '@/types/crm';

interface Props {
  deals: DealWithRelations[];
}

export default function DealsCards({ deals }: Props) {
  const formatCurrency = (value: number | null) => {
    if (!value) return '‚Äî';
    return new Intl.NumberFormat('es-ES', {
      style: 'currency',
      currency: 'EUR',
      minimumFractionDigits: 0,
    }).format(value);
  };

  const getStageColor = (key: string) => {
    const colors: Record<string, string> = {
      lead: 'bg-gray-100 text-gray-800',
      qualified: 'bg-blue-100 text-blue-800',
      proposal: 'bg-purple-100 text-purple-800',
      negotiation: 'bg-orange-100 text-orange-800',
      won: 'bg-green-100 text-green-800',
      lost: 'bg-red-100 text-red-800',
    };
    return colors[key] || 'bg-gray-100 text-gray-800';
  };

  if (deals.length === 0) {
    return (
      <div className="flex h-[400px] items-center justify-center rounded-lg border border-dashed">
        <div className="text-center">
          <h3 className="text-lg font-semibold">No hay deals</h3>
          <p className="text-sm text-muted-foreground">
            Crea tu primer deal para empezar
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
      {deals.map((deal) => (
        <Link key={deal.id} href={`/dashboard/crm/deals/${deal.id}`}>
          <Card className="hover:shadow-md transition-shadow cursor-pointer h-full">
            <CardHeader className="pb-3">
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <h3 className="font-semibold line-clamp-1">{deal.title}</h3>
                  <p className="text-sm text-muted-foreground mt-1">
                    {formatDistanceToNow(new Date(deal.date_created), {
                      addSuffix: true,
                      locale: es,
                    })}
                  </p>
                </div>
                <Badge
                  variant="secondary"
                  className={getStageColor(deal.stage.key)}
                >
                  {deal.stage.label}
                </Badge>
              </div>
            </CardHeader>
            <CardContent className="space-y-3">
              {/* Valor y probabilidad */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <TrendingUp className="h-4 w-4 text-muted-foreground" />
                  <span className="text-lg font-semibold">
                    {formatCurrency(deal.value_eur)}
                  </span>
                </div>
                <span className="text-sm text-muted-foreground">
                  {deal.probability}%
                </span>
              </div>

              {/* Cuenta */}
              <div className="flex items-center gap-2 text-sm">
                <Building2 className="h-4 w-4 text-muted-foreground" />
                <span className="truncate">{deal.account.name}</span>
              </div>

              {/* Contacto */}
              {deal.contact && (
                <div className="flex items-center gap-2 text-sm text-muted-foreground">
                  <User className="h-4 w-4" />
                  <span className="truncate">
                    {deal.contact.first_name} {deal.contact.last_name}
                  </span>
                </div>
              )}

              {/* Fecha esperada de cierre */}
              {deal.expected_close_date && (
                <div className="flex items-center gap-2 text-sm text-muted-foreground">
                  <Calendar className="h-4 w-4" />
                  <span>
                    {new Date(deal.expected_close_date).toLocaleDateString(
                      'es-ES',
                      {
                        day: 'numeric',
                        month: 'short',
                        year: 'numeric',
                      }
                    )}
                  </span>
                </div>
              )}

              {/* Owner */}
              {deal.owner && (
                <div className="pt-2 border-t text-sm text-muted-foreground">
                  Owner: {deal.owner.first_name} {deal.owner.last_name}
                </div>
              )}
            </CardContent>
          </Card>
        </Link>
      ))}
    </div>
  );
}
</file>

<file path="src/components/crm/deals-list-client.tsx">
'use client';

import { useState, useMemo } from 'react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { LayoutGrid, TableIcon, Plus, Search } from 'lucide-react';
import Link from 'next/link';
import DealsTable from './deals-table';
import DealsCards from './deals-cards';
import type { DealWithRelations, DealStage } from '@/types/crm';

interface Owner {
  id: string;
  first_name: string;
  last_name: string;
}

interface Account {
  id: string;
  name: string;
}

interface Props {
  deals: DealWithRelations[];
  stages: DealStage[];
  owners: Owner[];
  accounts: Account[];
}

export default function DealsListClient({
  deals,
  stages,
  owners,
  accounts,
}: Props) {
  const [view, setView] = useState<'table' | 'cards'>('table');
  const [search, setSearch] = useState('');
  const [stageFilter, setStageFilter] = useState<string>('all');
  const [ownerFilter, setOwnerFilter] = useState<string>('all');
  const [accountFilter, setAccountFilter] = useState<string>('all');
  const [sortBy, setSortBy] = useState<string>('date_desc');

  // Filtrado y ordenamiento
  const filteredDeals = useMemo(() => {
    let filtered = [...deals];

    // B√∫squeda
    if (search) {
      filtered = filtered.filter((deal) =>
        deal.title.toLowerCase().includes(search.toLowerCase())
      );
    }

    // Filtro por stage
    if (stageFilter !== 'all') {
      filtered = filtered.filter((deal) => deal.stage.id === stageFilter);
    }

    // Filtro por owner
    if (ownerFilter !== 'all') {
      filtered = filtered.filter((deal) => deal.owner?.id === ownerFilter);
    }

    // Filtro por account
    if (accountFilter !== 'all') {
      filtered = filtered.filter((deal) => deal.account.id === accountFilter);
    }

    // Ordenamiento
    switch (sortBy) {
      case 'date_desc':
        filtered.sort(
          (a, b) =>
            new Date(b.date_created).getTime() -
            new Date(a.date_created).getTime()
        );
        break;
      case 'date_asc':
        filtered.sort(
          (a, b) =>
            new Date(a.date_created).getTime() -
            new Date(b.date_created).getTime()
        );
        break;
      case 'value_desc':
        filtered.sort((a, b) => (b.value_eur || 0) - (a.value_eur || 0));
        break;
      case 'value_asc':
        filtered.sort((a, b) => (a.value_eur || 0) - (b.value_eur || 0));
        break;
      case 'title_asc':
        filtered.sort((a, b) => a.title.localeCompare(b.title));
        break;
      case 'title_desc':
        filtered.sort((a, b) => b.title.localeCompare(a.title));
        break;
    }

    return filtered;
  }, [deals, search, stageFilter, ownerFilter, accountFilter, sortBy]);

  return (
    <div className="space-y-6">

      {/* Filtros y b√∫squeda */}
      <div className="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between">
        <div className="flex flex-1 gap-4">
          {/* B√∫squeda */}
          <div className="relative flex-1 max-w-sm">
            <Search className="absolute left-3 top-3 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="Buscar deals..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-9"
            />
          </div>

          {/* Filtros */}
          <Select value={stageFilter} onValueChange={setStageFilter}>
            <SelectTrigger className="w-[180px]">
              <SelectValue placeholder="Stage" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Todos los stages</SelectItem>
              {stages.map((stage) => (
                <SelectItem key={stage.id} value={stage.id}>
                  {stage.label}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>

          <Select value={ownerFilter} onValueChange={setOwnerFilter}>
            <SelectTrigger className="w-[180px]">
              <SelectValue placeholder="Owner" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Todos los owners</SelectItem>
              {owners.map((owner) => (
                <SelectItem key={owner.id} value={owner.id}>
                  {owner.first_name} {owner.last_name}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>

          <Select value={accountFilter} onValueChange={setAccountFilter}>
            <SelectTrigger className="w-[180px]">
              <SelectValue placeholder="Account" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Todas las cuentas</SelectItem>
              {accounts.map((account) => (
                <SelectItem key={account.id} value={account.id}>
                  {account.name}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        {/* Ordenamiento y vista */}
        <div className="flex items-center gap-2">
          <Select value={sortBy} onValueChange={setSortBy}>
            <SelectTrigger className="w-[180px]">
              <SelectValue placeholder="Ordenar por" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="date_desc">M√°s recientes</SelectItem>
              <SelectItem value="date_asc">M√°s antiguos</SelectItem>
              <SelectItem value="value_desc">Valor (mayor)</SelectItem>
              <SelectItem value="value_asc">Valor (menor)</SelectItem>
              <SelectItem value="title_asc">T√≠tulo (A-Z)</SelectItem>
              <SelectItem value="title_desc">T√≠tulo (Z-A)</SelectItem>
            </SelectContent>
          </Select>

          <div className="flex rounded-md border">
            <Button
              variant={view === 'table' ? 'secondary' : 'ghost'}
              size="sm"
              onClick={() => setView('table')}
              className="rounded-r-none"
            >
              <TableIcon className="h-4 w-4" />
            </Button>
            <Button
              variant={view === 'cards' ? 'secondary' : 'ghost'}
              size="sm"
              onClick={() => setView('cards')}
              className="rounded-l-none"
            >
              <LayoutGrid className="h-4 w-4" />
            </Button>
          </div>
        </div>
      </div>

      {/* Resultados */}
      <div className="text-sm text-muted-foreground">
        {filteredDeals.length} deal{filteredDeals.length !== 1 ? 's' : ''}
      </div>

      {/* Vista tabla o cards */}
      {view === 'table' ? (
        <DealsTable deals={filteredDeals} />
        //<div>Vista tabla (pendiente)</div>
      ) : (
        <DealsCards deals={filteredDeals} />
        //<div>Vista cards (pendiente)</div>
      )}
    </div>
  );
}
</file>

<file path="src/components/crm/deals-pipeline.tsx">
'use client';

import { useState, useMemo } from 'react';
import { useRouter } from 'next/navigation';
import {
  DndContext,
  DragEndEvent,
  DragOverlay,
  DragStartEvent,
  PointerSensor,
  useSensor,
  useSensors,
  closestCenter,
} from '@dnd-kit/core';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import DealCard from './deal-card';
import DroppableColumn from './droppable-column';
import { toast } from 'sonner';

interface Stage {
  id: string;
  key: string;
  label: string;
}

interface Deal {
  id: string;
  title: string;
  value_eur: number | null;
  probability: number;
  stage: {
    id: string;
    key: string;
    label: string;
  };
  account: {
    id: string;
    name: string;
  };
  contact?: {
    id: string;
    first_name: string;
    last_name: string;
  } | null;
  owner?: {
    id: string;
    first_name: string;
    last_name: string;
  } | null;
}

interface Owner {
  id: string;
  first_name: string;
  last_name: string;
}

interface Account {
  id: string;
  name: string;
}

interface Props {
  stages: Stage[];
  deals: Deal[];
  owners: Owner[];
  accounts: Account[];
}

export default function DealsPipeline({ stages, deals, owners, accounts }: Props) {
  const router = useRouter();
  const [activeDeal, setActiveDeal] = useState<Deal | null>(null);
  const [ownerFilter, setOwnerFilter] = useState<string>('all');
  const [accountFilter, setAccountFilter] = useState<string>('all');

  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8,
      },
    })
  );

  // Filtrar deals
  const filteredDeals = useMemo(() => {
    return deals.filter((deal) => {
      if (ownerFilter !== 'all' && deal.owner?.id !== ownerFilter) return false;
      if (accountFilter !== 'all' && deal.account.id !== accountFilter) return false;
      return true;
    });
  }, [deals, ownerFilter, accountFilter]);

  // Agrupar deals por stage
  const dealsByStage = useMemo(() => {
    const grouped: Record<string, Deal[]> = {};
    stages.forEach((stage) => {
      grouped[stage.id] = filteredDeals.filter(
        (deal) => deal.stage.id === stage.id
      );
    });
    return grouped;
  }, [stages, filteredDeals]);

  // Calcular totales por stage
  const stageValues = useMemo(() => {
    const values: Record<string, number> = {};
    stages.forEach((stage) => {
      values[stage.id] = dealsByStage[stage.id]?.reduce(
        (sum, deal) => sum + (deal.value_eur || 0),
        0
      ) || 0;
    });
    return values;
  }, [stages, dealsByStage]);

  const handleDragStart = (event: DragStartEvent) => {
    const deal = filteredDeals.find((d) => d.id === event.active.id);
    setActiveDeal(deal || null);
  };

  const handleDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;
    setActiveDeal(null);

    if (!over) return;

    const dealId = active.id as string;
    const newStageId = over.id as string;

    const deal = deals.find((d) => d.id === dealId);
    if (!deal || deal.stage.id === newStageId) return;

    try {
      const response = await fetch(`/api/crm/deals/${dealId}/stage`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ stage: newStageId }),
      });

      if (!response.ok) {
        throw new Error('Error al actualizar el stage');
      }

      toast.success('Stage actualizado', {
        description: `El deal se ha movido correctamente`,
      });

      router.refresh();
    } catch (error) {
      toast.error('Error', {
        description: 'Ha ocurrido un error al actualizar el stage',
      });
    }
  };

  const formatCurrency = (value: number) => {
    return new Intl.NumberFormat('es-ES', {
      style: 'currency',
      currency: 'EUR',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(value);
  };

  return (
    <div className="space-y-6">
      {/* Filtros */}
      <Card>
        <CardContent className="pt-6">
          <div className="flex items-center gap-4">
            <div className="flex-1">
              <Select value={ownerFilter} onValueChange={setOwnerFilter}>
                <SelectTrigger>
                  <SelectValue placeholder="Filtrar por owner" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos los owners</SelectItem>
                  {owners.map((owner) => (
                    <SelectItem key={owner.id} value={owner.id}>
                      {owner.first_name} {owner.last_name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="flex-1">
              <Select value={accountFilter} onValueChange={setAccountFilter}>
                <SelectTrigger>
                  <SelectValue placeholder="Filtrar por cuenta" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todas las cuentas</SelectItem>
                  {accounts.map((account) => (
                    <SelectItem key={account.id} value={account.id}>
                      {account.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            {(ownerFilter !== 'all' || accountFilter !== 'all') && (
              <Button
                variant="outline"
                onClick={() => {
                  setOwnerFilter('all');
                  setAccountFilter('all');
                }}
              >
                Limpiar filtros
              </Button>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Pipeline */}
      <DndContext
        sensors={sensors}
        collisionDetection={closestCenter}
        onDragStart={handleDragStart}
        onDragEnd={handleDragEnd}
      >
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-4">
          {stages.map((stage) => (
            <DroppableColumn key={stage.id} id={stage.id}>
              <Card className="flex flex-col h-full">
                <CardHeader className="pb-3">
                  <div className="space-y-2">
                    <CardTitle className="text-base">{stage.label}</CardTitle>
                    <div className="flex items-center justify-between text-sm">
                      <Badge variant="secondary">
                        {dealsByStage[stage.id]?.length || 0}
                      </Badge>
                      <span className="font-semibold">
                        {formatCurrency(stageValues[stage.id])}
                      </span>
                    </div>
                  </div>
                </CardHeader>
                <CardContent className="flex-1 overflow-y-auto space-y-2 min-h-[200px]">
                  {dealsByStage[stage.id]?.map((deal) => (
                    <DealCard key={deal.id} deal={deal} />
                  ))}
                  {(!dealsByStage[stage.id] || dealsByStage[stage.id].length === 0) && (
                    <div className="text-center py-8 text-sm text-muted-foreground">
                      Arrastra deals aqui
                    </div>
                  )}
                </CardContent>
              </Card>
            </DroppableColumn>
          ))}
        </div>

        <DragOverlay>
          {activeDeal ? <DealCard deal={activeDeal} isDragging /> : null}
        </DragOverlay>
      </DndContext>
    </div>
  );
}
</file>

<file path="src/components/crm/deals-table.tsx">
'use client';

import Link from 'next/link';
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { formatDistanceToNow } from 'date-fns';
import { es } from 'date-fns/locale';
import type { DealWithRelations } from '@/types/crm';

interface Props {
  deals: DealWithRelations[];
}

export default function DealsTable({ deals }: Props) {
  const formatCurrency = (value: number | null) => {
    if (!value) return '‚Äî';
    return new Intl.NumberFormat('es-ES', {
      style: 'currency',
      currency: 'EUR',
    }).format(value);
  };

  const getStageColor = (key: string) => {
    const colors: Record<string, string> = {
      lead: 'bg-gray-100 text-gray-800',
      qualified: 'bg-blue-100 text-blue-800',
      proposal: 'bg-purple-100 text-purple-800',
      negotiation: 'bg-orange-100 text-orange-800',
      won: 'bg-green-100 text-green-800',
      lost: 'bg-red-100 text-red-800',
    };
    return colors[key] || 'bg-gray-100 text-gray-800';
  };

  if (deals.length === 0) {
    return (
      <div className="flex h-[400px] items-center justify-center rounded-lg border border-dashed">
        <div className="text-center">
          <h3 className="text-lg font-semibold">No hay deals</h3>
          <p className="text-sm text-muted-foreground">
            Crea tu primer deal para empezar
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="rounded-md border">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>T√≠tulo</TableHead>
            <TableHead>Cuenta</TableHead>
            <TableHead>Contacto</TableHead>
            <TableHead>Stage</TableHead>
            <TableHead className="text-right">Valor</TableHead>
            <TableHead className="text-right">Probabilidad</TableHead>
            <TableHead>Owner</TableHead>
            <TableHead>Creado</TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {deals.map((deal) => (
            <TableRow key={deal.id}>
              <TableCell>
                <Link
                  href={`/dashboard/crm/deals/${deal.id}`}
                  className="font-medium hover:underline"
                >
                  {deal.title}
                </Link>
              </TableCell>
              <TableCell>
                <Link
                  href={`/dashboard/crm/accounts/${deal.account.id}`}
                  className="text-sm text-muted-foreground hover:underline"
                >
                  {deal.account.name}
                </Link>
              </TableCell>
              <TableCell>
                {deal.contact ? (
                  <Link
                    href={`/dashboard/crm/contacts/${deal.contact.id}`}
                    className="text-sm text-muted-foreground hover:underline"
                  >
                    {deal.contact.first_name} {deal.contact.last_name}
                  </Link>
                ) : (
                  <span className="text-sm text-muted-foreground">‚Äî</span>
                )}
              </TableCell>
              <TableCell>
                <Badge
                  variant="secondary"
                  className={getStageColor(deal.stage.key)}
                >
                  {deal.stage.label}
                </Badge>
              </TableCell>
              <TableCell className="text-right">
                {formatCurrency(deal.value_eur)}
              </TableCell>
              <TableCell className="text-right">
                {deal.probability}%
              </TableCell>
              <TableCell>
                {deal.owner ? (
                  <span className="text-sm">
                    {deal.owner.first_name} {deal.owner.last_name}
                  </span>
                ) : (
                  <span className="text-sm text-muted-foreground">‚Äî</span>
                )}
              </TableCell>
              <TableCell className="text-sm text-muted-foreground">
                {formatDistanceToNow(new Date(deal.date_created), {
                  addSuffix: true,
                  locale: es,
                })}
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
}
</file>

<file path="src/components/crm/droppable-column.tsx">
'use client';

import { useDroppable } from '@dnd-kit/core';

interface Props {
  id: string;
  children: React.ReactNode;
}

export default function DroppableColumn({ id, children }: Props) {
  const { setNodeRef, isOver } = useDroppable({
    id,
  });

  return (
    <div
      ref={setNodeRef}
      className={`transition-all ${isOver ? 'ring-2 ring-primary rounded-lg' : ''}`}
    >
      {children}
    </div>
  );
}
</file>

<file path="src/components/dashboard/dashboard-header.tsx">
'use client';

import { signOut } from 'next-auth/react';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { getInitials } from '@/lib/utils';
import { LogOut, Settings, User } from 'lucide-react';

interface DashboardHeaderProps {
  user: {
    name?: string;
    email?: string;
    image?: string | null;
    role?: string;
  };
}

export default function DashboardHeader({ user }: DashboardHeaderProps) {
  return (
    <header className="bg-white border-b border-gray-200 sticky top-0 z-50">
      <div className="flex items-center justify-between px-6 py-4">
        <div className="flex items-center gap-4">
          <h1 className="text-xl font-bold text-gray-900">Agency OS</h1>
        </div>

        <div className="flex items-center gap-4">
          {/* User menu */}
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" className="relative h-10 w-10 rounded-full">
                <Avatar className="h-10 w-10">
                  <AvatarImage src={user.image || undefined} alt={user.name} />
                  <AvatarFallback>{getInitials(user.name)}</AvatarFallback>
                </Avatar>
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent className="w-56" align="end">
              <DropdownMenuLabel>
                <div className="flex flex-col space-y-1">
                  <p className="text-sm font-medium">{user.name}</p>
                  <p className="text-xs text-gray-500">{user.email}</p>
                  {user.role && (
                    <p className="text-xs text-gray-400">{user.role}</p>
                  )}
                </div>
              </DropdownMenuLabel>
              <DropdownMenuSeparator />
              <DropdownMenuItem>
                <User className="mr-2 h-4 w-4" />
                <span>Perfil</span>
              </DropdownMenuItem>
              <DropdownMenuItem>
                <Settings className="mr-2 h-4 w-4" />
                <span>Configuraci√≥n</span>
              </DropdownMenuItem>
              <DropdownMenuSeparator />
              <DropdownMenuItem
                onClick={() => signOut({ callbackUrl: '/login' })}
                className="text-red-600"
              >
                <LogOut className="mr-2 h-4 w-4" />
                <span>Cerrar sesi√≥n</span>
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </div>
    </header>
  );
}
</file>

<file path="src/components/dashboard/dashboard-nav.tsx">
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { cn } from '@/lib/utils';
import {
  LayoutDashboard,
  Users,
  Briefcase,
  FolderKanban,
  CheckSquare,
  Ticket,
  BookOpen,
  FileText,
  MessageSquare,
} from 'lucide-react';

const navigation = [
  {
    name: 'Dashboard',
    href: '/dashboard',
    icon: LayoutDashboard,
  },
  {
    name: 'CRM',
    icon: Users,
    children: [
      { name: 'Dashboard', href: '/dashboard/crm' },
      { name: 'Cuentas', href: '/dashboard/crm/accounts' },
      { name: 'Contactos', href: '/dashboard/crm/contacts' },
      { name: 'Deals', href: '/dashboard/crm/deals' },
      { name: 'Actividades', href: '/dashboard/crm/activities' },
    ],
  },
  {
    name: 'Proyectos',
    icon: FolderKanban,
    children: [
      { name: 'Todos los proyectos', href: '/dashboard/projects' },
      { name: 'Tareas', href: '/dashboard/projects/tasks' },
      { name: 'Mi trabajo', href: '/dashboard/projects/my-tasks' },
    ],
  },
  {
    name: 'Tickets',
    href: '/dashboard/tickets',
    icon: Ticket,
  },
  {
    name: 'Knowledge Base',
    href: '/dashboard/knowledge-base',
    icon: BookOpen,
  },
  {
    name: 'Docs',
    href: '/dashboard/docs',
    icon: FileText,
  },
  {
    name: 'Chat',
    href: '/dashboard/chat',
    icon: MessageSquare,
  },
];

export default function DashboardNav() {
  const pathname = usePathname();

  return (
    <aside className="w-64 bg-white border-r border-gray-200 min-h-[calc(100vh-73px)]">
      <nav className="p-4 space-y-1">
        {navigation.map((item) => {
          if (item.children) {
            return (
              <div key={item.name} className="space-y-1">
                <div className="flex items-center gap-3 px-3 py-2 text-sm font-medium text-gray-700">
                  <item.icon className="h-5 w-5" />
                  {item.name}
                </div>
                <div className="ml-8 space-y-1">
                  {item.children.map((child) => {
                    const isActive = pathname === child.href;
                    return (
                      <Link
                        key={child.href}
                        href={child.href}
                        className={cn(
                          'block px-3 py-2 text-sm rounded-md transition-colors',
                          isActive
                            ? 'bg-gray-100 text-gray-900 font-medium'
                            : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
                        )}
                      >
                        {child.name}
                      </Link>
                    );
                  })}
                </div>
              </div>
            );
          }

          const isActive = pathname === item.href;
          return (
            <Link
              key={item.href}
              href={item.href}
              className={cn(
                'flex items-center gap-3 px-3 py-2 text-sm rounded-md transition-colors',
                isActive
                  ? 'bg-gray-100 text-gray-900 font-medium'
                  : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
              )}
            >
              <item.icon className="h-5 w-5" />
              {item.name}
            </Link>
          );
        })}
      </nav>
    </aside>
  );
}
</file>

<file path="src/components/providers/session-provider.tsx">
'use client';

import { SessionProvider as NextAuthSessionProvider } from 'next-auth/react';

export default function SessionProvider({
  children,
}: {
  children: React.ReactNode;
}) {
  return <NextAuthSessionProvider>{children}</NextAuthSessionProvider>;
}
</file>

<file path="src/components/ui/alert-dialog.tsx">
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
</file>

<file path="src/components/ui/avatar.tsx">
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }
</file>

<file path="src/components/ui/badge.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }
</file>

<file path="src/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
        "icon-sm": "size-8",
        "icon-lg": "size-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant = "default",
  size = "default",
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      data-variant={variant}
      data-size={size}
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }
</file>

<file path="src/components/ui/card.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}
</file>

<file path="src/components/ui/checkbox.tsx">
"use client"

import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { CheckIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "peer border-input dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator
        data-slot="checkbox-indicator"
        className="grid place-content-center text-current transition-none"
      >
        <CheckIcon className="size-3.5" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  )
}

export { Checkbox }
</file>

<file path="src/components/ui/dialog.tsx">
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content> & {
  showCloseButton?: boolean
}) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 outline-none sm:max-w-lg",
          className
        )}
        {...props}
      >
        {children}
        {showCloseButton && (
          <DialogPrimitive.Close
            data-slot="dialog-close"
            className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4"
          >
            <XIcon />
            <span className="sr-only">Close</span>
          </DialogPrimitive.Close>
        )}
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
</file>

<file path="src/components/ui/dropdown-menu.tsx">
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return (
    <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
  )
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return (
    <DropdownMenuPrimitive.Trigger
      data-slot="dropdown-menu-trigger"
      {...props}
    />
  )
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  )
}

function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}

function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className
      )}
      {...props}
    />
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
</file>

<file path="src/components/ui/form.tsx">
"use client"

import * as React from "react"
import type * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  FormProvider,
  useFormContext,
  useFormState,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState } = useFormContext()
  const formState = useFormState({ name: fieldContext.name })
  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
)

function FormItem({ className, ...props }: React.ComponentProps<"div">) {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div
        data-slot="form-item"
        className={cn("grid gap-2", className)}
        {...props}
      />
    </FormItemContext.Provider>
  )
}

function FormLabel({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  const { error, formItemId } = useFormField()

  return (
    <Label
      data-slot="form-label"
      data-error={!!error}
      className={cn("data-[error=true]:text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
}

function FormControl({ ...props }: React.ComponentProps<typeof Slot>) {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      data-slot="form-control"
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
}

function FormDescription({ className, ...props }: React.ComponentProps<"p">) {
  const { formDescriptionId } = useFormField()

  return (
    <p
      data-slot="form-description"
      id={formDescriptionId}
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function FormMessage({ className, ...props }: React.ComponentProps<"p">) {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message ?? "") : props.children

  if (!body) {
    return null
  }

  return (
    <p
      data-slot="form-message"
      id={formMessageId}
      className={cn("text-destructive text-sm", className)}
      {...props}
    >
      {body}
    </p>
  )
}

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}
</file>

<file path="src/components/ui/input.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }
</file>

<file path="src/components/ui/label.tsx">
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }
</file>

<file path="src/components/ui/select.tsx">
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default"
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "item-aligned",
  align = "center",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        position={position}
        align={align}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className
      )}
      {...props}
    >
      <span
        data-slot="select-item-indicator"
        className="absolute right-2 flex size-3.5 items-center justify-center"
      >
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  )
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  )
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
}
</file>

<file path="src/components/ui/sonner.tsx">
"use client"

import {
  CircleCheckIcon,
  InfoIcon,
  Loader2Icon,
  OctagonXIcon,
  TriangleAlertIcon,
} from "lucide-react"
import { useTheme } from "next-themes"
import { Toaster as Sonner, type ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      icons={{
        success: <CircleCheckIcon className="size-4" />,
        info: <InfoIcon className="size-4" />,
        warning: <TriangleAlertIcon className="size-4" />,
        error: <OctagonXIcon className="size-4" />,
        loading: <Loader2Icon className="size-4 animate-spin" />,
      }}
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
          "--border-radius": "var(--radius)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }
</file>

<file path="src/components/ui/table.tsx">
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}
</file>

<file path="src/components/ui/tabs.tsx">
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn("flex flex-col gap-2", className)}
      {...props}
    />
  )
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        "bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]",
        className
      )}
      {...props}
    />
  )
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="src/components/ui/textarea.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }
</file>

<file path="src/lib/auth.ts">
import NextAuth from 'next-auth';
import Credentials from 'next-auth/providers/credentials';

const directusUrl = process.env.NEXT_PUBLIC_DIRECTUS_URL!;

interface DirectusUser {
  id: string;
  email: string;
  first_name?: string;
  last_name?: string;
  avatar?: string;
  role?: {
    id: string;
    name: string;
  };
}

export const { handlers, signIn, signOut, auth } = NextAuth({
  providers: [
    Credentials({
      credentials: {
        email: { label: 'Email', type: 'email' },
        password: { label: 'Password', type: 'password' },
      },
      async authorize(credentials) {
        if (!credentials?.email || !credentials?.password) {
          return null;
        }

        try {
          // Login usando fetch directo a Directus
          const loginResponse = await fetch(`${directusUrl}/auth/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              email: credentials.email,
              password: credentials.password,
            }),
          });

          if (!loginResponse.ok) {
            console.error('Login failed:', loginResponse.status);
            return null;
          }

          const authData = await loginResponse.json();
          const accessToken = authData.data?.access_token;

          if (!accessToken) {
            console.error('No access token received');
            return null;
          }

          // Obtener datos del usuario
          const userResponse = await fetch(`${directusUrl}/users/me?fields=*,role.name,role.id`, {
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });

          if (!userResponse.ok) {
            console.error('Failed to get user data');
            return null;
          }

          const userData = await userResponse.json();
          const user: DirectusUser = userData.data;

          return {
            id: user.id,
            email: user.email,
            name: `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.email,
            image: user.avatar ? `${directusUrl}/assets/${user.avatar}` : null,
            role: user.role?.name || null,
            accessToken: accessToken,
          };
        } catch (error) {
          console.error('Auth error:', error);
          return null;
        }
      },
    }),
  ],
  callbacks: {
    async jwt({ token, user }) {
      if (user) {
        token.accessToken = user.accessToken;
        token.role = user.role;
        token.id = user.id;
      }
      return token;
    },
    async session({ session, token }) {
      if (token) {
        session.user.id = token.id as string;
        session.user.role = token.role as string;
        session.accessToken = token.accessToken as string;
      }
      return session;
    },
  },
  pages: {
    signIn: '/login',
  },
  session: {
    strategy: 'jwt',
  },
  secret: process.env.NEXTAUTH_SECRET,
});
</file>

<file path="src/lib/directus.ts">
import { createDirectus, rest, authentication, staticToken } from '@directus/sdk';
import type { DirectusSchema as GeneratedSchema } from '@/types/directus'; // <-- Importar el generado

// Usa el schema generado para el cliente (tiene todos los operadores de filtro correctos)
export const directusServer = createDirectus<GeneratedSchema>(
  process.env.NEXT_PUBLIC_DIRECTUS_URL!
)
  .with(staticToken(process.env.DIRECTUS_ADMIN_TOKEN!))
  .with(rest());

export const directusClient = createDirectus<GeneratedSchema>(
  process.env.NEXT_PUBLIC_DIRECTUS_URL!
)
  .with(authentication('cookie', { credentials: 'include' }))
  .with(rest());

export function createDirectusClient(token?: string) {
  if (token) {
    return createDirectus<GeneratedSchema>(process.env.NEXT_PUBLIC_DIRECTUS_URL!)
      .with(staticToken(token))
      .with(rest());
  }
  return directusClient;
}

// ========== Interfaces detalladas para uso en componentes ==========
// Estas son m√°s espec√≠ficas y mejor documentadas que las generadas
// √ösalas en tus componentes para mejor autocompletado

export interface Account {
  id: string;
  name: string;
  legal_name?: string;
  status?: 'prospect' | 'lead' | 'active' | 'on_hold' | 'inactive';
  email?: string;
  phone?: string;
  website?: string;
  address?: string;
  city?: string;
  zip_code?: string;
  state?: string;
  country?: string;
  tax_id?: string;
  notes?: string;
  account_owner?: string;
  date_created?: string;
  date_updated?: string;
  user_created?: string;
  user_updated?: string;
}

export interface Contact {
  id: string;
  first_name: string;
  last_name?: string;
  email: string;
  phone?: string;
  contact_role?: 'decision_maker' | 'technical' | 'administrative' | 'commercial' | 'other';
  notes?: string;
  date_created?: string;
  date_updated?: string;
}

export interface Deal {
  id: string;
  title: string;
  account: string;
  contact?: string;
  owner?: string;
  stage: string;
  value_eur?: number;
  probability?: number;
  expected_close_date?: string;
  notes?: string;
  date_created?: string;
  date_updated?: string;
}

export interface DealStage {
  id: string;
  key: string;
  label: string;
  sort?: number;
  is_won?: boolean;
  is_lost?: boolean;
  is_active?: boolean;
}

export interface DealItem {
  id: string;
  deal: string;
  package: string;
  quantity?: number;
  unit_price?: number;
  notes?: string;
}

export interface Activity {
  id: string;
  account?: string;
  deal?: string;
  contact?: string;
  owner: string;
  type?: 'call' | 'meeting' | 'email' | 'follow_up' | 'note';
  subject: string;
  description?: string;
  scheduled_at?: string;
  completed_at?: string;
  date_created?: string;
}

export interface Project {
  id: string;
  name: string;
  description?: string;
  account?: string;
  owner?: string;
  status: string;
  package?: string;
  start_date?: string;
  end_date?: string;
  date_created?: string;
  date_updated?: string;
}

export interface Task {
  id: string;
  title: string;
  description?: string;
  project: string;
  status: string;
  priority: string;
  assignee?: string;
  owner?: string;
  parent_task?: string;
  due_date?: string;
  estimated_minutes?: number;
  date_created?: string;
  date_updated?: string;
}

export interface TaskTimeEntry {
  id: string;
  task: string;
  user: string;
  date: string;
  minutes: number;
  notes?: string;
}

export interface Milestone {
  id: string;
  name: string;
  description?: string;
  project: string;
  status: string;
  due_date?: string;
  sort?: number;
}

export interface Ticket {
  id: string;
  subject: string;
  description?: string;
  account?: string;
  requester_contact?: string;
  assigned_to?: string;
  status: string;
  priority: string;
  category?: string;
  package?: string;
  channel?: 'portal' | 'email' | 'phone' | 'whatsapp';
  first_response_at?: string;
  resolved_at?: string;
  last_customer_reply_at?: string;
  last_agent_reply_at?: string;
  date_created?: string;
  date_updated?: string;
}

export interface TicketMessage {
  id: string;
  ticket: string;
  author?: string;
  body: string;
  is_internal?: boolean;
  source?: 'portal' | 'email' | 'phone' | 'whatsapp';
  date_created?: string;
}

export interface TicketCategory {
  id: string;
  key: string;
  label: string;
  sort?: number;
  is_active?: boolean;
}

export interface KBArticle {
  id: string;
  title: string;
  slug: string;
  body: string;
  status: 'draft' | 'published' | 'archived';
  category?: string;
  account?: string;
  services?: string[];
  published_at?: string;
  date_created?: string;
  date_updated?: string;
}

export interface KBCategory {
  id: string;
  key: string;
  label: string;
  status: 'draft' | 'published' | 'archived';
  sort?: number;
  is_active?: boolean;
}

export interface DocsPage {
  id: string;
  title: string;
  slug: string;
  body: string;
  space: string;
  parent_page?: string;
  status: 'draft' | 'published' | 'archived';
  sort?: number;
  date_created?: string;
  date_updated?: string;
}

export interface DocsSpace {
  id: string;
  key: string;
  name: string;
  status: 'draft' | 'published' | 'archived';
  team?: string;
  visibility?: 'all_employees' | 'team_only' | 'admins';
  sort?: number;
  is_active?: boolean;
}

export interface ChatChannel {
  id: string;
  name: string;
  type: 'channel' | 'dm';
  team?: string;
  is_private?: boolean;
  is_active?: boolean;
}

export interface ChatChannelMember {
  id: string;
  channel: string;
  user: string;
  role?: 'member' | 'admin';
  is_muted?: boolean;
}

export interface ChatMessage {
  id: string;
  channel: string;
  sender: string;
  content: string;
  message_type?: 'text' | 'system';
  reply_to?: string;
  is_deleted?: boolean;
  date_created?: string;
}

export interface Service {
  id: string;
  name: string;
  slug: string;
  description?: string;
  is_active?: boolean;
  sort?: number;
}

export interface ServicePackage {
  id: string;
  service: string;
  name: string;
  code: string;
  description?: string;
  base_price?: number;
  billing_model: 'one_time' | 'monthly' | 'quarterly' | 'yearly';
  is_active?: boolean;
  sort?: number;
}

export interface AccountService {
  id: string;
  account: string;
  package: string;
  status: 'active' | 'paused' | 'finished';
  star_date?: string;
  end_date?: string;
  price?: number;
  notes?: string;
}

export interface AccountMember {
  id: string;
  account: string;
  user: string;
  contact?: string;
  job_title?: string;
  role_in_portal?: 'admin' | 'member' | 'readonly';
  is_primary?: boolean;
}

export interface Status {
  id: string;
  key: string;
  label: string;
  scope: 'ticket' | 'project' | 'task' | 'milestone';
  sort?: number;
  is_final?: boolean;
  is_active?: boolean;
}

export interface Priority {
  id: string;
  key: string;
  label: string;
  scope: 'ticket' | 'task';
  sort?: number;
  is_active?: boolean;
}

export interface Team {
  id: string;
  key: string;
  name: string;
  is_active?: boolean;
  sort?: number;
}

export interface TeamMember {
  id: string;
  team: string;
  user: string;
  role?: string;
}

export interface Country {
  id: string;
  code: string;
  name: string;
  is_active?: boolean;
  sort?: number;
}

export interface DirectusUser {
  id: string;
  first_name?: string;
  last_name?: string;
  email: string;
  avatar?: string;
  role?: string;
  status?: string;
}

export interface DirectusFile {
  id: string;
  filename_disk: string;
  filename_download: string;
  title?: string;
  type?: string;
  filesize?: number;
  uploaded_on?: string;
}
</file>

<file path="src/lib/utils.ts">
import { type ClassValue, clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';
import { format, formatDistanceToNow } from 'date-fns';
import { es } from 'date-fns/locale';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}

// Formateo de fechas
export function formatDate(date: string | Date | undefined, formatStr: string = 'PPP'): string {
  if (!date) return '';
  const dateObj = typeof date === 'string' ? new Date(date) : date;
  return format(dateObj, formatStr, { locale: es });
}

export function formatRelativeTime(date: string | Date | undefined): string {
  if (!date) return '';
  const dateObj = typeof date === 'string' ? new Date(date) : date;
  return formatDistanceToNow(dateObj, { addSuffix: true, locale: es });
}

// Formateo de moneda
export function formatCurrency(amount: number | undefined, currency: string = 'EUR'): string {
  if (amount === undefined || amount === null) return '';
  return new Intl.NumberFormat('es-ES', {
    style: 'currency',
    currency,
  }).format(amount);
}

// Formateo de n√∫meros
export function formatNumber(num: number | undefined): string {
  if (num === undefined || num === null) return '';
  return new Intl.NumberFormat('es-ES').format(num);
}

// Obtener iniciales de nombre
export function getInitials(name: string | undefined): string {
  if (!name) return '?';
  return name
    .split(' ')
    .map((n) => n[0])
    .join('')
    .toUpperCase()
    .slice(0, 2);
}

// Status badge colors
export function getStatusColor(status: string): string {
  const statusColors: Record<string, string> = {
    // Deals
    prospect: 'bg-gray-100 text-gray-800',
    lead: 'bg-blue-100 text-blue-800',
    active: 'bg-green-100 text-green-800',
    on_hold: 'bg-yellow-100 text-yellow-800',
    inactive: 'bg-red-100 text-red-800',
    
    // General
    draft: 'bg-gray-100 text-gray-800',
    published: 'bg-green-100 text-green-800',
    archived: 'bg-red-100 text-red-800',
    
    // Tickets
    open: 'bg-blue-100 text-blue-800',
    in_progress: 'bg-yellow-100 text-yellow-800',
    resolved: 'bg-green-100 text-green-800',
    closed: 'bg-gray-100 text-gray-800',
  };

  return statusColors[status] || 'bg-gray-100 text-gray-800';
}

// Priority badge colors
export function getPriorityColor(priority: string): string {
  const priorityColors: Record<string, string> = {
    low: 'bg-gray-100 text-gray-800',
    medium: 'bg-blue-100 text-blue-800',
    high: 'bg-orange-100 text-orange-800',
    urgent: 'bg-red-100 text-red-800',
  };

  return priorityColors[priority] || 'bg-gray-100 text-gray-800';
}

// Truncar texto
export function truncate(text: string | undefined, length: number = 100): string {
  if (!text) return '';
  if (text.length <= length) return text;
  return text.slice(0, length) + '...';
}

// Validar email
export function isValidEmail(email: string): boolean {
  const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return re.test(email);
}

// Sleep para testing
export function sleep(ms: number): Promise<void> {
  return new Promise((resolve) => setTimeout(resolve, ms));
}
</file>

<file path="src/lib/validations/account.ts">
import { z } from 'zod';

export const accountSchema = z.object({
  name: z.string().min(1, 'El nombre es obligatorio'),
  legal_name: z.string().optional(),
  status: z.enum(['prospect', 'lead', 'active', 'on_hold', 'inactive']).optional(),
  website: z.string().url('URL invalida').optional().or(z.literal('')),
  phone: z.string().optional(),
  email: z.string().email('Email invalido').optional().or(z.literal('')),
  tax_id: z.string().optional(),
  address: z.string().optional(),
  city: z.string().optional(),
  zip_code: z.string().optional(),
  notes: z.string().optional(),
  account_owner: z.string().optional(),
  country: z.string().optional(),
});

export type AccountFormValues = z.infer<typeof accountSchema>;
</file>

<file path="src/lib/validations/activity.ts">
import { z } from 'zod';

export const activitySchema = z.object({
  subject: z.string().min(1, 'El asunto es obligatorio'),
  type: z.enum(['call', 'meeting', 'email', 'follow_up', 'note']).optional(),
  description: z.string().optional(),
  owner: z.string().min(1, 'El responsable es obligatorio'),
  scheduled_at: z.string().optional(),
  account: z.string().optional(),
  deal: z.string().optional(),
  contact: z.string().optional(),
  is_completed: z.boolean().optional(),
});

export type ActivityFormValues = z.infer<typeof activitySchema>;
</file>

<file path="src/lib/validations/contact.ts">
import { z } from 'zod';

export const contactSchema = z.object({
  first_name: z.string().min(1, 'El nombre es obligatorio'),
  last_name: z.string().optional(),
  email: z.string().email('Email invalido').min(1, 'El email es obligatorio'),
  phone: z.string().optional(),
  notes: z.string().optional(),
});

export type ContactFormValues = z.infer<typeof contactSchema>;
</file>

<file path="src/lib/validations/deal.ts">
import { z } from 'zod';

export const dealSchema = z.object({
  title: z.string().min(1, 'El titulo es obligatorio'),
  account: z.string().min(1, 'La cuenta es obligatoria'),
  contact: z.string().optional(),
  owner: z.string().optional(),
  stage: z.string().min(1, 'El stage es obligatorio'),
  value_eur: z.number().int().positive().optional().nullable(),
  probability: z.number().int().min(0).max(100).optional().nullable(),
  expected_close_date: z.string().optional(),
  notes: z.string().optional(),
});

export type DealFormValues = z.infer<typeof dealSchema>;
</file>

<file path="src/types/crm.ts">
// Types para m√≥dulo CRM

// ============= ACCOUNTS =============
export interface Account {
  id: string;
  name: string;
  website?: string | null;
  phone?: string | null;
  email?: string | null;
  industry?: string | null;
  employees_count?: number | null;
  annual_revenue?: number | null;
  description?: string | null;
  billing_address?: string | null;
  billing_city?: string | null;
  billing_state?: string | null;
  billing_postal_code?: string | null;
  billing_country?: string | null;
  shipping_address?: string | null;
  shipping_city?: string | null;
  shipping_state?: string | null;
  shipping_postal_code?: string | null;
  shipping_country?: string | null;
  account_owner?: {
    id: string;
    first_name: string;
    last_name: string;
    email: string;
  } | null;
  country?: {
    id: string;
    name: string;
  } | null;
  archived_at?: string | null;
  date_created?: string;
  date_updated?: string;
  user_created?: string;
  user_updated?: string;
}

// ============= CONTACTS =============
export interface Contact {
  id: string;
  first_name: string;
  last_name?: string | null;
  email: string;
  phone?: string | null;
  contact_role?: 'decision_maker' | 'technical' | 'administrative' | 'commercial' | 'other' | null;
  notes?: string | null;
  archived_at?: string | null;
  date_created?: string;
  date_updated?: string;
  user_created?: string;
  user_updated?: string;
}

// ============= DEAL STAGES =============
export interface DealStage {
  id: string;
  key: string;
  label: string;
  sort?: number | null;
  is_won?: boolean;
  is_lost?: boolean;
  is_active?: boolean;
}

// ============= DEALS =============
export interface Deal {
  id: string;
  title: string;
  account: Account | string;
  contact?: Contact | string | null;
  owner?: {
    id: string;
    first_name: string;
    last_name: string;
  } | string | null;
  stage: DealStage | string;
  value_eur?: number | null;
  probability?: number | null;
  expected_close_date?: string | null;
  notes?: string | null;
  archived_at?: string | null;
  date_created?: string;
  date_updated?: string;
  user_created?: string;
  user_updated?: string;
}

// ============= DEAL ITEMS =============
export interface DealItem {
  id: string;
  deal: Deal | string;
  package: {
    id: string;
    name: string;
    base_price?: number | null;
  } | string;
  quantity?: number;
  unit_price?: number;
  notes?: string | null;
  date_created?: string;
  date_updated?: string;
  user_created?: string;
  user_updated?: string;
}

// ============= ACTIVITIES =============
export interface Activity {
  id: string;
  subject: string;
  type?: 'call' | 'meeting' | 'email' | 'follow_up' | 'note' | null;
  description?: string | null;
  scheduled_at?: string | null;
  completed_at?: string | null;
  deal?: string | null;
  account?: string | null;
  contact?: string | null;
  owner: {
    id: string;
    first_name: string;
    last_name: string;
  } | string;
  archived_at?: string | null;
  date_created?: string;
  date_updated?: string;
  user_created?: string;
  user_updated?: string;
}

// ============= TYPES PARA COMPONENTES =============

// Deal con relaciones expandidas (para listas)
export interface DealWithRelations {
  id: string;
  title: string;
  value_eur: number | null;
  probability: number;
  expected_close_date: string | null;
  account: {
    id: string;
    name: string;
  };
  contact?: {
    id: string;
    first_name: string;
    last_name: string;
  } | null;
  owner?: {
    id: string;
    first_name: string;
    last_name: string;
  } | null;
  stage: {
    id: string;
    key: string;
    label: string;
  };
  date_created: string;
}

// Contact con relaciones expandidas
export interface ContactWithRelations extends Contact {
  // Agregar relaciones cuando sea necesario
}

// Account con relaciones expandidas
export interface AccountWithRelations extends Account {
  // Agregar relaciones cuando sea necesario
}
</file>

<file path="src/types/directus.ts">
// Auto-generated Directus Schema Types
// Generated on: 2025-12-21T16:34:56.593Z

export interface DirectusSchema {
  account_members: account_membersItem[];
  account_services: account_servicesItem[];
  accounts: accountsItem[];
  activities: activitiesItem[];
  app_settings: app_settingsItem[];
  chat_channel_members: chat_channel_membersItem[];
  chat_channels: chat_channelsItem[];
  chat_messages: chat_messagesItem[];
  contacts: contactsItem[];
  countries: countriesItem[];
  deal_items: deal_itemsItem[];
  deal_stages: deal_stagesItem[];
  deals: dealsItem[];
  docs_pages: docs_pagesItem[];
  docs_spaces: docs_spacesItem[];
  kb_articles: kb_articlesItem[];
  kb_articles_services: kb_articles_servicesItem[];
  kb_articles_services_1: kb_articles_services_1Item[];
  kb_categories: kb_categoriesItem[];
  milestones: milestonesItem[];
  priorities: prioritiesItem[];
  projects: projectsItem[];
  service_packages: service_packagesItem[];
  services: servicesItem[];
  statuses: statusesItem[];
  task_time_entries: task_time_entriesItem[];
  tasks: tasksItem[];
  team_members: team_membersItem[];
  teams: teamsItem[];
  ticket_categories: ticket_categoriesItem[];
  tickets: ticketsItem[];
  tickets_messages: tickets_messagesItem[];
}

export interface account_membersItem {
  id: string;
  account: accountsItem | string;
  user?: directus_usersItem | string | null;
  is_primary?: boolean | null;
  archived_at?: any | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
  job_title?: string | null;
  contact?: contactsItem | string | null;
  role_in_portal?: string | null;
}

export interface account_servicesItem {
  id: string;
  status: string;
  user_created?: directus_usersItem | string | null;
  date_created?: string | null;
  user_updated?: directus_usersItem | string | null;
  date_updated?: string | null;
  account: accountsItem | string;
  package: service_packagesItem | string;
  star_date?: string | null;
  end_date?: string | null;
  price?: number | null;
  notes?: string | null;
}

export interface accountsItem {
  id: string;
  name?: string | null;
  status?: string | null;
  email?: string | null;
  phone?: string | null;
  website?: string | null;
  notes?: string | null;
  archived_at?: any | null;
  address?: string | null;
  city?: string | null;
  zip_code?: string | null;
  state?: string | null;
  tax_id?: string | null;
  country?: countriesItem | string | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
  legal_name?: string | null;
  account_owner?: directus_usersItem | string | null;
}

export interface activitiesItem {
  id: string;
  account?: accountsItem | string | null;
  deal?: dealsItem | string | null;
  contact?: contactsItem | string | null;
  owner: directus_usersItem | string;
  type?: string | null;
  subject?: string | null;
  description?: string | null;
  scheduled_at?: any | null;
  completed_at?: any | null;
  archived_at?: any | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
}

export interface app_settingsItem {
  id: string;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
  sort?: number | null;
}

export interface chat_channel_membersItem {
  id: string;
  user_created?: directus_usersItem | string | null;
  date_created?: string | null;
  user_updated?: directus_usersItem | string | null;
  date_updated?: string | null;
  channel?: chat_channelsItem | string | null;
  user?: directus_usersItem | string | null;
  role?: string | null;
  is_muted?: boolean | null;
}

export interface chat_channelsItem {
  id: string;
  user_created?: directus_usersItem | string | null;
  date_created?: string | null;
  user_updated?: directus_usersItem | string | null;
  date_updated?: string | null;
  name: string;
  type: string;
  team?: teamsItem | string | null;
  is_private?: boolean | null;
  is_active?: boolean | null;
}

export interface chat_messagesItem {
  id: string;
  user_created?: directus_usersItem | string | null;
  date_created?: string | null;
  user_updated?: directus_usersItem | string | null;
  date_updated?: string | null;
  channel?: chat_channelsItem | string | null;
  sender?: directus_usersItem | string | null;
  content?: string | null;
  message_type?: string | null;
  reply_to?: chat_messagesItem | string | null;
  is_deleted?: boolean | null;
}

export interface contactsItem {
  id: string;
  first_name?: string | null;
  last_name?: string | null;
  email?: string | null;
  phone?: string | null;
  notes?: string | null;
  archived_at?: any | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
  contact_role?: string | null;
}

export interface countriesItem {
  id: string;
  code?: string | null;
  name?: string | null;
  is_active?: boolean | null;
  sort?: number | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
}

export interface deal_itemsItem {
  id: string;
  user_created?: directus_usersItem | string | null;
  date_created?: string | null;
  user_updated?: directus_usersItem | string | null;
  date_updated?: string | null;
  deal?: dealsItem | string | null;
  package?: service_packagesItem | string | null;
  quantity?: number | null;
  unit_price?: number | null;
  notes?: string | null;
}

export interface deal_stagesItem {
  id: string;
  key?: string | null;
  label?: string | null;
  sort?: number | null;
  is_won?: boolean | null;
  is_lost?: boolean | null;
  is_active?: boolean | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
}

export interface dealsItem {
  id: string;
  account: accountsItem | string;
  contact?: contactsItem | string | null;
  owner?: directus_usersItem | string | null;
  stage: deal_stagesItem | string;
  title?: string | null;
  value_eur?: number | null;
  probability?: number | null;
  expected_close_date?: string | null;
  notes?: string | null;
  archived_at?: any | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
}

export interface docs_pagesItem {
  id: string;
  space: docs_spacesItem | string;
  parent_page?: docs_pagesItem | string | null;
  status: string;
  slug?: string | null;
  body?: string | null;
  archived_at?: any | null;
  title?: string | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
  sort?: number | null;
}

export interface docs_spacesItem {
  id: string;
  team?: teamsItem | string | null;
  key?: string | null;
  name?: string | null;
  visibility?: string | null;
  sort?: number | null;
  is_active?: boolean | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
  status?: string | null;
}

export interface kb_articlesItem {
  id: string;
  category?: kb_categoriesItem | string | null;
  account?: accountsItem | string | null;
  status: string;
  slug?: string | null;
  title?: string | null;
  body?: string | null;
  published_at?: any | null;
  archived_at?: any | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
  sort?: number | null;
  services: any;
}

export interface kb_articles_servicesItem {
  id: number;
  kb_articles_id?: kb_articlesItem | string | null;
  services_id?: servicesItem | string | null;
}

export interface kb_articles_services_1Item {
  id: number;
  kb_articles_id?: kb_articlesItem | string | null;
  services_id?: servicesItem | string | null;
}

export interface kb_categoriesItem {
  id: string;
  key?: string | null;
  label?: string | null;
  sort?: number | null;
  is_active?: boolean | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
  status: string;
}

export interface milestonesItem {
  id: string;
  project: projectsItem | string;
  status: statusesItem | string;
  name?: string | null;
  description?: string | null;
  due_date?: string | null;
  sort?: number | null;
  archived_at?: any | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
}

export interface prioritiesItem {
  id: string;
  key?: string | null;
  label?: string | null;
  scope?: string | null;
  sort?: number | null;
  is_active?: boolean | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
}

export interface projectsItem {
  id: string;
  account?: accountsItem | string | null;
  owner?: directus_usersItem | string | null;
  status: statusesItem | string;
  name?: string | null;
  description?: string | null;
  start_date?: string | null;
  end_date?: string | null;
  archived_at?: any | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
  package?: service_packagesItem | string | null;
}

export interface service_packagesItem {
  id: string;
  sort?: number | null;
  user_created?: directus_usersItem | string | null;
  date_created?: string | null;
  user_updated?: directus_usersItem | string | null;
  date_updated?: string | null;
  service?: servicesItem | string | null;
  name?: string | null;
  code: string;
  description?: string | null;
  base_price?: number | null;
  billing_model?: string | null;
  is_active?: boolean | null;
}

export interface servicesItem {
  id: string;
  sort?: number | null;
  user_created?: directus_usersItem | string | null;
  date_created?: string | null;
  user_updated?: directus_usersItem | string | null;
  date_updated?: string | null;
  name: string;
  slug: string;
  description?: string | null;
  is_active?: boolean | null;
}

export interface statusesItem {
  id: string;
  key?: string | null;
  label?: string | null;
  scope?: string | null;
  sort?: number | null;
  is_final?: boolean | null;
  is_active?: boolean | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
}

export interface task_time_entriesItem {
  id: string;
  task: tasksItem | string;
  user: directus_usersItem | string;
  date?: string | null;
  minutes?: number | null;
  notes?: string | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
}

export interface tasksItem {
  id: string;
  project: projectsItem | string;
  status: statusesItem | string;
  priority: prioritiesItem | string;
  assignee?: directus_usersItem | string | null;
  owner?: directus_usersItem | string | null;
  parent_task?: tasksItem | string | null;
  title?: string | null;
  description?: string | null;
  due_date?: string | null;
  estimated_minutes?: number | null;
  archived_at?: any | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
}

export interface team_membersItem {
  id: string;
  team: teamsItem | string;
  user: directus_usersItem | string;
  role?: string | null;
  archived_at?: any | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
}

export interface teamsItem {
  id: string;
  key?: string | null;
  name?: string | null;
  is_active?: boolean | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
  sort?: number | null;
}

export interface ticket_categoriesItem {
  id: string;
  key?: string | null;
  label?: string | null;
  sort?: number | null;
  is_active?: boolean | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
}

export interface ticketsItem {
  id: string;
  account?: accountsItem | string | null;
  assigned_to?: directus_usersItem | string | null;
  status: statusesItem | string;
  priority: prioritiesItem | string;
  category?: ticket_categoriesItem | string | null;
  subject?: string | null;
  description?: string | null;
  channel?: string | null;
  first_response_at?: any | null;
  resolved_at?: any | null;
  last_customer_reply_at?: any | null;
  last_agent_reply_at?: any | null;
  archived_at?: any | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
  requester_contact?: contactsItem | string | null;
  package?: service_packagesItem | string | null;
  attachments?: directus_filesItem | string | null;
}

export interface tickets_messagesItem {
  id: string;
  ticket: ticketsItem | string;
  author?: directus_usersItem | string | null;
  body?: string | null;
  is_internal?: boolean | null;
  source?: string | null;
  archived_at?: any | null;
  date_created?: string | null;
  date_updated?: string | null;
  user_created?: directus_usersItem | string | null;
  user_updated?: directus_usersItem | string | null;
}

// Directus System Types
export interface directus_usersItem {
  id: string;
  first_name?: string | null;
  last_name?: string | null;
  email?: string | null;
  password?: string | null;
  location?: string | null;
  title?: string | null;
  description?: string | null;
  tags?: any | null;
  avatar?: string | null;
  language?: string | null;
  theme?: string | null;
  tfa_secret?: string | null;
  status?: string | null;
  role?: string | null;
  token?: string | null;
  last_access?: string | null;
  last_page?: string | null;
}

export interface directus_filesItem {
  id: string;
  storage: string;
  filename_disk?: string | null;
  filename_download: string;
  title?: string | null;
  type?: string | null;
  folder?: string | null;
  uploaded_by?: string | null;
  uploaded_on: string;
  modified_by?: string | null;
  modified_on: string;
  charset?: string | null;
  filesize?: number | null;
  width?: number | null;
  height?: number | null;
  duration?: number | null;
  embed?: string | null;
  description?: string | null;
  location?: string | null;
  tags?: any | null;
  metadata?: any | null;
}
</file>

<file path="src/types/next-auth.d.ts">
import 'next-auth';

declare module 'next-auth' {
  interface User {
    id: string;
    email: string;
    name?: string;
    image?: string | null;
    role?: string | null;
    accessToken?: string;
  }

  interface Session {
    user: {
      id: string;
      email: string;
      name?: string;
      image?: string | null;
      role?: string;
    };
    accessToken?: string;
  }
}

declare module 'next-auth/jwt' {
  interface JWT {
    id?: string;
    role?: string;
    accessToken?: string;
  }
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./src/*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
</file>

<file path="src/app/(dashboard)/dashboard/crm/deals/[id]/page.tsx">
import { directusServer } from '@/lib/directus';
import { readItem, readItems, readUsers } from '@directus/sdk';
import { notFound } from 'next/navigation';
import { auth } from '@/lib/auth';
import DealHeader from '@/components/crm/deal-header';
import DealTabs from '@/components/crm/deal-tabs';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';
import Link from 'next/link';

interface DealDetailPageProps {
  params: Promise<{
    id: string;
  }>;
}

export default async function DealDetailPage({ params }: DealDetailPageProps) {
  const { id } = await params;
  const session = await auth();

  if (!session?.user?.id) {
    notFound();
  }

  try {
    const deal = await directusServer.request(
      readItem('deals', id, {
        fields: [
          '*',
          'account.id',
          'account.name',
          'account.website',
          'account.phone',
          'account.email',
          'contact.id',
          'contact.first_name',
          'contact.last_name',
          'contact.email',
          'contact.phone',
          'owner.id',
          'owner.first_name',
          'owner.last_name',
          'owner.email',
          'stage.id',
          'stage.key',
          'stage.label',
        ],
      })
    );

    const dealItems = await directusServer.request(
      readItems('deal_items', {
        filter: {
          deal: {
            _eq: id,
          },
        },
        fields: [
          '*',
          'package.id',
          'package.name',
          'package.base_price',
        ],
      })
    );

    // ACTUALIZADO: Filtrar activities por el campo "deal" correcto
    const activities = await directusServer.request(
      readItems('activities', {
        filter: {
          deal: {
            _eq: id,
          },
        },
        fields: [
          '*',
          'owner.id',
          'owner.first_name',
          'owner.last_name',
        ],
        sort: ['-date_created'],
        limit: 100,
      })
    );

    // Obtener service packages para el selector
    const servicePackages = await directusServer.request(
      readItems('service_packages', {
        fields: ['id', 'name', 'base_price'],
        sort: ['name'],
      })
    );

    const users = await directusServer.request(
      readUsers({
        fields: ['id', 'first_name', 'last_name'],
        filter: {
          status: {
            _eq: 'active',
          },
        },
      })
    );

    return (
      <div className="space-y-6">
        <Button variant="ghost" size="sm" asChild>
          <Link href="/dashboard/crm/deals">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Volver a Deals
          </Link>
        </Button>

        <DealHeader deal={deal as any} />

        <DealTabs
          deal={deal as any}
          dealItems={dealItems as any}
          activities={activities as any}
          servicePackages={servicePackages as any}
          users={users as any}
          currentUserId={session.user.id}
        />
      </div>
    );
  } catch (error) {
    console.error('Error loading deal:', error);
    notFound();
  }
}
</file>

<file path="src/components/crm/deal-tabs.tsx">
'use client';

import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { formatDistanceToNow } from 'date-fns';
import { es } from 'date-fns/locale';
import { Phone, Users, Mail, Bell, FileText } from 'lucide-react';
import DealItemsManager from './deal-items-manager';
import DealActivitiesManager from './deal-activities-manager';

interface DealItem {
  id: string;
  package: {
    id: string;
    name: string;
  };
  quantity: number;
  unit_price: number | null;
  notes?: string | null;
}

interface ServicePackage {
  id: string;
  name: string;
  base_price: number | null;
}

interface Activity {
  id: string;
  type: string | null;
  subject: string;
  description?: string | null;
  scheduled_at?: string | null;
  completed_at?: string | null;
  owner?: {
    id: string;
    first_name: string;
    last_name: string;
  } | null;
  date_created: string;
}

interface Deal {
  id: string;
  title: string;
  notes?: string | null;
  date_created: string;
  date_updated?: string | null;
}

interface Props {
  deal: Deal;
  dealItems: DealItem[];
  activities: Activity[];
  servicePackages: ServicePackage[];
  users: User[];
  currentUserId: string;
}

interface User {
  id: string;
  first_name: string;
  last_name: string;
}

export default function DealTabs({ deal, dealItems, activities, servicePackages, users, currentUserId }: Props) {

  return (
    <Tabs defaultValue="details" className="space-y-4">
      <TabsList>
        <TabsTrigger value="details">Detalles</TabsTrigger>
        <TabsTrigger value="items">
          Servicios y Productos
          {dealItems.length > 0 && (
            <Badge variant="secondary" className="ml-2">
              {dealItems.length}
            </Badge>
          )}
        </TabsTrigger>
        <TabsTrigger value="activities">
          Actividades
          {activities.length > 0 && (
            <Badge variant="secondary" className="ml-2">
              {activities.length}
            </Badge>
          )}
        </TabsTrigger>
        <TabsTrigger value="notes">Notas</TabsTrigger>
      </TabsList>

      {/* Tab: Detalles */}
      <TabsContent value="details">
        <Card>
          <CardHeader>
            <CardTitle>Informacion del Deal</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid gap-4 md:grid-cols-2">
              <div>
                <label className="text-sm font-medium text-muted-foreground">
                  Fecha de creacion
                </label>
                <p className="mt-1">
                  {new Date(deal.date_created).toLocaleDateString('es-ES', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                  })}
                </p>
              </div>
              {deal.date_updated && (
                <div>
                  <label className="text-sm font-medium text-muted-foreground">
                    Ultima actualizacion
                  </label>
                  <p className="mt-1">
                    {formatDistanceToNow(new Date(deal.date_updated), {
                      addSuffix: true,
                      locale: es,
                    })}
                  </p>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      </TabsContent>

      {/* Tab: Items */}
      <TabsContent value="items">
        <DealItemsManager 
          dealId={deal.id}
          dealItems={dealItems}
          servicePackages={servicePackages}
        />
      </TabsContent>

      {/* Tab: Actividades */}
      <TabsContent value="activities">
        <DealActivitiesManager 
          dealId={deal.id}
          activities={activities}
          users={users}
          currentUserId={currentUserId}
        />
      </TabsContent>

      {/* Tab: Notas */}
      <TabsContent value="notes">
        <Card>
          <CardHeader>
            <CardTitle>Notas</CardTitle>
          </CardHeader>
          <CardContent>
            {deal.notes ? (
              <div className="prose prose-sm max-w-none">
                <p className="whitespace-pre-wrap">{deal.notes}</p>
              </div>
            ) : (
              <div className="text-center py-8 text-muted-foreground">
                No hay notas para este deal
              </div>
            )}
          </CardContent>
        </Card>
      </TabsContent>
    </Tabs>
  );
}
</file>

</files>
